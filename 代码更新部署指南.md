# ğŸ”„ ä»£ç æ›´æ–°éƒ¨ç½²æŒ‡å—

> å½“ä½ çš„ Git ä»“åº“ä»£ç æœ‰æ›´æ–°æ—¶ï¼Œå¦‚ä½•åŒæ­¥åˆ°çº¿ä¸ŠæœåŠ¡å™¨

---

## ğŸ“‹ ä¸‰ç§æ›´æ–°æ–¹å¼

### æ–¹æ³• 1: ä½¿ç”¨æ›´æ–°è„šæœ¬ï¼ˆæ¨è â­ï¼‰

- âœ… æœ€ç®€å•ï¼Œä¸€æ¡å‘½ä»¤æå®š
- âœ… è‡ªåŠ¨å¤‡ä»½æ—§ç‰ˆæœ¬
- âœ… å‡ºé—®é¢˜å¯ä»¥å›æ»š

### æ–¹æ³• 2: GitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼ˆæœ€æ–¹ä¾¿ â­â­â­ï¼‰

- âœ… å®Œå…¨è‡ªåŠ¨åŒ–
- âœ… æœ¬åœ°æ¨é€ä»£ç ï¼ŒæœåŠ¡å™¨è‡ªåŠ¨æ›´æ–°
- âœ… ä¸éœ€è¦ç™»å½•æœåŠ¡å™¨

### æ–¹æ³• 3: æ‰‹åŠ¨æ›´æ–°ï¼ˆæœ€åŸºç¡€ï¼‰

- âœ… é€‚åˆå­¦ä¹ ç†è§£æµç¨‹
- âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸€æ­¥

---

## ğŸš€ æ–¹æ³• 1: ä½¿ç”¨æ›´æ–°è„šæœ¬ï¼ˆæ¨èï¼‰

### æ­¥éª¤ï¼š

1. **SSH ç™»å½•æœåŠ¡å™¨**

   ```bash
   ssh root@42.193.227.185
   ```

2. **è¿è¡Œæ›´æ–°è„šæœ¬**

   ```bash
   cd /www/wwwroot/my-next-app
   bash scripts/update-deploy.sh
   ```

3. **å®Œæˆï¼**

### è„šæœ¬ä¼šè‡ªåŠ¨åšä»€ä¹ˆï¼š

```
âœ… å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ° ../backups/backup-20250110-143000/
âœ… æ‹‰å–æœ€æ–°ä»£ç  (git pull)
âœ… æ›´æ–°ä¾èµ– (npm ci --production)
âœ… è¯¢é—®æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®åº“
âœ… ç”Ÿæˆ Prisma Client
âœ… é‡æ–°æ„å»ºé¡¹ç›® (npm run build)
âœ… é‡å¯åº”ç”¨ (pm2 restart)
```

### å¦‚æœæ›´æ–°å¤±è´¥æƒ³å›æ»šï¼š

```bash
# è„šæœ¬ä¼šæç¤ºå¤‡ä»½ä½ç½®ï¼Œä¾‹å¦‚ï¼š
# å¤‡ä»½å®Œæˆ: ../backups/backup-20250110-143000

# å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
cp -r ../backups/backup-20250110-143000/* /www/wwwroot/my-next-app/
pm2 restart spring-lament-blog
```

---

## ğŸ¤– æ–¹æ³• 2: GitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼ˆæœ€æ–¹ä¾¿ï¼‰

### å‰ææ¡ä»¶ï¼š

å·²é…ç½®å¥½ GitHub Secretsï¼ˆ7 ä¸ªå¯†é’¥ï¼‰

### ä½¿ç”¨æ–¹æ³•ï¼š

#### 1. åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç 

```bash
# åœ¨ä½ çš„æœ¬åœ°ç”µè„‘
cd /path/to/spring-lament-blog

# ä¿®æ”¹ä»£ç ...
# ç¼–è¾‘æ–‡ä»¶ã€æ·»åŠ åŠŸèƒ½ç­‰

# æäº¤ä»£ç 
git add .
git commit -m "æ·»åŠ äº†æ–°åŠŸèƒ½"
```

#### 2. æ¨é€åˆ° GitHub

```bash
git push origin main
```

#### 3. è‡ªåŠ¨éƒ¨ç½²å¼€å§‹ï¼

æ¨é€åï¼ŒGitHub Actions ä¼šè‡ªåŠ¨ï¼š

```
1. âœ… æ£€å‡ºä»£ç 
2. âœ… å®‰è£…ä¾èµ–
3. âœ… ç”Ÿæˆ Prisma Client
4. âœ… æ„å»ºé¡¹ç›®
5. âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
6. âœ… åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œæ•°æ®åº“è¿ç§»
7. âœ… é‡å¯åº”ç”¨
```

#### 4. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

- æ‰“å¼€ GitHub ä»“åº“é¡µé¢
- ç‚¹å‡» **Actions** æ ‡ç­¾
- æŸ¥çœ‹æœ€æ–°çš„å·¥ä½œæµè¿è¡ŒçŠ¶æ€

**ç»¿è‰²âœ…** = éƒ¨ç½²æˆåŠŸ  
**çº¢è‰²âŒ** = éƒ¨ç½²å¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹é”™è¯¯æ—¥å¿—

#### 5. éªŒè¯éƒ¨ç½²

```bash
# æ–¹æ³• A: ç›´æ¥è®¿é—®ç½‘ç«™
æ‰“å¼€æµè§ˆå™¨è®¿é—® http://powder.icu

# æ–¹æ³• B: SSH ç™»å½•æœåŠ¡å™¨æ£€æŸ¥
ssh root@42.193.227.185
pm2 logs spring-lament-blog --lines 50
```

### ä¼˜åŠ¿ï¼š

- ğŸš€ **å®Œå…¨è‡ªåŠ¨åŒ–** - æ¨é€ä»£ç å³éƒ¨ç½²
- ğŸ”„ **æŒç»­éƒ¨ç½²** - æ¯æ¬¡æ¨é€éƒ½è‡ªåŠ¨æ›´æ–°
- ğŸ“Š **å¯è§†åŒ–æ—¥å¿—** - GitHub ä¸ŠæŸ¥çœ‹éƒ¨ç½²è¿‡ç¨‹
- â±ï¸ **èŠ‚çœæ—¶é—´** - ä¸éœ€è¦æ‰‹åŠ¨ç™»å½•æœåŠ¡å™¨

### æ³¨æ„äº‹é¡¹ï¼š

âš ï¸ **åªæœ‰æ¨é€åˆ° `main` åˆ†æ”¯æ‰ä¼šè§¦å‘éƒ¨ç½²**

å¦‚æœä½ åœ¨å…¶ä»–åˆ†æ”¯å¼€å‘ï¼š

```bash
# å…ˆåˆ‡æ¢åˆ° main åˆ†æ”¯
git checkout main

# åˆå¹¶ä½ çš„å¼€å‘åˆ†æ”¯
git merge your-feature-branch

# æ¨é€ main åˆ†æ”¯
git push origin main
```

---

## ğŸ”§ æ–¹æ³• 3: æ‰‹åŠ¨æ›´æ–°ï¼ˆå®Œå…¨æ‰‹åŠ¨ï¼‰

### é€‚ç”¨åœºæ™¯ï¼š

- å­¦ä¹ ç†è§£éƒ¨ç½²æµç¨‹
- éœ€è¦ç²¾ç¡®æ§åˆ¶æ¯ä¸€æ­¥
- è‡ªåŠ¨è„šæœ¬å‡ºé—®é¢˜æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

### å®Œæ•´æ­¥éª¤ï¼š

#### 1. SSH ç™»å½•æœåŠ¡å™¨

```bash
ssh root@42.193.227.185
```

#### 2. è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /www/wwwroot/my-next-app
```

#### 3. æ‹‰å–æœ€æ–°ä»£ç 

```bash
git pull origin main
```

**å¦‚æœæç¤ºæœ‰æœ¬åœ°ä¿®æ”¹å†²çªï¼š**

```bash
# æŸ¥çœ‹ä¿®æ”¹äº†ä»€ä¹ˆ
git status

# å¦‚æœç¡®å®šè¦æ”¾å¼ƒæœ¬åœ°ä¿®æ”¹ï¼Œå¼ºåˆ¶æ‹‰å–
git fetch origin
git reset --hard origin/main
```

#### 4. æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ package.json æœ‰å˜åŒ–ï¼‰

```bash
npm ci --production
```

**æˆ–è€…ï¼š**

```bash
npm install --production
```

#### 5. ç”Ÿæˆ Prisma Clientï¼ˆå¦‚æœæ•°æ®åº“æ¨¡å‹æœ‰å˜åŒ–ï¼‰

```bash
npm run db:generate
```

#### 6. æ›´æ–°æ•°æ®åº“ç»“æ„ï¼ˆå¦‚æœ schema.prisma æœ‰å˜åŒ–ï¼‰

```bash
npm run db:push
```

**âš ï¸ æ³¨æ„ï¼š** è¿™ä¼šä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼Œç¡®ä¿å·²å¤‡ä»½æ•°æ®åº“ï¼

#### 7. é‡æ–°æ„å»ºé¡¹ç›®

```bash
npm run build
```

è¿™ä¸€æ­¥å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚

#### 8. é‡å¯åº”ç”¨

```bash
pm2 restart spring-lament-blog
```

#### 9. éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤æ— é”™è¯¯
pm2 logs spring-lament-blog --lines 50

# æµ‹è¯•è®¿é—®
curl http://localhost:80
```

#### 10. æµè§ˆå™¨æµ‹è¯•

æ‰“å¼€ http://powder.icu ç¡®è®¤æ›´æ–°å·²ç”Ÿæ•ˆã€‚

---

## ğŸ“Š ä¸‰ç§æ–¹æ³•å¯¹æ¯”

| ç‰¹æ€§               | æ›´æ–°è„šæœ¬    | GitHub Actions | æ‰‹åŠ¨æ›´æ–°    |
| ------------------ | ----------- | -------------- | ----------- |
| **éš¾åº¦**           | â­ ç®€å•     | â­â­ ä¸­ç­‰      | â­â­â­ å¤æ‚ |
| **é€Ÿåº¦**           | ğŸš€ å¿«       | ğŸš€ğŸš€ è¾ƒå¿«      | ğŸŒ æ…¢       |
| **è‡ªåŠ¨åŒ–**         | âšª åŠè‡ªåŠ¨   | âœ… å…¨è‡ªåŠ¨      | âŒ æ‰‹åŠ¨     |
| **éœ€è¦ç™»å½•æœåŠ¡å™¨** | âœ… æ˜¯       | âŒ å¦          | âœ… æ˜¯       |
| **å¤‡ä»½åŠŸèƒ½**       | âœ… è‡ªåŠ¨å¤‡ä»½ | âŒ æ—           | âŒ æ—        |
| **æ¨èæŒ‡æ•°**       | â­â­â­â­    | â­â­â­â­â­     | â­â­        |

---

## ğŸ’¡ æ¨èçš„å·¥ä½œæµç¨‹

### æ—¥å¸¸å¼€å‘ï¼š

```bash
# 1. æœ¬åœ°å¼€å‘å’Œæµ‹è¯•
git checkout -b feature-new-function
# ä¿®æ”¹ä»£ç ...
npm run dev  # æœ¬åœ°æµ‹è¯•

# 2. æäº¤åˆ°åŠŸèƒ½åˆ†æ”¯
git add .
git commit -m "å®ç°æ–°åŠŸèƒ½"
git push origin feature-new-function

# 3. åœ¨ GitHub åˆ›å»º Pull Request å®¡æŸ¥ä»£ç 

# 4. å®¡æŸ¥é€šè¿‡ååˆå¹¶åˆ° main
git checkout main
git merge feature-new-function
git push origin main

# 5. GitHub Actions è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ ğŸ‰
```

### ç´§æ€¥ä¿®å¤ï¼š

```bash
# 1. ç›´æ¥åœ¨ main åˆ†æ”¯ä¿®æ”¹
git checkout main
# ä¿®å¤ bug...

# 2. æäº¤å¹¶æ¨é€
git add .
git commit -m "ä¿®å¤ç´§æ€¥ bug"
git push origin main

# 3. è‡ªåŠ¨éƒ¨ç½²

# 4. å¦‚æœæ¥ä¸åŠç­‰è‡ªåŠ¨éƒ¨ç½²ï¼Œæ‰‹åŠ¨æ›´æ–°ï¼š
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
bash scripts/update-deploy.sh
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: git pull æç¤ºå†²çªæ€ä¹ˆåŠï¼Ÿ

```bash
# æŸ¥çœ‹å†²çªæ–‡ä»¶
git status

# æ–¹æ¡ˆ A: æ”¾å¼ƒæœ¬åœ°ä¿®æ”¹ï¼ˆæ¨èï¼‰
git fetch origin
git reset --hard origin/main

# æ–¹æ¡ˆ B: æš‚å­˜æœ¬åœ°ä¿®æ”¹
git stash
git pull
git stash pop  # æ¢å¤æœ¬åœ°ä¿®æ”¹
```

### Q2: npm install æˆ– npm run build å¤±è´¥

```bash
# æ¸…ç†ç¼“å­˜é‡æ–°å®‰è£…
rm -rf node_modules .next
npm cache clean --force
npm install --production
npm run build
```

### Q3: pm2 restart ååº”ç”¨æ²¡æœ‰æ›´æ–°

```bash
# å®Œå…¨åˆ é™¤åº”ç”¨é‡æ–°å¯åŠ¨
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save
```

### Q4: æ•°æ®åº“æ›´æ–°åå‡ºé”™

```bash
# æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
npm run db:push

# å¦‚æœéœ€è¦é‡ç½®æ•°æ®åº“ï¼ˆâš ï¸ ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
# å…ˆå¤‡ä»½ï¼
pg_dump -U blog_user spring_lament_blog > backup.sql

# é‡ç½®
npm run db:push --force-reset

# æ¢å¤æ•°æ®
psql -U blog_user spring_lament_blog < backup.sql
```

### Q5: GitHub Actions éƒ¨ç½²å¤±è´¥

1. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**
   - GitHub ä»“åº“ â†’ Actions â†’ ç‚¹å‡»å¤±è´¥çš„å·¥ä½œæµ
   - æŸ¥çœ‹å…·ä½“å“ªä¸€æ­¥å¤±è´¥

2. **å¸¸è§åŸå› ï¼š**
   - âŒ Secrets é…ç½®é”™è¯¯ â†’ æ£€æŸ¥ GitHub Secrets
   - âŒ SSH è¿æ¥å¤±è´¥ â†’ æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿
   - âŒ æ„å»ºå¤±è´¥ â†’ æœ¬åœ°å…ˆæµ‹è¯• `npm run build`
   - âŒ æƒé™é—®é¢˜ â†’ æ£€æŸ¥ SSH å¯†é’¥é…ç½®

3. **æ‰‹åŠ¨é‡è¯•**
   - GitHub Actions é¡µé¢ â†’ Re-run jobs

---

## ğŸ“ æ›´æ–°æ£€æŸ¥æ¸…å•

æ¯æ¬¡æ›´æ–°ä»£ç åï¼Œå»ºè®®æ£€æŸ¥ï¼š

- [ ] ä»£ç å·²æˆåŠŸæ‹‰å–/æ¨é€
- [ ] ä¾èµ–å·²æ›´æ–°ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
- [ ] æ•°æ®åº“å·²è¿ç§»ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
- [ ] é¡¹ç›®å·²é‡æ–°æ„å»º
- [ ] åº”ç”¨å·²é‡å¯
- [ ] PM2 çŠ¶æ€ä¸º online
- [ ] ç½‘ç«™å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] æŸ¥çœ‹æ—¥å¿—æ— é”™è¯¯
- [ ] æ–°åŠŸèƒ½å·¥ä½œæ­£å¸¸

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å°æ­¥æäº¤ï¼Œé¢‘ç¹éƒ¨ç½²

```bash
# å¥½çš„åšæ³• âœ…
git commit -m "æ·»åŠ æ–‡ç« æœç´¢åŠŸèƒ½"
git commit -m "ä¼˜åŒ–æœç´¢æ€§èƒ½"
git commit -m "ä¿®å¤æœç´¢ bug"

# ä¸å¥½çš„åšæ³• âŒ
git commit -m "å®Œæˆæ‰€æœ‰åŠŸèƒ½"  # ä¸€æ¬¡æ”¹åŠ¨å¤ªå¤š
```

### 2. ä½¿ç”¨æœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯

```bash
# å¥½çš„ âœ…
git commit -m "ä¿®å¤ï¼šæ–‡ç« åˆ—è¡¨åˆ†é¡µé”™è¯¯"
git commit -m "æ–°å¢ï¼šæ–‡ç« è¯„è®ºåŠŸèƒ½"
git commit -m "ä¼˜åŒ–ï¼šé¦–é¡µåŠ è½½é€Ÿåº¦"

# ä¸å¥½çš„ âŒ
git commit -m "update"
git commit -m "fix bug"
git commit -m "123"
```

### 3. æ›´æ–°å‰å¤‡ä»½é‡è¦æ•°æ®

```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump -U blog_user spring_lament_blog > backup_$(date +%Y%m%d).sql

# å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
tar -czf uploads_$(date +%Y%m%d).tar.gz public/uploads/
```

### 4. åœ¨ä½å³°æ—¶æ®µæ›´æ–°

- ğŸŒ™ å‡Œæ™¨ 2-5 ç‚¹è®¿é—®é‡æœ€å°‘
- ğŸ“Š ä½¿ç”¨ `pm2 monit` è§‚å¯Ÿè®¿é—®æƒ…å†µ
- âš¡ ç´§æ€¥ä¿®å¤ä¾‹å¤–

### 5. ä½¿ç”¨æ ‡ç­¾æ ‡è®°é‡è¦ç‰ˆæœ¬

```bash
# å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶æ‰“æ ‡ç­¾
git tag -a v1.0.0 -m "ç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬"
git push origin v1.0.0

# æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
git tag -l

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
git checkout v1.0.0
```

---

## ğŸ‰ å¿«é€Ÿå‚è€ƒ

### ä½¿ç”¨è„šæœ¬æ›´æ–°ï¼ˆæ¨èï¼‰

```bash
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
bash scripts/update-deploy.sh
```

### ä½¿ç”¨ GitHub Actionsï¼ˆæœ€æ–¹ä¾¿ï¼‰

```bash
git add .
git commit -m "æ›´æ–°å†…å®¹"
git push origin main
```

### æ‰‹åŠ¨æ›´æ–°

```bash
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
git pull
npm ci --production
npm run build
pm2 restart spring-lament-blog
```

---

**é€‰æ‹©é€‚åˆä½ çš„æ›´æ–°æ–¹å¼ï¼Œä¿æŒä»£ç å’ŒæœåŠ¡å™¨åŒæ­¥ï¼** ğŸš€
