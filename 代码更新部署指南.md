# 🔄 代码更新部署指南

> 当你的 Git 仓库代码有更新时，如何同步到线上服务器

---

## 📋 三种更新方式

### 方法 1: 使用更新脚本（推荐 ⭐）

- ✅ 最简单，一条命令搞定
- ✅ 自动备份旧版本
- ✅ 出问题可以回滚

### 方法 2: GitHub Actions 自动部署（最方便 ⭐⭐⭐）

- ✅ 完全自动化
- ✅ 本地推送代码，服务器自动更新
- ✅ 不需要登录服务器

### 方法 3: 手动更新（最基础）

- ✅ 适合学习理解流程
- ✅ 可以精确控制每一步

---

## 🚀 方法 1: 使用更新脚本（推荐）

### 步骤：

1. **SSH 登录服务器**

   ```bash
   ssh root@42.193.227.185
   ```

2. **运行更新脚本**

   ```bash
   cd /www/wwwroot/my-next-app
   bash scripts/update-deploy.sh
   ```

3. **完成！**

### 脚本会自动做什么：

```
✅ 备份当前版本到 ../backups/backup-20250110-143000/
✅ 拉取最新代码 (git pull)
✅ 更新依赖 (npm ci --production)
✅ 询问是否需要更新数据库
✅ 生成 Prisma Client
✅ 重新构建项目 (npm run build)
✅ 重启应用 (pm2 restart)
```

### 如果更新失败想回滚：

```bash
# 脚本会提示备份位置，例如：
# 备份完成: ../backups/backup-20250110-143000

# 回滚到备份版本
cp -r ../backups/backup-20250110-143000/* /www/wwwroot/my-next-app/
pm2 restart spring-lament-blog
```

---

## 🤖 方法 2: GitHub Actions 自动部署（最方便）

### 前提条件：

已配置好 GitHub Secrets（7 个密钥）

### 使用方法：

#### 1. 在本地修改代码

```bash
# 在你的本地电脑
cd /path/to/spring-lament-blog

# 修改代码...
# 编辑文件、添加功能等

# 提交代码
git add .
git commit -m "添加了新功能"
```

#### 2. 推送到 GitHub

```bash
git push origin main
```

#### 3. 自动部署开始！

推送后，GitHub Actions 会自动：

```
1. ✅ 检出代码
2. ✅ 安装依赖
3. ✅ 生成 Prisma Client
4. ✅ 构建项目
5. ✅ 上传到服务器
6. ✅ 在服务器上运行数据库迁移
7. ✅ 重启应用
```

#### 4. 查看部署状态

- 打开 GitHub 仓库页面
- 点击 **Actions** 标签
- 查看最新的工作流运行状态

**绿色✅** = 部署成功  
**红色❌** = 部署失败，点击查看错误日志

#### 5. 验证部署

```bash
# 方法 A: 直接访问网站
打开浏览器访问 http://powder.icu

# 方法 B: SSH 登录服务器检查
ssh root@42.193.227.185
pm2 logs spring-lament-blog --lines 50
```

### 优势：

- 🚀 **完全自动化** - 推送代码即部署
- 🔄 **持续部署** - 每次推送都自动更新
- 📊 **可视化日志** - GitHub 上查看部署过程
- ⏱️ **节省时间** - 不需要手动登录服务器

### 注意事项：

⚠️ **只有推送到 `main` 分支才会触发部署**

如果你在其他分支开发：

```bash
# 先切换到 main 分支
git checkout main

# 合并你的开发分支
git merge your-feature-branch

# 推送 main 分支
git push origin main
```

---

## 🔧 方法 3: 手动更新（完全手动）

### 适用场景：

- 学习理解部署流程
- 需要精确控制每一步
- 自动脚本出问题时的备用方案

### 完整步骤：

#### 1. SSH 登录服务器

```bash
ssh root@42.193.227.185
```

#### 2. 进入项目目录

```bash
cd /www/wwwroot/my-next-app
```

#### 3. 拉取最新代码

```bash
git pull origin main
```

**如果提示有本地修改冲突：**

```bash
# 查看修改了什么
git status

# 如果确定要放弃本地修改，强制拉取
git fetch origin
git reset --hard origin/main
```

#### 4. 更新依赖（如果 package.json 有变化）

```bash
npm ci --production
```

**或者：**

```bash
npm install --production
```

#### 5. 生成 Prisma Client（如果数据库模型有变化）

```bash
npm run db:generate
```

#### 6. 更新数据库结构（如果 schema.prisma 有变化）

```bash
npm run db:push
```

**⚠️ 注意：** 这会修改数据库结构，确保已备份数据库！

#### 7. 重新构建项目

```bash
npm run build
```

这一步可能需要几分钟，请耐心等待。

#### 8. 重启应用

```bash
pm2 restart spring-lament-blog
```

#### 9. 验证部署

```bash
# 查看应用状态
pm2 status

# 查看日志，确认无错误
pm2 logs spring-lament-blog --lines 50

# 测试访问
curl http://localhost:80
```

#### 10. 浏览器测试

打开 http://powder.icu 确认更新已生效。

---

## 📊 三种方法对比

| 特性               | 更新脚本    | GitHub Actions | 手动更新    |
| ------------------ | ----------- | -------------- | ----------- |
| **难度**           | ⭐ 简单     | ⭐⭐ 中等      | ⭐⭐⭐ 复杂 |
| **速度**           | 🚀 快       | 🚀🚀 较快      | 🐌 慢       |
| **自动化**         | ⚪ 半自动   | ✅ 全自动      | ❌ 手动     |
| **需要登录服务器** | ✅ 是       | ❌ 否          | ✅ 是       |
| **备份功能**       | ✅ 自动备份 | ❌ 无          | ❌ 无       |
| **推荐指数**       | ⭐⭐⭐⭐    | ⭐⭐⭐⭐⭐     | ⭐⭐        |

---

## 💡 推荐的工作流程

### 日常开发：

```bash
# 1. 本地开发和测试
git checkout -b feature-new-function
# 修改代码...
npm run dev  # 本地测试

# 2. 提交到功能分支
git add .
git commit -m "实现新功能"
git push origin feature-new-function

# 3. 在 GitHub 创建 Pull Request 审查代码

# 4. 审查通过后合并到 main
git checkout main
git merge feature-new-function
git push origin main

# 5. GitHub Actions 自动部署到服务器 🎉
```

### 紧急修复：

```bash
# 1. 直接在 main 分支修改
git checkout main
# 修复 bug...

# 2. 提交并推送
git add .
git commit -m "修复紧急 bug"
git push origin main

# 3. 自动部署

# 4. 如果来不及等自动部署，手动更新：
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
bash scripts/update-deploy.sh
```

---

## 🐛 常见问题

### Q1: git pull 提示冲突怎么办？

```bash
# 查看冲突文件
git status

# 方案 A: 放弃本地修改（推荐）
git fetch origin
git reset --hard origin/main

# 方案 B: 暂存本地修改
git stash
git pull
git stash pop  # 恢复本地修改
```

### Q2: npm install 或 npm run build 失败

```bash
# 清理缓存重新安装
rm -rf node_modules .next
npm cache clean --force
npm install --production
npm run build
```

### Q3: pm2 restart 后应用没有更新

```bash
# 完全删除应用重新启动
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save
```

### Q4: 数据库更新后出错

```bash
# 查看数据库状态
npm run db:push

# 如果需要重置数据库（⚠️ 会删除所有数据）
# 先备份！
pg_dump -U blog_user spring_lament_blog > backup.sql

# 重置
npm run db:push --force-reset

# 恢复数据
psql -U blog_user spring_lament_blog < backup.sql
```

### Q5: GitHub Actions 部署失败

1. **查看错误日志**
   - GitHub 仓库 → Actions → 点击失败的工作流
   - 查看具体哪一步失败

2. **常见原因：**
   - ❌ Secrets 配置错误 → 检查 GitHub Secrets
   - ❌ SSH 连接失败 → 检查服务器是否在线
   - ❌ 构建失败 → 本地先测试 `npm run build`
   - ❌ 权限问题 → 检查 SSH 密钥配置

3. **手动重试**
   - GitHub Actions 页面 → Re-run jobs

---

## 📝 更新检查清单

每次更新代码后，建议检查：

- [ ] 代码已成功拉取/推送
- [ ] 依赖已更新（如果有变化）
- [ ] 数据库已迁移（如果有变化）
- [ ] 项目已重新构建
- [ ] 应用已重启
- [ ] PM2 状态为 online
- [ ] 网站可以正常访问
- [ ] 查看日志无错误
- [ ] 新功能工作正常

---

## 🎯 最佳实践

### 1. 小步提交，频繁部署

```bash
# 好的做法 ✅
git commit -m "添加文章搜索功能"
git commit -m "优化搜索性能"
git commit -m "修复搜索 bug"

# 不好的做法 ❌
git commit -m "完成所有功能"  # 一次改动太多
```

### 2. 使用有意义的提交信息

```bash
# 好的 ✅
git commit -m "修复：文章列表分页错误"
git commit -m "新增：文章评论功能"
git commit -m "优化：首页加载速度"

# 不好的 ❌
git commit -m "update"
git commit -m "fix bug"
git commit -m "123"
```

### 3. 更新前备份重要数据

```bash
# 备份数据库
pg_dump -U blog_user spring_lament_blog > backup_$(date +%Y%m%d).sql

# 备份上传的文件
tar -czf uploads_$(date +%Y%m%d).tar.gz public/uploads/
```

### 4. 在低峰时段更新

- 🌙 凌晨 2-5 点访问量最少
- 📊 使用 `pm2 monit` 观察访问情况
- ⚡ 紧急修复例外

### 5. 使用标签标记重要版本

```bash
# 发布新版本时打标签
git tag -a v1.0.0 -m "第一个正式版本"
git push origin v1.0.0

# 查看所有版本
git tag -l

# 回滚到指定版本
git checkout v1.0.0
```

---

## 🎉 快速参考

### 使用脚本更新（推荐）

```bash
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
bash scripts/update-deploy.sh
```

### 使用 GitHub Actions（最方便）

```bash
git add .
git commit -m "更新内容"
git push origin main
```

### 手动更新

```bash
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
git pull
npm ci --production
npm run build
pm2 restart spring-lament-blog
```

---

**选择适合你的更新方式，保持代码和服务器同步！** 🚀
