# 启动指南 - Spring Broken AI Blog

本文档介绍如何启动 Spring Broken AI Blog 系统,包括基础服务和 AI 服务的配置。

## 📋 目录

- [基础启动](#基础启动) - 仅启动博客系统
- [完整启动](#完整启动) - 包含 AI 功能的完整启动
- [服务检查](#服务检查) - 验证各服务运行状态
- [常见问题](#常见问题) - 问题排查

---

## 基础启动

如果你只需要博客的基础功能(不使用 AI 功能),只需执行以下步骤:

### 1. 安装依赖

```bash
npm install
```

### 2. 配置环境变量

创建 `.env.local` 文件:

```bash
# 数据库配置
DATABASE_URL="file:./prisma/dev.db"

# NextAuth 配置
NEXTAUTH_SECRET="your-secret-key-at-least-32-characters-long"
NEXTAUTH_URL="http://localhost:7777"

# 管理员账户 (seed 时使用)
ADMIN_USERNAME="admin"
ADMIN_PASSWORD="0919"
```

### 3. 初始化数据库

```bash
# 生成 Prisma 客户端
npm run db:generate

# 推送数据库架构
npm run db:push

# 填充初始数据
npm run db:seed
```

### 4. 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:7777 即可使用博客的基础功能。

---

## 完整启动

如需使用 AI 功能(智能写作助手、RAG 聊天等),需要额外安装和配置以下服务:

### 一、安装 Ollama (用于向量生成)

Ollama 用于本地运行 Embedding 模型,生成文本向量。

#### 1. 安装 Ollama

**macOS:**

```bash
brew install ollama
```

**Linux:**

```bash
curl -fsSL https://ollama.com/install.sh | sh
```

**Windows:**
下载安装包: https://ollama.com/download

#### 2. 拉取 Embedding 模型

```bash
ollama pull nomic-embed-text
```

#### 3. 启动 Ollama 服务

```bash
ollama serve
```

服务默认运行在 `http://localhost:11434`

---

### 二、安装 ChromaDB (用于向量存储)

ChromaDB 用于存储和检索文章向量。

#### 方法 1: 使用 Docker (推荐)

```bash
# 使用 Docker 运行 ChromaDB
docker run -d --name chromadb -p 8000:8000 chromadb/chroma:latest

# 查看运行状态
docker ps | grep chromadb
```

#### 方法 2: 使用 Python

```bash
# 安装 ChromaDB
pip install chromadb

# 启动 ChromaDB
chroma run --host localhost --port 8000
```

#### 方法 3: 使用 Node.js

```bash
# 使用 npx 运行 ChromaDB
npx chromadb run --path ./data/chroma --port 8000
```

服务默认运行在 `http://localhost:8000`

---

### 三、配置 AI 环境变量

在 `.env.local` 文件中添加 AI 相关配置:

```bash
# AI 配置
KIMI_API_KEY="your-kimi-api-key"  # 从 https://platform.moonshot.cn/ 获取
KIMI_BASE_URL="https://api.moonshot.cn/v1"
KIMI_MODEL="moonshot-v1-32k"

# Ollama 配置 (用于向量生成)
OLLAMA_BASE_URL="http://localhost:11434"
OLLAMA_EMBEDDING_MODEL="nomic-embed-text"

# ChromaDB 配置 (用于向量存储)
CHROMADB_HOST="localhost"
CHROMADB_PORT="8000"
```

**获取 Kimi API Key:**

1. 访问 [Moonshot AI 开放平台](https://platform.moonshot.cn/)
2. 注册/登录账号
3. 进入 API Keys 页面
4. 创建新的 API Key

---

### 四、完整启动流程

#### 1. 启动 ChromaDB

**新开一个终端窗口:**

```bash
# Docker 方式
docker start chromadb

# 或 Python 方式
chroma run --host localhost --port 8000

# 或 Node.js 方式
npx chromadb run --path ./data/chroma --port 8000
```

#### 2. 启动 Ollama

**再开一个终端窗口:**

```bash
ollama serve
```

#### 3. 启动博客项目

**在原项目目录:**

```bash
npm run dev
```

---

## 服务检查

启动完成后,验证各服务运行状态:

### 检查 Ollama

```bash
curl http://localhost:11434/api/tags
```

**预期输出:**

```json
{
  "models": [
    {
      "name": "nomic-embed-text",
      ...
    }
  ]
}
```

### 检查 ChromaDB

```bash
curl http://localhost:8000/api/v1/heartbeat
```

**预期输出:**

```json
{
  "status": "ok"
}
```

### 检查博客服务

访问 http://localhost:7777,检查:

- ✅ 首页正常加载
- ✅ 可以登录后台 (`/admin`)
- ✅ AI 助手页面可访问 (`/admin` 中的 AI 功能)

---

## 常见问题

### Q1: Ollama 连接失败

**错误信息:** `Failed to connect to localhost:11434`

**解决方案:**

1. 检查 Ollama 是否运行:

   ```bash
   ps aux | grep ollama
   ```

2. 重启 Ollama:

   ```bash
   pkill ollama
   ollama serve
   ```

3. 确认模型已下载:
   ```bash
   ollama list
   ```

---

### Q2: ChromaDB 连接失败

**错误信息:** `ECONNREFUSED localhost:8000`

**解决方案:**

1. **Docker 方式:**

   ```bash
   docker ps | grep chromadb  # 查看运行状态
   docker logs chromadb       # 查看日志
   docker restart chromadb    # 重启服务
   ```

2. **Python/Node 方式:**
   - 确认服务进程是否运行
   - 检查端口 8000 是否被占用: `lsof -i :8000`
   - 重新启动服务

---

### Q3: Kimi API 调用失败

**错误信息:** `请配置 KIMI_API_KEY 环境变量`

**解决方案:**

1. 检查 `.env.local` 文件是否存在 `KIMI_API_KEY`
2. 确认 API Key 有效:
   ```bash
   curl https://api.moonshot.cn/v1/models \
     -H "Authorization: Bearer YOUR_API_KEY"
   ```
3. 重启开发服务器:
   ```bash
   # 停止 (Ctrl+C)
   npm run dev
   ```

---

### Q4: 向量索引失败

**错误信息:** `文章索引失败: 无法连接到向量数据库`

**解决方案:**

1. 确保 ChromaDB 和 Ollama 都在运行
2. 检查环境变量配置:

   ```bash
   # 查看当前环境变量
   echo $CHROMADB_HOST
   echo $OLLAMA_BASE_URL
   ```

3. 测试 Ollama Embedding:
   ```bash
   curl http://localhost:11434/api/embeddings \
     -d '{"model": "nomic-embed-text", "prompt": "测试文本"}'
   ```

---

### Q5: AI 功能不显示

**原因:** 未配置 AI 环境变量或服务未启动

**解决方案:**

1. 确认已配置所有 AI 相关环境变量
2. 确认 ChromaDB 和 Ollama 服务都在运行
3. 检查浏览器控制台错误日志
4. 重启开发服务器

---

## 端口占用问题

如果默认端口被占用,可以修改端口:

### 修改 Ollama 端口

```bash
OLLAMA_HOST=0.0.0.0:11435 ollama serve
```

更新 `.env.local`:

```bash
OLLAMA_BASE_URL="http://localhost:11435"
```

### 修改 ChromaDB 端口

```bash
docker run -d --name chromadb -p 8001:8000 chromadb/chroma:latest
```

更新 `.env.local`:

```bash
CHROMADB_PORT="8001"
```

---

## 开发模式切换

### 仅使用基础功能

如果暂时不需要 AI 功能,可以不启动 ChromaDB 和 Ollama:

```bash
# 只启动博客
npm run dev
```

此时博客会正常工作,但 AI 相关功能会显示服务不可用的提示。

### 启用 AI 功能

启动 ChromaDB 和 Ollama 后,刷新页面,AI 功能自动可用。

---

## 后台运行服务

### macOS/Linux

使用 `nohup` 让服务在后台运行:

```bash
# Ollama
nohup ollama serve > ollama.log 2>&1 &

# ChromaDB (Python)
nohup chroma run --host localhost --port 8000 > chromadb.log 2>&1 &

# 或 Docker
docker run -d --name chromadb -p 8000:8000 chromadb/chroma:latest
```

### 查看日志

```bash
# Ollama 日志
tail -f ollama.log

# ChromaDB 日志
tail -f chromadb.log

# Docker 日志
docker logs -f chromadb
```

### 停止服务

```bash
# Ollama
pkill ollama

# ChromaDB
pkill chroma
# 或
docker stop chromadb
```

---

## 快速启动脚本

创建 `start-all.sh` 脚本:

```bash
#!/bin/bash

echo "🚀 启动所有服务..."

# 启动 ChromaDB (Docker)
echo "📦 启动 ChromaDB..."
docker start chromadb 2>/dev/null || docker run -d --name chromadb -p 8000:8000 chromadb/chroma:latest

# 启动 Ollama
echo "🤖 启动 Ollama..."
pgrep ollama > /dev/null || nohup ollama serve > ollama.log 2>&1 &

# 等待服务启动
echo "⏳ 等待服务启动..."
sleep 5

# 检查服务
echo "✅ 检查服务状态..."
curl -s http://localhost:8000/api/v1/heartbeat > /dev/null && echo "✅ ChromaDB 运行正常" || echo "❌ ChromaDB 启动失败"
curl -s http://localhost:11434/api/tags > /dev/null && echo "✅ Ollama 运行正常" || echo "❌ Ollama 启动失败"

# 启动博客
echo "🌐 启动博客项目..."
npm run dev
```

使用方法:

```bash
chmod +x start-all.sh
./start-all.sh
```

---

## 下一步

启动成功后:

1. **访问博客:** http://localhost:7777
2. **登录后台:** http://localhost:7777/admin
   - 用户名: `admin`
   - 密码: `0919`
3. **测试 AI 功能:**
   - 进入后台管理
   - 打开 AI 写作助手
   - 测试 RAG 聊天功能

---

## 相关文档

- [部署指南](./部署指南.md) - 生产环境部署
- [CLAUDE.md](../CLAUDE.md) - 开发指南
- [AI功能亮点总结](./ai-features/AI功能亮点总结.md) - AI 功能详解
- [README](../README.md) - 项目概览

---

**提示:** 首次使用 AI 功能时,需要先在后台发布几篇文章,然后进行向量索引,才能使用 RAG 聊天功能。
