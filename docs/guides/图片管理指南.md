# 博客图片管理指南（全新版本）

> **重要更新**：图片管理系统已完全重构，采用基于文章 slug 的本地化存储方案。

## 📁 目录结构

```
public/images/posts/
  └── {文章slug}/              # 按文章slug组织，每篇文章独立目录
      ├── cover.jpg            # 封面图（固定文件名）
      ├── image-1.jpg          # 内容配图
      ├── image-2.png
      └── screenshot.png
```

**示例**：

```
public/images/posts/
  ├── how-to-learn-frontend/
  │   ├── cover.jpg
  │   ├── image-1709123456.jpg
  │   └── image-1709234567.png
  ├── react-best-practices/
  │   ├── cover.png
  │   └── image-1709345678.jpg
  └── nextjs-guide/
      └── cover.webp
```

## 🎯 核心特性

- ✅ **以文章为粒度管理**：每篇文章的图片独立存储
- ✅ **拖拽上传**：支持拖拽文件到上传区域
- ✅ **实时预览**：上传前即可预览图片
- ✅ **批量上传**：内容配图支持一次上传多张
- ✅ **快速复制**：一键复制图片 URL 或 Markdown 格式
- ✅ **图片管理**：删除、重命名、预览等完整功能

## 🖼️ 使用后台管理图片

### 1. 进入图片管理页面

登录后台 → 导航栏 → **图片管理**

### 2. 选择文章

- 左侧显示所有文章列表
- 使用搜索框快速查找文章
- 点击文章名称选中

### 3. 上传封面图

1. 在"封面图"区块，点击上传区域或拖拽图片
2. 支持格式：JPG、PNG、WebP、GIF
3. 大小限制：最大 2MB
4. 封面图会自动命名为 `cover.{扩展名}`
5. 替换封面会自动删除旧封面

### 4. 上传内容配图

1. 在"内容配图"区块，上传一张或多张图片
2. 大小限制：每张最大 5MB
3. 文件名会自动生成为 `image-{时间戳}.{扩展名}`

### 5. 使用图片

点击图片卡片的"复制"按钮，有两种格式：

- **复制 URL**：`/images/posts/article-slug/image-1.jpg`
- **复制 Markdown**：`![图片描述](/images/posts/article-slug/image-1.jpg)`

然后在文章编辑器中粘贴即可。

### 6. 管理图片

- **预览**：点击图片查看大图
- **重命名**：点击编辑按钮修改文件名（仅内容配图）
- **删除**：点击删除按钮移除图片

## 💡 在代码中引用图片

### 在 Markdown 中

```markdown
<!-- 封面图（通常通过后台设置，会自动关联） -->

<!-- 内容配图 -->

![架构图](/images/posts/my-article-slug/image-1709123456.jpg)
![流程图](/images/posts/my-article-slug/image-1709234567.png)
```

### 在 React 组件中

```tsx
import Image from "next/image";

<Image
  src="/images/posts/my-article-slug/cover.jpg"
  alt="文章封面"
  width={1200}
  height={630}
/>;
```

## 🔄 命令行管理（高级）

### 查看文章图片目录

```bash
# 查看某篇文章的所有图片
ls public/images/posts/my-article-slug/

# 输出示例：
# cover.jpg
# image-1709123456.jpg
# image-1709234567.png
```

### 手动复制图片

```bash
# 复制图片到文章目录
cp ~/Desktop/my-image.jpg public/images/posts/my-article-slug/

# 注意：手动复制的图片不会自动同步到数据库
# 建议使用后台管理界面上传
```

## 📏 图片规格建议

### 封面图

- **推荐尺寸**: 1200 x 630 px (16:9 比例)
- **最小尺寸**: 800 x 450 px
- **格式**: JPG、PNG、WebP、GIF
- **大小限制**: 最大 2MB
- **建议大小**: < 500KB（优化加载速度）

### 内容配图

- **推荐宽度**: 800 - 1200 px
- **格式**: PNG（图表/截图）、JPG（照片）、WebP（通用）
- **大小限制**: 最大 5MB
- **建议大小**: < 1MB

## 🎨 图片优化建议

### 1. 压缩图片

使用在线工具或本地软件压缩图片：

- **TinyPNG**: https://tinypng.com（在线压缩）
- **ImageOptim**: macOS 本地压缩工具
- **Squoosh**: https://squoosh.app（Google 出品）

### 2. 选择合适格式

- **JPG**: 适合照片，文件小
- **PNG**: 适合截图、图表，支持透明背景
- **WebP**: 现代格式，压缩率高，推荐使用
- **GIF**: 适合简单动画

### 3. 控制尺寸

- 封面图不要超过 1920px 宽
- 内容配图不要超过 1200px 宽
- 移动端会自动缩放，无需单独准备

## 🗄️ 数据库设计

系统使用 `Image` 表存储图片元数据：

```prisma
model Image {
  id       String    @id @default(cuid())
  filename String    // 文件名（含扩展名）
  path     String    // 完整路径
  size     Int       // 文件大小（字节）
  mimeType String    // MIME类型
  type     ImageType // COVER 或 CONTENT
  postId   String    // 关联的文章ID
  post     Post      @relation(...)
}
```

**好处**：

- 图片与文章强关联
- 删除文章时自动删除关联图片
- 支持按类型查询（封面/内容）
- 便于统计和管理

## 🔧 技术架构

### 前端

- **上传组件**: `src/components/admin/image-uploader.tsx`
- **网格组件**: `src/components/admin/image-grid.tsx`
- **管理器**: `src/components/admin/image-manager.tsx`

### 后端 API

- `GET /api/admin/images/[postId]` - 获取文章图片列表
- `POST /api/admin/images/upload` - 上传图片
- `DELETE /api/admin/images/[imageId]` - 删除图片
- `PATCH /api/admin/images/[imageId]` - 重命名图片

### 工具函数

- `src/lib/images/utils.ts` - 文件系统操作
- `src/lib/images/validator.ts` - 图片验证

## ❓ 常见问题

### Q: 如何批量上传图片？

A: 在内容配图区域，一次选择多个文件或拖拽多张图片即可。

### Q: 封面图能重命名吗？

A: 不能。封面图固定命名为 `cover.{扩展名}`，确保统一管理。

### Q: 修改文章 slug 会影响图片吗？

A: 会！图片目录基于 slug，修改 slug 后需要手动迁移图片目录，或重新上传。

### Q: 删除文章会删除图片吗？

A: 会！删除文章时会自动删除数据库记录和文件系统中的图片文件。

### Q: 可以直接在文件系统中添加图片吗？

A: 不推荐。手动添加的图片不会同步到数据库，建议使用后台上传功能。

## 📦 维护建议

### 定期清理

```bash
# 查看图片占用空间
du -sh public/images/posts/

# 查找大文件（超过 1MB）
find public/images/posts/ -type f -size +1M

# 统计图片数量
find public/images/posts/ -type f | wc -l
```

### 备份图片

```bash
# 压缩备份所有图片
tar -czf images-backup-$(date +%Y%m%d).tar.gz public/images/posts/

# 恢复备份
tar -xzf images-backup-20260109.tar.gz
```

### Git 管理

图片文件较大，建议：

1. 小项目：直接提交到 Git（< 10MB）
2. 大项目：使用 Git LFS 或 CDN
3. 生产环境：使用对象存储（如阿里云 OSS）

---

**💡 提示**：首次使用建议先用测试文章熟悉流程，确保理解图片管理逻辑。
