# 基于宝塔面板 + Next.js + Prisma 的博客系统超详细完整部署指南

---

## 📦 服务器环境准备（宝塔面板用户）

> 如果你使用宝塔面板管理服务器，按以下步骤准备环境并登陆宝塔面板
> 在SSH终端输入以下命令来查看面板入口：`/etc/init.d/bt default`

**📋 本章目标：** 在服务器上安装运行 Next.js 博客所需的基础环境（Node.js、PM2、项目目录）

**💡 为什么需要：** Next.js 是基于 Node.js 的框架，必须先安装 Node.js 才能运行；PM2 用于管理应用进程，确保应用稳定运行和自动重启

---

### 1. 安装 Node 版本管理器

**📋 本步骤目标：** 安装 Node.js 运行环境

**💡 为什么需要：** Next.js 是基于 Node.js 的 Web 框架，没有 Node.js 就无法运行博客应用。使用版本管理器可以方便地安装和切换不同版本的 Node.js

**步骤 1：安装 Node 版本管理器插件**

1. 登录宝塔面板
2. 点击左侧菜单 → **软件商店**
3. 搜索 "**Node 版本管理器**" 或 "**Node.js 版本管理器**"
4. 点击 **安装** 按钮

![宝塔面板安装Node版本管理器](https://www.zhiboblog.com/wp-content/uploads/2025/01/1.png)

**步骤 2：打开 Node 版本管理器**

安装完成后，在左侧菜单中找到 "**软件商店**" → 找到已安装的 "**Node 版本管理器**" → 点击 **设置** 打开

![打开Node版本管理器](https://www.zhiboblog.com/wp-content/uploads/2025/01/2.png)

**步骤 3：更新版本列表**

1. 在 Node 版本管理器界面
2. 点击 **更新版本列表** 按钮
3. 等待版本列表更新完成

![更新版本列表](https://www.zhiboblog.com/wp-content/uploads/2025/01/3.png)

**步骤 4：安装 Node.js**

1. 在版本列表中选择最新的稳定版（推荐 v20.x.x 或 v22.x.x）
2. 点击该版本右侧的 **安装** 按钮
3. 等待安装完成

![安装Node.js](https://www.zhiboblog.com/wp-content/uploads/2025/01/4.png)

**步骤 5：设置命令行版本**

1. 安装完成后，在已安装版本列表中
2. 找到刚安装的版本
3. 点击 **设置命令行版本** 或 **设为默认**
4. 这样在 SSH 终端中就可以直接使用 node 和 npm 命令了

![设置命令行版本](https://www.zhiboblog.com/wp-content/uploads/2025/01/5.png)

**验证安装**：

```bash
# SSH 登录服务器后
node -v   # 应显示 v20.x.x
npm -v    # 应显示对应的 npm 版本
```

### 2. 安装 PM2（进程管理器）

**📋 本步骤目标：** 安装 PM2 进程管理工具

**💡 为什么需要：** PM2 可以让 Next.js 应用在后台持续运行，自动重启崩溃的进程，并在服务器重启后自动启动应用。如果直接用 `npm start` 运行，一旦关闭 SSH 连接，应用就会停止

打开服务器命令行安装：

```bash
npm install -g pm2
pm2 -v  # 验证安装
```

### 3. 创建项目目录

**📋 本步骤目标：** 在服务器上创建存放博客代码的文件夹

**💡 为什么需要：** 需要一个专门的目录来存放项目代码、依赖包和构建产物，便于管理和维护

**方法一：通过宝塔面板**

1. 点击宝塔面板左侧菜单 → **文件**
2. 在文件管理器中，进入 `/www/wwwroot/` 目录
3. 点击顶部的 **新建文件夹** 按钮

![宝塔面板文件管理](https://www.zhiboblog.com/wp-content/uploads/2025/01/6.png)

4. 输入文件夹名称：`my-next-app`（或你喜欢的名称）
5. 设置权限为 `755`
6. 点击确定

![新建项目文件夹](https://www.zhiboblog.com/wp-content/uploads/2025/01/7.png)

**方法二：通过命令行**

```bash
mkdir -p /www/wwwroot/my-next-app
cd /www/wwwroot/my-next-app
```

---

## 🔑 GitHub 仓库和 SSH 配置

**📋 本章目标：** 使用 GitHub 管理代码，配置服务器与 GitHub 的 SSH 连接

**💡 为什么需要：** GitHub 用于版本控制和代码托管，可以方便地备份代码、回滚版本、协作开发。SSH 配置让服务器能够安全地拉取代码，实现自动化部署

---

### 1. 创建 GitHub 仓库

**📋 本步骤目标：** 在 GitHub 上创建代码仓库

**💡 为什么需要：** 用 GitHub 管理代码可以实现版本控制、代码备份、团队协作，还能配合 GitHub Actions 实现自动部署

1. 打开 [GitHub](https://github.com)，登录账号
2. 点击右上角 **+** → **New repository**

![创建GitHub仓库](https://www.zhiboblog.com/wp-content/uploads/2025/01/10.png)

3. 填写仓库信息：
   - **Repository name**：`Spring-Lament-Blog`（或自定义名称）
   - **Description**：个人博客系统
   - **Public** 或 **Private**：根据需求选择
4. **不要** 勾选 "Initialize with README"
5. 点击 **Create repository**

创建完成后，GitHub 会显示快速设置指南，包含推送代码的命令。

### 2. 本地项目推送到 GitHub

**📋 本步骤目标：** 将本地代码上传到 GitHub 仓库

**💡 为什么需要：** 只有将代码推送到 GitHub，服务器才能从 GitHub 拉取代码进行部署。同时 GitHub 会保存代码的完整历史记录

在**本地项目目录**运行以下命令（首次推送）：

```bash
# 初始化 Git 仓库
git init

# 添加所有文件
git add .

# 或者只添加 README（如果是新仓库）
git add README.md

# 提交
git commit -m "首次提交"

# 设置主分支名称
git branch -M main

# 关联远程仓库（替换为你的仓库地址）
git remote add origin https://github.com/你的用户名/Spring-Lament-Blog.git

# 推送代码
git push -u origin main
```

![推送代码到GitHub](https://www.zhiboblog.com/wp-content/uploads/2025/01/11.png)

**注意**：

- 将 `你的用户名` 替换为你的 GitHub 用户名
- 将 `Spring-Lament-Blog` 替换为你创建的仓库名称
- 如果推送失败，检查是否需要配置 GitHub 认证（Personal Access Token）

**后续提交代码**：

```bash
git add .
git commit -m "描述你的修改"
git push origin main
```

### 3. 配置服务器 SSH 密钥（让服务器能拉取代码）

**📋 本步骤目标：** 配置服务器到 GitHub 的 SSH 认证

**💡 为什么需要：** 服务器需要 SSH 密钥才能从 GitHub 拉取代码（特别是私有仓库）。SSH 密钥是一种安全的认证方式，比使用密码更安全方便

#### 在服务器上生成 SSH 密钥

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 生成 SSH 密钥（一路回车，不设置密码）
ssh-keygen -t rsa -b 4096 -C "github-deploy"

# 输出示例：
# Generating public/private rsa key pair.
# Enter file in which to save the key (/root/.ssh/id_rsa): [直接回车]
# Enter passphrase (empty for no passphrase): [直接回车]
# Enter same passphrase again: [直接回车]

# 3. 查看公钥
cat ~/.ssh/id_rsa.pub

# 复制显示的公钥内容（从 ssh-rsa 开始到邮箱结束的完整内容）
```

![查看公钥](https://www.zhiboblog.com/wp-content/uploads/2025/01/12.png)

#### 将公钥添加到 GitHub

1. **复制** 上一步显示的公钥内容（完整的 `ssh-rsa ...` 开头的一大段）
2. 打开 GitHub，点击右上角头像 → **Settings**
3. 左侧菜单 → **SSH and GPG keys**
4. 点击 **New SSH key** 按钮

![GitHub SSH设置页面](https://www.zhiboblog.com/wp-content/uploads/2025/01/13.png)

5. 填写 SSH key 信息：
   - **Title**：`服务器部署密钥`（或任意便于识别的名称）
   - **Key**：粘贴刚才复制的公钥（完整内容）
6. 点击 **Add SSH key** 按钮保存

#### 测试连接

```bash
# 在服务器上运行
ssh -T git@github.com

# 成功输出：
# Hi 你的用户名! You've successfully authenticated...
```

### 4. 配置 GitHub Actions 的 SSH 密钥（自动部署用）

**📋 本步骤目标：** 为 GitHub Actions 创建专用的 SSH 密钥

**💡 为什么需要：** GitHub Actions 自动部署时需要通过 SSH 连接到服务器，上传文件和执行命令。创建专用密钥比使用个人密钥更安全，可以随时撤销而不影响其他访问

#### 生成专用密钥对

```bash
# 在服务器上运行
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/github_actions_rsa

# 一路回车，不设置密码

# 将公钥添加到授权列表
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 查看私钥（用于添加到 GitHub Secrets）
cat ~/.ssh/github_actions_rsa
```

#### 复制私钥内容

复制**完整的私钥内容**，包括：

```
-----BEGIN OPENSSH PRIVATE KEY-----
（中间很多行）
-----END OPENSSH PRIVATE KEY-----
```

这个私钥稍后会用于配置 `SERVER_SSH_KEY` Secret（见后续章节）。

---

## ⚙️ PM2配置

**📋 本章目标：** 创建 PM2 配置文件

**💡 为什么需要：** PM2 配置文件定义了应用的启动方式、环境变量等信息。有了配置文件，就可以用简单的命令（`pm2 start ecosystem.config.js`）启动应用，而不用每次都输入复杂的启动参数

在本地项目根目录下创建 `ecosystem.config.js` 文件，这是 PM2 的配置文件，服务器上的 Next.js 项目需要通过 PM2 来运行。

**创建配置文件**：

在本地项目根目录新建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [
    {
      name: "spring-lament-blog",
      script: "npm",
      args: "start",
      env: {
        NODE_ENV: "production",
      },
    },
  ],
};
```

![PM2配置文件](https://www.zhiboblog.com/wp-content/uploads/2025/01/8.png)

**配置说明**：

- `name`: 项目名称，用于 PM2 管理
- `script`: 执行的命令（npm）
- `args`: npm 的参数（start，即执行 `npm start`）
- `env`: 环境变量设置

**将配置文件推送到 GitHub**：

```bash
git add ecosystem.config.js
git commit -m "添加 PM2 配置文件"
git push origin main
```

---

## 📋 首次部署

**📋 本章目标：** 将代码部署到服务器并启动博客应用

**💡 为什么需要：** 前面的步骤都是准备工作，这一章才是真正把博客部署到服务器上并让它运行起来。包括拉取代码、配置环境、初始化数据库、构建项目、启动应用等完整流程

---

### 1. 克隆代码到服务器

**📋 本步骤目标：** 从 GitHub 将代码下载到服务器

**💡 为什么需要：** 服务器需要有项目的完整代码才能运行应用

首先，SSH 登录到服务器，切换到项目目录，然后从 GitHub 拉取代码：

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 切换到项目目录
cd /www/wwwroot/my-next-app

# 3. 从 GitHub 克隆代码（注意最后有个点，表示克隆到当前目录）
git clone git@github.com:你的用户名/Spring-Lament-Blog.git .

# 如果是公开仓库，也可以用 HTTPS 方式：
# git clone https://github.com/你的用户名/Spring-Lament-Blog.git .
```

![从GitHub拉取代码到服务器](https://www.zhiboblog.com/wp-content/uploads/2025/01/14.png)

**注意事项**：

- 命令末尾的 `.` 表示克隆到当前目录（`/www/wwwroot/my-next-app`）
- 如果使用 `git@github.com` 格式（SSH），需要先完成 SSH 密钥配置
- 如果使用 HTTPS 格式，可能需要输入 GitHub 用户名和密码（或 Personal Access Token）

**安装依赖**：

```bash
npm install
```

### 2. 配置环境变量

**📋 本步骤目标：** 配置生产环境的数据库连接、密钥等敏感信息

**💡 为什么需要：** 环境变量包含数据库连接、加密密钥等配置，不同环境（开发/生产）需要不同的配置。生产环境的配置必须单独设置，不能使用开发环境的配置

创建 `.env.production` 文件：

```bash
nano .env.production
```

填入内容：

```env
# 数据库（SQLite 简单，PostgreSQL 生产推荐）
DATABASE_URL="file:./prod.db"

# NextAuth 密钥（生成命令：openssl rand -base64 32）
NEXTAUTH_SECRET="粘贴生成的密钥"

# 网站地址（不要加斜杠）
NEXTAUTH_URL="http://powder.icu"

NODE_ENV="production"
```

保存并设置权限：

```bash
chmod 600 .env.production
```

### 4. 初始化数据库

**📋 本步骤目标：** 创建数据库表结构并添加初始数据

**💡 为什么需要：** 博客需要数据库来存储文章、分类、标签、用户等信息。初始化数据库会创建必要的表结构，并添加默认的管理员账号和示例数据

```bash
npm run db:generate  # 生成 Prisma Client 代码
npm run db:push      # 同步数据库结构
npm run db:seed      # 添加初始数据（管理员账号等）
```

### 5. 构建项目

**📋 本步骤目标：** 将 Next.js 项目编译成生产环境的优化代码

**💡 为什么需要：** Next.js 需要先构建才能在生产环境运行。构建过程会优化代码、生成静态页面、压缩资源等，提升网站性能

```bash
npm run build        # 构建项目
mkdir -p logs        # 创建日志目录
```

### 6. 启动应用（使用宝塔面板 PM2 管理器）

**📋 本步骤目标：** 使用 PM2 启动博客应用

**💡 为什么需要：** PM2 会让应用在后台持续运行，并提供进程管理、自动重启、日志管理等功能

**方法一：通过宝塔面板启动（推荐新手 ⭐）**

1. 打开宝塔面板
2. 点击左侧菜单 → **网站** → **Node 版本管理器**
3. 切换到 **PM2 管理器** 标签
4. 点击 **添加项目** 按钮

![添加Node项目](https://www.zhiboblog.com/wp-content/uploads/2025/01/15.png)

5. 填写配置：
   - **添加方式**：选择 "从文件/内容添加"
   - **配置文件**：选择项目目录下的 `ecosystem.config.js` 文件
   - 路径示例：`/www/wwwroot/my-next-app/ecosystem.config.js`
6. 点击 **提交**

![PM2配置](https://www.zhiboblog.com/wp-content/uploads/2025/01/16.png)

7. 启动成功后，可以看到项目运行状态

![项目运行成功](https://www.zhiboblog.com/wp-content/uploads/2025/01/17.png)

**方法二：通过命令行启动**

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # 设置开机自启，执行输出的命令
```

---

### 7. 配置外网访问（宝塔面板）

**📋 本步骤目标：** 配置域名和端口映射，让外部能访问博客

**💡 为什么需要：** 默认情况下应用只监听 localhost:3000，外部无法访问。需要配置端口映射或反向代理，才能通过域名或 IP 访问博客

如果使用宝塔面板，需要开启外网映射才能从外部访问：

1. 在 PM2 管理器中找到你的项目
2. 点击 **映射** 按钮
3. 配置映射规则：
   - **开启外网映射**：勾选
   - **绑定域名**：`powder.icu`（你的域名）
   - **内网端口**：`3000`（Next.js 默认端口）
   - **外网端口**：`80`（HTTP 默认端口）
4. 保存配置

![开启外网映射](https://www.zhiboblog.com/wp-content/uploads/2025/01/18.png)

**或者通过 Nginx 反向代理**（推荐，见后续章节）

---

### 8. 验证部署

**检查 PM2 状态**：

```bash
pm2 status                      # 应该显示 online
curl http://localhost:3000      # 测试访问
```

**浏览器访问测试**：

- 首页：http://powder.icu
- 后台：http://powder.icu/admin
- 默认账号：`admin` / `0919`

如果能正常访问，说明部署成功！ 🎉

---

## 🎯 Nginx 反向代理配置

**📋 本章目标：** 配置 Nginx 反向代理，实现域名访问和更好的性能

**💡 为什么需要：** 使用 Nginx 反向代理的好处：

- ✅ 可以直接通过域名访问（不需要加端口号）
- ✅ 可以配置 SSL 证书实现 HTTPS
- ✅ Nginx 可以处理静态文件、负载均衡，性能更好
- ✅ 可以配置缓存、压缩等优化

在宝塔面板 → 网站设置 → 配置文件，添加：

```nginx
server {
    listen 80;
    server_name powder.icu;
    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

配置完成后重启 Nginx 即可通过域名访问。

---

## 🛠️ 常用管理命令

### PM2 进程管理

#### 命令行方式

```bash
pm2 status                      # 查看状态
pm2 logs spring-lament-blog     # 查看日志
pm2 restart spring-lament-blog  # 重启
pm2 stop spring-lament-blog     # 停止
pm2 delete spring-lament-blog   # 删除
pm2 monit                       # 监控
```

#### 宝塔面板图形化管理（推荐新手 ⭐）

如果你使用宝塔面板，可以通过可视化界面管理 PM2：

**添加 Node 项目**：

1. 打开 **Node 版本管理器**
2. 点击 **PM2 管理器** 标签
3. 点击 **添加项目**
4. 选择 **从文件/内容添加**
5. **配置文件路径**：`/www/wwwroot/my-next-app/ecosystem.config.js`
6. 点击 **提交**

**管理项目**（启动后）：

- 🔄 **重启**：点击项目右侧的重启按钮
- ⏸️ **停止**：点击停止按钮
- 📊 **查看日志**：点击"日志"按钮查看实时日志
- 📈 **查看状态**：查看 CPU、内存占用
- 🌐 **绑定域名**：点击"映射"设置外网访问

**开启外网映射**（让外部能访问）：

1. 在项目列表中找到 `spring-lament-blog`
2. 点击 **映射** 按钮
3. 勾选 **开启外网映射**
4. 填写域名：`powder.icu`
5. 内网端口：`3000`
6. 外网端口：`80`
7. 保存

### 数据库管理

```bash
npm run db:generate  # 生成 Prisma Client
npm run db:push      # 同步数据库结构
npm run db:seed      # 创建初始数据
npm run db:studio    # 数据库管理界面
```

---

## 🔄 代码更新（三种方式）

**📋 本章目标：** 掌握三种代码更新方法，选择最适合你的方式

**💡 为什么需要：** 开发过程中会经常修改代码，需要将更新部署到服务器。提供三种方式：自动化脚本、GitHub Actions 自动部署、手动更新，适合不同场景和需求

---

### 方法 1：使用脚本（推荐 ⭐）

**优势**：

- ✅ 一条命令完成所有步骤
- ✅ 自动备份当前版本
- ✅ 出问题可以快速回滚

**步骤**：

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 进入项目目录
cd /www/wwwroot/my-next-app

# 3. 运行更新脚本
bash scripts/update-deploy.sh
```

**脚本自动执行**：

- 📦 备份当前版本到 `../backups/backup-YYYYMMDD-HHMMSS/`
- 📥 拉取最新代码 `git pull`
- 📦 更新依赖 `npm ci --production`
- ❓ 询问是否需要更新数据库
- 🔨 重新构建 `npm run build`
- 🔄 重启应用 `pm2 restart`

**如果更新失败，回滚**：

```bash
# 脚本会显示备份位置，例如：
# 备份完成: ../backups/backup-20251010-143000

# 复制备份回来
cp -r ../backups/backup-20251010-143000/* /www/wwwroot/my-next-app/  # cp 表示复制文件，-r 表示递归复制用于文件夹。该命令用于恢复备份文件到项目目录，实现回滚
pm2 restart spring-lament-blog
```

---

### 方法 2：GitHub Actions 自动部署（最方便 ⭐⭐⭐）

**优势**：

- 🚀 完全自动化，推送代码即部署
- 🎯 不需要登录服务器
- 📊 GitHub 可视化查看部署状态和日志
- ⏱️ 节省大量时间
- 🎁 **已优化**：只上传构建产物，速度快 10-20 倍

**前提条件**：已配置好 GitHub Secrets（见下面的详细说明）

**使用步骤**：

```bash
# 1. 在本地修改代码
git add .
git commit -m "添加新功能"

# 2. 推送到 GitHub
git push origin main

# 3. 自动部署开始！
# GitHub Actions 会自动：
# - 检出代码
# - 安装依赖并构建项目（在 GitHub 服务器上）
# - 只上传构建后的 .next、配置文件等必要文件（不包括 node_modules）
# - 在服务器上安装生产依赖
# - 推送数据库变更
# - 重启应用
```

**⚡ 性能优化说明**：

我们的部署配置已经过优化，**不会上传 node_modules**（数万个小文件），而是：

1. 在 GitHub Actions 服务器上构建
2. 只上传构建产物（`.next`、`prisma` 等必要文件）
3. 在服务器上通过 `npm ci --production` 安装生产依赖

**查看部署状态**：

1. 打开 GitHub 仓库页面
2. 点击顶部 **Actions** 标签
3. 查看最新的工作流运行状态
   - 🟢 绿色对勾 = 部署成功
   - 🔴 红色叉号 = 部署失败，点击查看错误日志
   - 🟡 黄色圆圈 = 正在部署中

---

### 方法 3：手动更新（完全手动控制）

**优势**：

- 🎯 精确控制每一步
- 🔍 适合学习理解部署流程
- 🆘 自动脚本出问题时的备用方案

**完整步骤**：

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 进入项目目录
cd /www/wwwroot/my-next-app

# 3. 拉取最新代码
git pull origin main

# 如果提示冲突，强制覆盖本地修改：
git fetch origin
git reset --hard origin/main

# 4. 更新依赖（如果 package.json 有变化）
npm install

# 5. 如果修改了数据库结构
# ⚠️ 重要：先删除 .env 文件
rm .env
npm run db:push

# 6. 重新构建
npm run build

# 7. 重启应用（如果修改了 .env.production）
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save

# 或者只是重启（没有修改环境变量）
pm2 restart spring-lament-blog

# 8. 验证
pm2 status
pm2 logs spring-lament-blog --lines 20
```

---

---

## 🤖 GitHub Actions 自动部署配置

**📋 本章目标：** 配置 GitHub Actions 实现自动化部署

**💡 为什么需要：** GitHub Actions 是最方便的部署方式：

- ✅ 推送代码到 GitHub 后自动部署，无需手动操作
- ✅ 在 GitHub 界面查看部署状态和日志，一目了然
- ✅ 节省大量时间，专注于开发而非运维
- ✅ 所有部署都有记录，便于追溯问题

GitHub Actions 可以实现：每次推送代码到 GitHub，自动构建并部署到服务器。

---

### 第一步：创建 GitHub Actions 工作流文件

**📋 本步骤目标：** 创建自动部署的配置文件

**💡 为什么需要：** 工作流文件定义了自动部署的完整流程（拉取代码、构建、上传、重启等），GitHub Actions 会按照这个文件执行部署

在**本地项目根目录**下创建工作流配置文件。

#### 1. 创建目录结构

```bash
# 在项目根目录执行
mkdir -p .github/workflows
```

#### 2. 创建工作流文件

创建文件 `.github/workflows/deploy.yml`，内容如下：

```yaml
name: Deploy Next.js

on:
  push:
    branches:
      - main # 只在 main 分支上触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22 # 使用 Node.js 22

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }} # 服务器 IP 或域名
          username: ${{ secrets.SSH_USERNAME }} # SSH 用户名
          key: ${{ secrets.SSH_PRIVATE_KEY }} # SSH 私钥
          source: "." # 上传整个项目目录
          target: "/www/wwwroot/my-next-app" # 服务器上的目标目录

      - name: Install dependencies on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /www/wwwroot/my-next-app
            npm install --production

      - name: Restart PM2 process
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /www/wwwroot/my-next-app
            pm2 restart ecosystem.config.js --env production
```

**工作流说明**：

- `on.push.branches`: 当推送到 main 分支时触发
- `Checkout code`: 拉取代码
- `Set up Node.js`: 配置 Node.js 环境
- `Install dependencies`: 安装依赖
- `Build project`: 构建项目
- `Deploy to Server`: 将构建产物上传到服务器
- `Install dependencies on server`: 在服务器上安装生产依赖
- `Restart PM2 process`: 重启 PM2 进程

---

### 第二步：配置 GitHub Secrets

**📋 本步骤目标：** 在 GitHub 仓库中配置服务器连接信息

**💡 为什么需要：** GitHub Actions 需要知道服务器的 IP、用户名、SSH 密钥等信息，才能连接到服务器进行部署。这些敏感信息存储在 GitHub Secrets 中，安全且不会暴露在代码里

#### 添加 Secrets 的位置

1. 打开你的 GitHub 仓库页面
2. 点击 `Settings`（设置）标签
3. 左侧菜单点击 `Secrets and variables` → `Actions`
4. 点击 `New repository secret` 按钮

![添加GitHub Secrets](https://www.zhiboblog.com/wp-content/uploads/2025/01/19.png)

![Secrets配置界面](https://www.zhiboblog.com/wp-content/uploads/2025/01/20.png)

---

#### 需要配置的 Secrets

### 1️⃣ SERVER_HOST（服务器 IP）

**值**：`42.193.227.185`

**如何获取**：

- 这是你的**腾讯云服务器 IP 地址**
- 在腾讯云控制台 → 云服务器 → 实例列表中查看
- 或者在宝塔面板右上角可以看到服务器 IP

---

### 2️⃣ SERVER_USER（SSH 用户名）

**值**：`root`

**说明**：

- 服务器的 SSH 登录用户名
- 通常是 `root`（Linux 最高权限用户）
- 如果使用其他用户，填写对应的用户名

---

### 3️⃣ SERVER_SSH_KEY（SSH 私钥）

> 💡 **如何获取**：参考前面 [🔑 GitHub 仓库和 SSH 配置 → 4. 配置 GitHub Actions 的 SSH 密钥](#🔑-github-仓库和-ssh-配置) 章节

**简要步骤**：

```bash
# 在服务器上查看已生成的私钥
cat ~/.ssh/github_actions_rsa

# 如果还没生成，运行：
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/github_actions_rsa
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

![查看SSH私钥](https://www.zhiboblog.com/wp-content/uploads/2025/01/21.png)

**需要复制的内容格式**：

```
-----BEGIN OPENSSH PRIVATE KEY-----
（完整的私钥内容，包括所有行）
-----END OPENSSH PRIVATE KEY-----
```

**⚠️ 重要**：

- 必须复制**完整内容**，包括第一行和最后一行
- 这是前面生成的 `github_actions_rsa` **私钥**（不是公钥）

---

### 4️⃣ SERVER_PORT（SSH 端口）

**值**：`22`

**说明**：

- SSH 默认端口是 `22`
- 如果你修改过 SSH 端口，填写修改后的端口号
- 在服务器上查看：`cat /etc/ssh/sshd_config | grep Port`

---

### 5️⃣ DATABASE_URL（数据库连接）

**SQLite（简单）**：

```
file:./prod.db
```

**PostgreSQL（推荐生产）**：

```
postgresql://用户名:密码@localhost:5432/数据库名?schema=public
```

**示例**：

```
postgresql://blog_user:MyStr0ngP@ssw0rd@localhost:5432/spring_lament_blog?schema=public
```

**如何获取**：

- 这是你在服务器上创建数据库时设置的
- 用户名和密码是你自己定义的
- 如果忘记了，可以在服务器的 `.env.production` 文件中查看

---

### 6️⃣ NEXTAUTH_SECRET（NextAuth 密钥）

**如何生成**：

在**服务器上**或**本地终端**运行：

```bash
openssl rand -base64 32
```

**输出示例**：

```
Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX
```

**⚠️ 注意**：

- 这是一个随机生成的强密钥
- 用于加密用户会话，必须保密
- 复制生成的字符串作为 Secret 值

---

### 7️⃣ NEXTAUTH_URL（网站地址）

**值**：`http://powder.icu`

**说明**：

- 你的网站完整地址
- HTTP 版本：`http://powder.icu`
- HTTPS 版本（配置 SSL 后）：`https://powder.icu`
- **⚠️ 末尾不要加斜杠！**

---

### 📝 添加 Secrets 的步骤

1. 打开 GitHub 仓库页面
2. 点击 `Settings`（设置）
3. 左侧菜单点击 `Secrets and variables` → `Actions`
4. 点击 `New repository secret` 按钮
5. 填写：
   - **Name**：Secret 名称（如 `SERVER_HOST`）
   - **Secret**：对应的值（如 `42.193.227.185`）
6. 点击 `Add secret` 保存
7. 重复以上步骤，添加所有 7 个 Secrets

---

### ✅ 配置完成检查

添加完所有 Secrets 后，你应该看到：

```
SERVER_HOST
SERVER_USER
SERVER_SSH_KEY
SERVER_PORT
DATABASE_URL
NEXTAUTH_SECRET
NEXTAUTH_URL
```

---

### 📤 推送工作流文件到 GitHub

在本地项目目录执行以下命令，将 GitHub Actions 工作流文件推送到 GitHub：

```bash
# 1. 添加工作流文件
git add .github/workflows/deploy.yml

# 2. 提交
git commit -m "添加 GitHub Actions 自动部署工作流"

# 3. 推送到 GitHub
git push origin main
```

推送后，GitHub Actions 会自动触发第一次部署！

---

### 🔍 查看 GitHub Actions 执行结果

配置完成后，每次推送代码到 main 分支，GitHub Actions 都会自动执行部署。

**查看部署状态的步骤**：

1. 打开你的 GitHub 仓库页面
2. 点击顶部的 **Actions** 标签
3. 你会看到工作流运行列表，显示每次部署的状态

![查看GitHub Actions执行结果](https://www.zhiboblog.com/wp-content/uploads/2025/01/22.png)

**状态说明**：

- 🟢 **绿色对勾（✓）**：部署成功！你的代码已经成功部署到服务器
- 🔴 **红色叉号（✗）**：部署失败，点击进入查看详细错误日志
- 🟡 **黄色圆圈**：正在部署中，请稍等...

**查看详细日志**：

1. 点击某次工作流运行（点击工作流名称）
2. 点击 `build-and-deploy` 任务
3. 展开每个步骤（如 "Build project"、"Deploy to Server" 等）
4. 查看每个步骤的详细输出日志

如果部署失败，错误信息会在相应的步骤中显示，帮助你快速定位问题。

---

### 🎉 自动部署完成！

配置完成后，你的开发流程变得非常简单：

```bash
# 1. 在本地修改代码
# ... 编辑文件 ...

# 2. 提交并推送
git add .
git commit -m "添加新功能：文章评论系统"
git push origin main

# 3. GitHub Actions 自动执行：
#    ✅ 检出代码
#    ✅ 安装 Node.js 环境
#    ✅ 安装依赖
#    ✅ 构建项目
#    ✅ 上传到服务器
#    ✅ 在服务器上安装生产依赖
#    ✅ 重启 PM2 进程

# 4. 几分钟后，访问网站查看更新！
```

**优势**：

- ✅ **完全自动化**：推送代码即部署，无需手动操作
- ✅ **省时省力**：不用再 SSH 登录服务器执行一堆命令
- ✅ **可视化监控**：在 GitHub Actions 界面实时查看部署状态
- ✅ **记录完整**：每次部署都有完整的日志记录，便于排查问题
- ✅ **团队协作**：多人开发时，每个人推送代码都会自动部署

**再也不用手动部署了！** 🚀

---

## 🐛 常见问题排查

**📋 本章目标：** 学会排查和解决部署过程中的常见问题

**💡 为什么需要：** 部署过程中可能遇到各种问题，了解常见问题及解决方案可以帮你快速定位和解决问题，避免浪费时间

---

### GitHub Actions 部署失败 ❌

**如何查看详细错误**：

1. 打开 GitHub 仓库 → **Actions** 标签
2. 点击失败的工作流（红色叉号）
3. 点击 **build-and-deploy** 任务
4. 展开失败的步骤，查看错误信息

**常见错误及解决方案**：

#### 1. SSH 连接失败

```
Error: connect ECONNREFUSED
```

**原因**：服务器 IP、端口或 SSH 密钥配置错误

**解决方案**：

- 检查 GitHub Secrets 中的 `SERVER_HOST`、`SERVER_PORT`、`SERVER_SSH_KEY` 是否正确
- 确保服务器防火墙允许 SSH 连接（端口 22）
- 测试 SSH 连接：`ssh root@你的服务器IP`

#### 2. 权限被拒绝

```
Permission denied (publickey)
```

**原因**：SSH 私钥未正确添加到服务器

**解决方案**：

```bash
# 在服务器上运行
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

#### 3. npm ci 失败

```
npm error code ELIFECYCLE
```

**原因**：依赖安装失败或 Node 版本不匹配

**解决方案**：

```bash
# 登录服务器
ssh root@你的服务器IP
cd /www/wwwroot/my-next-app

# 清理并重新安装
rm -rf node_modules package-lock.json
npm install
npm run build
pm2 restart spring-lament-blog
```

#### 4. 数据库错误

```
Error: P1001: Can't reach database server
```

**原因**：服务器上的 `.env.production` 文件不存在或配置错误

**解决方案**：

```bash
# 登录服务器，检查环境变量文件
cd /www/wwwroot/my-next-app
cat .env.production  # 查看配置

# 如果文件不存在，创建它
nano .env.production
# 按照前面章节的说明填入配置
```

### 502 Bad Gateway

```bash
pm2 status
pm2 logs spring-lament-blog --err --lines 50
pm2 restart spring-lament-blog
```

### 数据库连接失败

```bash
cat .env.production  # 检查配置
npm run db:push      # 测试连接
```

### 端口 80 被占用

```bash
lsof -i :80          # 查看占用进程
kill -9 [PID]        # 结束进程
```

### npm install 失败

```bash
rm -rf node_modules .next
npm cache clean --force
npm install
```

### GitHub Actions 部署很慢（超过 10 分钟）

**原因**：可能是网络问题或配置未优化

**检查要点**：

1. 确保 `.github/workflows/deploy.yml` 中的 `source` 参数**不包含 `node_modules`**
2. 应该只上传：`.next,package.json,package-lock.json,prisma,public,...`
3. 检查服务器磁盘空间：`df -h`
4. 检查服务器内存：`free -h`

**如果仍然很慢**：

```bash
# 登录服务器，手动清理旧文件
cd /www/wwwroot/my-next-app
rm -rf .next.backup node_modules/.cache
```

---

## ✅ 部署检查清单

**📋 本章目标：** 提供完整的部署检查清单，确保不遗漏任何步骤

**💡 为什么需要：** 部署涉及很多步骤，使用检查清单可以：

- ✅ 确保每个步骤都完成了
- ✅ 快速定位遗漏的配置
- ✅ 适合新手跟随，避免出错
- ✅ 作为部署文档的快速参考

---

### 🔧 服务器环境准备

- [ ] 服务器已安装 Node.js 20.x（通过宝塔面板或命令行）
- [ ] 服务器已安装 PM2
- [ ] 已创建项目目录 `/www/wwwroot/my-next-app`
- [ ] 域名已解析到服务器 IP

### 🔑 GitHub 和 SSH 配置

- [ ] 已创建 GitHub 仓库
- [ ] 本地代码已推送到 GitHub
- [ ] 服务器 SSH 密钥已生成
- [ ] 服务器公钥已添加到 GitHub（用于拉取代码）
- [ ] GitHub Actions SSH 密钥已生成（用于自动部署）
- [ ] 7 个 GitHub Secrets 已配置（如果使用自动部署）

### 📦 首次部署

- [ ] 代码已克隆到服务器
- [ ] `.env.production` 已创建并配置
- [ ] 确认没有 `.env` 文件（已删除）
- [ ] 依赖已安装（`npm install`）
- [ ] Prisma Client 已生成（`npm run db:generate`）
- [ ] 数据库已初始化（`npm run db:push` 和 `npm run db:seed`）
- [ ] 项目已构建（`npm run build`）
- [ ] PM2 已启动（`pm2 start ecosystem.config.js`）
- [ ] PM2 已保存（`pm2 save`）
- [ ] PM2 开机自启已设置（`pm2 startup`）

### ✅ 验证测试

- [ ] PM2 状态为 online（`pm2 status`）
- [ ] 本地测试可访问（`curl http://localhost:3000`）
- [ ] 网站首页可以访问（http://powder.icu）
- [ ] 后台可以访问（http://powder.icu/admin）
- [ ] 可以登录后台（账号：admin / 0919）
- [ ] 已修改默认管理员密码

### 🚀 可选优化

- [ ] Nginx 反向代理已配置
- [ ] SSL 证书已配置（HTTPS）
- [ ] GitHub Actions 自动部署已测试
- [ ] 宝塔面板 PM2 管理界面已配置
- [ ] 外网映射已开启（宝塔面板）

---

## ⚠️ 关键注意事项

**📋 本章目标：** 了解部署过程中的关键注意事项，避免常见错误

**💡 为什么需要：** 这些是实践中总结的重要经验，了解这些可以避免很多坑，节省大量排错时间

---

### 1. 环境变量文件管理

> **🔴 重要：生产环境不要有 `.env` 文件！**

- **本地开发**：使用 `.env.local`
- **生产环境**：只用 `.env.production`

**原因**：Prisma 优先读取 `.env`，如果存在会忽略 `.env.production`，导致数据库操作错误。

```bash
# 服务器上检查
cd /www/wwwroot/my-next-app
ls -la .env*       # 应该只有 .env.production
rm .env            # 如果存在就删除
```

### 2. NextAuth URL 配置

- ✅ 正确：`NEXTAUTH_URL="http://powder.icu"`（末尾不要加斜杠）
- ❌ 错误：`NEXTAUTH_URL="http://powder.icu/"`

### 3. PM2 环境变量更新

修改 `.env.production` 后，必须**完全重启**：

```bash
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save
```

**不要用** `pm2 restart`！因为 restart 不会重新加载环境变量。

### 4. 数据库迁移注意

如果修改了 Prisma schema，更新时需要：

```bash
npm run db:generate  # 生成新的 Prisma Client
npm run db:push      # 推送数据库变更
npm run build        # 重新构建
pm2 restart spring-lament-blog
```

### 5. 文件上传大小限制

如果需要上传大文件，记得在 Nginx 配置中设置：

```nginx
client_max_body_size 50M;  # 根据需求调整
```

## 📚 相关文档

- [Next.js 官方文档](https://nextjs.org/docs)
- [Prisma 官方文档](https://www.prisma.io/docs)
- [PM2 官方文档](https://pm2.keymetrics.io/docs)
- [宝塔面板文档](https://www.bt.cn/bbs/forum-39-1.html)
