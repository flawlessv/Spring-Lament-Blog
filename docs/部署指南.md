# åŸºäºå®å¡”é¢æ¿ + Next.js + Prisma çš„åšå®¢ç³»ç»Ÿè¶…è¯¦ç»†å®Œæ•´éƒ¨ç½²æŒ‡å—

---

## ğŸ“¦ æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡ï¼ˆå®å¡”é¢æ¿ç”¨æˆ·ï¼‰

> å¦‚æœä½ ä½¿ç”¨å®å¡”é¢æ¿ç®¡ç†æœåŠ¡å™¨ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å‡†å¤‡ç¯å¢ƒå¹¶ç™»é™†å®å¡”é¢æ¿
> åœ¨SSHç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹é¢æ¿å…¥å£ï¼š`/etc/init.d/bt default`

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…è¿è¡Œ Next.js åšå®¢æ‰€éœ€çš„åŸºç¡€ç¯å¢ƒï¼ˆNode.jsã€PM2ã€é¡¹ç›®ç›®å½•ï¼‰

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** Next.js æ˜¯åŸºäº Node.js çš„æ¡†æ¶ï¼Œå¿…é¡»å…ˆå®‰è£… Node.js æ‰èƒ½è¿è¡Œï¼›PM2 ç”¨äºç®¡ç†åº”ç”¨è¿›ç¨‹ï¼Œç¡®ä¿åº”ç”¨ç¨³å®šè¿è¡Œå’Œè‡ªåŠ¨é‡å¯

---

### 1. å®‰è£… Node ç‰ˆæœ¬ç®¡ç†å™¨

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** å®‰è£… Node.js è¿è¡Œç¯å¢ƒ

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** Next.js æ˜¯åŸºäº Node.js çš„ Web æ¡†æ¶ï¼Œæ²¡æœ‰ Node.js å°±æ— æ³•è¿è¡Œåšå®¢åº”ç”¨ã€‚ä½¿ç”¨ç‰ˆæœ¬ç®¡ç†å™¨å¯ä»¥æ–¹ä¾¿åœ°å®‰è£…å’Œåˆ‡æ¢ä¸åŒç‰ˆæœ¬çš„ Node.js

**æ­¥éª¤ 1ï¼šå®‰è£… Node ç‰ˆæœ¬ç®¡ç†å™¨æ’ä»¶**

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»å·¦ä¾§èœå• â†’ **è½¯ä»¶å•†åº—**
3. æœç´¢ "**Node ç‰ˆæœ¬ç®¡ç†å™¨**" æˆ– "**Node.js ç‰ˆæœ¬ç®¡ç†å™¨**"
4. ç‚¹å‡» **å®‰è£…** æŒ‰é’®

![å®å¡”é¢æ¿å®‰è£…Nodeç‰ˆæœ¬ç®¡ç†å™¨](https://www.zhiboblog.com/wp-content/uploads/2025/01/1.png)

**æ­¥éª¤ 2ï¼šæ‰“å¼€ Node ç‰ˆæœ¬ç®¡ç†å™¨**

å®‰è£…å®Œæˆåï¼Œåœ¨å·¦ä¾§èœå•ä¸­æ‰¾åˆ° "**è½¯ä»¶å•†åº—**" â†’ æ‰¾åˆ°å·²å®‰è£…çš„ "**Node ç‰ˆæœ¬ç®¡ç†å™¨**" â†’ ç‚¹å‡» **è®¾ç½®** æ‰“å¼€

![æ‰“å¼€Nodeç‰ˆæœ¬ç®¡ç†å™¨](https://www.zhiboblog.com/wp-content/uploads/2025/01/2.png)

**æ­¥éª¤ 3ï¼šæ›´æ–°ç‰ˆæœ¬åˆ—è¡¨**

1. åœ¨ Node ç‰ˆæœ¬ç®¡ç†å™¨ç•Œé¢
2. ç‚¹å‡» **æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨** æŒ‰é’®
3. ç­‰å¾…ç‰ˆæœ¬åˆ—è¡¨æ›´æ–°å®Œæˆ

![æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨](https://www.zhiboblog.com/wp-content/uploads/2025/01/3.png)

**æ­¥éª¤ 4ï¼šå®‰è£… Node.js**

1. åœ¨ç‰ˆæœ¬åˆ—è¡¨ä¸­é€‰æ‹©æœ€æ–°çš„ç¨³å®šç‰ˆï¼ˆæ¨è v20.x.x æˆ– v22.x.xï¼‰
2. ç‚¹å‡»è¯¥ç‰ˆæœ¬å³ä¾§çš„ **å®‰è£…** æŒ‰é’®
3. ç­‰å¾…å®‰è£…å®Œæˆ

![å®‰è£…Node.js](https://www.zhiboblog.com/wp-content/uploads/2025/01/4.png)

**æ­¥éª¤ 5ï¼šè®¾ç½®å‘½ä»¤è¡Œç‰ˆæœ¬**

1. å®‰è£…å®Œæˆåï¼Œåœ¨å·²å®‰è£…ç‰ˆæœ¬åˆ—è¡¨ä¸­
2. æ‰¾åˆ°åˆšå®‰è£…çš„ç‰ˆæœ¬
3. ç‚¹å‡» **è®¾ç½®å‘½ä»¤è¡Œç‰ˆæœ¬** æˆ– **è®¾ä¸ºé»˜è®¤**
4. è¿™æ ·åœ¨ SSH ç»ˆç«¯ä¸­å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ node å’Œ npm å‘½ä»¤äº†

![è®¾ç½®å‘½ä»¤è¡Œç‰ˆæœ¬](https://www.zhiboblog.com/wp-content/uploads/2025/01/5.png)

**éªŒè¯å®‰è£…**ï¼š

```bash
# SSH ç™»å½•æœåŠ¡å™¨å
node -v   # åº”æ˜¾ç¤º v20.x.x
npm -v    # åº”æ˜¾ç¤ºå¯¹åº”çš„ npm ç‰ˆæœ¬
```

### 2. å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** å®‰è£… PM2 è¿›ç¨‹ç®¡ç†å·¥å…·

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** PM2 å¯ä»¥è®© Next.js åº”ç”¨åœ¨åå°æŒç»­è¿è¡Œï¼Œè‡ªåŠ¨é‡å¯å´©æºƒçš„è¿›ç¨‹ï¼Œå¹¶åœ¨æœåŠ¡å™¨é‡å¯åè‡ªåŠ¨å¯åŠ¨åº”ç”¨ã€‚å¦‚æœç›´æ¥ç”¨ `npm start` è¿è¡Œï¼Œä¸€æ—¦å…³é—­ SSH è¿æ¥ï¼Œåº”ç”¨å°±ä¼šåœæ­¢

æ‰“å¼€æœåŠ¡å™¨å‘½ä»¤è¡Œå®‰è£…ï¼š

```bash
npm install -g pm2
pm2 -v  # éªŒè¯å®‰è£…
```

### 3. åˆ›å»ºé¡¹ç›®ç›®å½•

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå­˜æ”¾åšå®¢ä»£ç çš„æ–‡ä»¶å¤¹

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç›®å½•æ¥å­˜æ”¾é¡¹ç›®ä»£ç ã€ä¾èµ–åŒ…å’Œæ„å»ºäº§ç‰©ï¼Œä¾¿äºç®¡ç†å’Œç»´æŠ¤

**æ–¹æ³•ä¸€ï¼šé€šè¿‡å®å¡”é¢æ¿**

1. ç‚¹å‡»å®å¡”é¢æ¿å·¦ä¾§èœå• â†’ **æ–‡ä»¶**
2. åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼Œè¿›å…¥ `/www/wwwroot/` ç›®å½•
3. ç‚¹å‡»é¡¶éƒ¨çš„ **æ–°å»ºæ–‡ä»¶å¤¹** æŒ‰é’®

![å®å¡”é¢æ¿æ–‡ä»¶ç®¡ç†](https://www.zhiboblog.com/wp-content/uploads/2025/01/6.png)

4. è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š`my-next-app`ï¼ˆæˆ–ä½ å–œæ¬¢çš„åç§°ï¼‰
5. è®¾ç½®æƒé™ä¸º `755`
6. ç‚¹å‡»ç¡®å®š

![æ–°å»ºé¡¹ç›®æ–‡ä»¶å¤¹](https://www.zhiboblog.com/wp-content/uploads/2025/01/7.png)

**æ–¹æ³•äºŒï¼šé€šè¿‡å‘½ä»¤è¡Œ**

```bash
mkdir -p /www/wwwroot/my-next-app
cd /www/wwwroot/my-next-app
```

---

## ğŸ”‘ GitHub ä»“åº“å’Œ SSH é…ç½®

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** ä½¿ç”¨ GitHub ç®¡ç†ä»£ç ï¼Œé…ç½®æœåŠ¡å™¨ä¸ GitHub çš„ SSH è¿æ¥

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** GitHub ç”¨äºç‰ˆæœ¬æ§åˆ¶å’Œä»£ç æ‰˜ç®¡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¤‡ä»½ä»£ç ã€å›æ»šç‰ˆæœ¬ã€åä½œå¼€å‘ã€‚SSH é…ç½®è®©æœåŠ¡å™¨èƒ½å¤Ÿå®‰å…¨åœ°æ‹‰å–ä»£ç ï¼Œå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

---

### 1. åˆ›å»º GitHub ä»“åº“

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** åœ¨ GitHub ä¸Šåˆ›å»ºä»£ç ä»“åº“

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** ç”¨ GitHub ç®¡ç†ä»£ç å¯ä»¥å®ç°ç‰ˆæœ¬æ§åˆ¶ã€ä»£ç å¤‡ä»½ã€å›¢é˜Ÿåä½œï¼Œè¿˜èƒ½é…åˆ GitHub Actions å®ç°è‡ªåŠ¨éƒ¨ç½²

1. æ‰“å¼€ [GitHub](https://github.com)ï¼Œç™»å½•è´¦å·
2. ç‚¹å‡»å³ä¸Šè§’ **+** â†’ **New repository**

![åˆ›å»ºGitHubä»“åº“](https://www.zhiboblog.com/wp-content/uploads/2025/01/10.png)

3. å¡«å†™ä»“åº“ä¿¡æ¯ï¼š
   - **Repository name**ï¼š`Spring-Lament-Blog`ï¼ˆæˆ–è‡ªå®šä¹‰åç§°ï¼‰
   - **Description**ï¼šä¸ªäººåšå®¢ç³»ç»Ÿ
   - **Public** æˆ– **Private**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©
4. **ä¸è¦** å‹¾é€‰ "Initialize with README"
5. ç‚¹å‡» **Create repository**

åˆ›å»ºå®Œæˆåï¼ŒGitHub ä¼šæ˜¾ç¤ºå¿«é€Ÿè®¾ç½®æŒ‡å—ï¼ŒåŒ…å«æ¨é€ä»£ç çš„å‘½ä»¤ã€‚

### 2. æœ¬åœ°é¡¹ç›®æ¨é€åˆ° GitHub

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** å°†æœ¬åœ°ä»£ç ä¸Šä¼ åˆ° GitHub ä»“åº“

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** åªæœ‰å°†ä»£ç æ¨é€åˆ° GitHubï¼ŒæœåŠ¡å™¨æ‰èƒ½ä» GitHub æ‹‰å–ä»£ç è¿›è¡Œéƒ¨ç½²ã€‚åŒæ—¶ GitHub ä¼šä¿å­˜ä»£ç çš„å®Œæ•´å†å²è®°å½•

åœ¨**æœ¬åœ°é¡¹ç›®ç›®å½•**è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆé¦–æ¬¡æ¨é€ï¼‰ï¼š

```bash
# åˆå§‹åŒ– Git ä»“åº“
git init

# æ·»åŠ æ‰€æœ‰æ–‡ä»¶
git add .

# æˆ–è€…åªæ·»åŠ  READMEï¼ˆå¦‚æœæ˜¯æ–°ä»“åº“ï¼‰
git add README.md

# æäº¤
git commit -m "é¦–æ¬¡æäº¤"

# è®¾ç½®ä¸»åˆ†æ”¯åç§°
git branch -M main

# å…³è”è¿œç¨‹ä»“åº“ï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git remote add origin https://github.com/ä½ çš„ç”¨æˆ·å/Spring-Lament-Blog.git

# æ¨é€ä»£ç 
git push -u origin main
```

![æ¨é€ä»£ç åˆ°GitHub](https://www.zhiboblog.com/wp-content/uploads/2025/01/11.png)

**æ³¨æ„**ï¼š

- å°† `ä½ çš„ç”¨æˆ·å` æ›¿æ¢ä¸ºä½ çš„ GitHub ç”¨æˆ·å
- å°† `Spring-Lament-Blog` æ›¿æ¢ä¸ºä½ åˆ›å»ºçš„ä»“åº“åç§°
- å¦‚æœæ¨é€å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é…ç½® GitHub è®¤è¯ï¼ˆPersonal Access Tokenï¼‰

**åç»­æäº¤ä»£ç **ï¼š

```bash
git add .
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"
git push origin main
```

### 3. é…ç½®æœåŠ¡å™¨ SSH å¯†é’¥ï¼ˆè®©æœåŠ¡å™¨èƒ½æ‹‰å–ä»£ç ï¼‰

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** é…ç½®æœåŠ¡å™¨åˆ° GitHub çš„ SSH è®¤è¯

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** æœåŠ¡å™¨éœ€è¦ SSH å¯†é’¥æ‰èƒ½ä» GitHub æ‹‰å–ä»£ç ï¼ˆç‰¹åˆ«æ˜¯ç§æœ‰ä»“åº“ï¼‰ã€‚SSH å¯†é’¥æ˜¯ä¸€ç§å®‰å…¨çš„è®¤è¯æ–¹å¼ï¼Œæ¯”ä½¿ç”¨å¯†ç æ›´å®‰å…¨æ–¹ä¾¿

#### åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ SSH å¯†é’¥

```bash
# 1. SSH ç™»å½•æœåŠ¡å™¨
ssh root@42.193.227.185

# 2. ç”Ÿæˆ SSH å¯†é’¥ï¼ˆä¸€è·¯å›è½¦ï¼Œä¸è®¾ç½®å¯†ç ï¼‰
ssh-keygen -t rsa -b 4096 -C "github-deploy"

# è¾“å‡ºç¤ºä¾‹ï¼š
# Generating public/private rsa key pair.
# Enter file in which to save the key (/root/.ssh/id_rsa): [ç›´æ¥å›è½¦]
# Enter passphrase (empty for no passphrase): [ç›´æ¥å›è½¦]
# Enter same passphrase again: [ç›´æ¥å›è½¦]

# 3. æŸ¥çœ‹å…¬é’¥
cat ~/.ssh/id_rsa.pub

# å¤åˆ¶æ˜¾ç¤ºçš„å…¬é’¥å†…å®¹ï¼ˆä» ssh-rsa å¼€å§‹åˆ°é‚®ç®±ç»“æŸçš„å®Œæ•´å†…å®¹ï¼‰
```

![æŸ¥çœ‹å…¬é’¥](https://www.zhiboblog.com/wp-content/uploads/2025/01/12.png)

#### å°†å…¬é’¥æ·»åŠ åˆ° GitHub

1. **å¤åˆ¶** ä¸Šä¸€æ­¥æ˜¾ç¤ºçš„å…¬é’¥å†…å®¹ï¼ˆå®Œæ•´çš„ `ssh-rsa ...` å¼€å¤´çš„ä¸€å¤§æ®µï¼‰
2. æ‰“å¼€ GitHubï¼Œç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ **Settings**
3. å·¦ä¾§èœå• â†’ **SSH and GPG keys**
4. ç‚¹å‡» **New SSH key** æŒ‰é’®

![GitHub SSHè®¾ç½®é¡µé¢](https://www.zhiboblog.com/wp-content/uploads/2025/01/13.png)

5. å¡«å†™ SSH key ä¿¡æ¯ï¼š
   - **Title**ï¼š`æœåŠ¡å™¨éƒ¨ç½²å¯†é’¥`ï¼ˆæˆ–ä»»æ„ä¾¿äºè¯†åˆ«çš„åç§°ï¼‰
   - **Key**ï¼šç²˜è´´åˆšæ‰å¤åˆ¶çš„å…¬é’¥ï¼ˆå®Œæ•´å†…å®¹ï¼‰
6. ç‚¹å‡» **Add SSH key** æŒ‰é’®ä¿å­˜

#### æµ‹è¯•è¿æ¥

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh -T git@github.com

# æˆåŠŸè¾“å‡ºï¼š
# Hi ä½ çš„ç”¨æˆ·å! You've successfully authenticated...
```

### 4. é…ç½® GitHub Actions çš„ SSH å¯†é’¥ï¼ˆè‡ªåŠ¨éƒ¨ç½²ç”¨ï¼‰

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** ä¸º GitHub Actions åˆ›å»ºä¸“ç”¨çš„ SSH å¯†é’¥

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** GitHub Actions è‡ªåŠ¨éƒ¨ç½²æ—¶éœ€è¦é€šè¿‡ SSH è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä¸Šä¼ æ–‡ä»¶å’Œæ‰§è¡Œå‘½ä»¤ã€‚åˆ›å»ºä¸“ç”¨å¯†é’¥æ¯”ä½¿ç”¨ä¸ªäººå¯†é’¥æ›´å®‰å…¨ï¼Œå¯ä»¥éšæ—¶æ’¤é”€è€Œä¸å½±å“å…¶ä»–è®¿é—®

#### ç”Ÿæˆä¸“ç”¨å¯†é’¥å¯¹

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/github_actions_rsa

# ä¸€è·¯å›è½¦ï¼Œä¸è®¾ç½®å¯†ç 

# å°†å…¬é’¥æ·»åŠ åˆ°æˆæƒåˆ—è¡¨
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# æŸ¥çœ‹ç§é’¥ï¼ˆç”¨äºæ·»åŠ åˆ° GitHub Secretsï¼‰
cat ~/.ssh/github_actions_rsa
```

#### å¤åˆ¶ç§é’¥å†…å®¹

å¤åˆ¶**å®Œæ•´çš„ç§é’¥å†…å®¹**ï¼ŒåŒ…æ‹¬ï¼š

```
-----BEGIN OPENSSH PRIVATE KEY-----
ï¼ˆä¸­é—´å¾ˆå¤šè¡Œï¼‰
-----END OPENSSH PRIVATE KEY-----
```

è¿™ä¸ªç§é’¥ç¨åä¼šç”¨äºé…ç½® `SERVER_SSH_KEY` Secretï¼ˆè§åç»­ç« èŠ‚ï¼‰ã€‚

---

## âš™ï¸ PM2é…ç½®

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** åˆ›å»º PM2 é…ç½®æ–‡ä»¶

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** PM2 é…ç½®æ–‡ä»¶å®šä¹‰äº†åº”ç”¨çš„å¯åŠ¨æ–¹å¼ã€ç¯å¢ƒå˜é‡ç­‰ä¿¡æ¯ã€‚æœ‰äº†é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥ç”¨ç®€å•çš„å‘½ä»¤ï¼ˆ`pm2 start ecosystem.config.js`ï¼‰å¯åŠ¨åº”ç”¨ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½è¾“å…¥å¤æ‚çš„å¯åŠ¨å‚æ•°

åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `ecosystem.config.js` æ–‡ä»¶ï¼Œè¿™æ˜¯ PM2 çš„é…ç½®æ–‡ä»¶ï¼ŒæœåŠ¡å™¨ä¸Šçš„ Next.js é¡¹ç›®éœ€è¦é€šè¿‡ PM2 æ¥è¿è¡Œã€‚

**åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š

åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•æ–°å»º `ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: "spring-lament-blog",
      script: "npm",
      args: "start",
      env: {
        NODE_ENV: "production",
      },
    },
  ],
};
```

![PM2é…ç½®æ–‡ä»¶](https://www.zhiboblog.com/wp-content/uploads/2025/01/8.png)

**é…ç½®è¯´æ˜**ï¼š

- `name`: é¡¹ç›®åç§°ï¼Œç”¨äº PM2 ç®¡ç†
- `script`: æ‰§è¡Œçš„å‘½ä»¤ï¼ˆnpmï¼‰
- `args`: npm çš„å‚æ•°ï¼ˆstartï¼Œå³æ‰§è¡Œ `npm start`ï¼‰
- `env`: ç¯å¢ƒå˜é‡è®¾ç½®

**å°†é…ç½®æ–‡ä»¶æ¨é€åˆ° GitHub**ï¼š

```bash
git add ecosystem.config.js
git commit -m "æ·»åŠ  PM2 é…ç½®æ–‡ä»¶"
git push origin main
```

---

## ğŸ“‹ é¦–æ¬¡éƒ¨ç½²

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** å°†ä»£ç éƒ¨ç½²åˆ°æœåŠ¡å™¨å¹¶å¯åŠ¨åšå®¢åº”ç”¨

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** å‰é¢çš„æ­¥éª¤éƒ½æ˜¯å‡†å¤‡å·¥ä½œï¼Œè¿™ä¸€ç« æ‰æ˜¯çœŸæ­£æŠŠåšå®¢éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå¹¶è®©å®ƒè¿è¡Œèµ·æ¥ã€‚åŒ…æ‹¬æ‹‰å–ä»£ç ã€é…ç½®ç¯å¢ƒã€åˆå§‹åŒ–æ•°æ®åº“ã€æ„å»ºé¡¹ç›®ã€å¯åŠ¨åº”ç”¨ç­‰å®Œæ•´æµç¨‹

---

### 1. å…‹éš†ä»£ç åˆ°æœåŠ¡å™¨

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** ä» GitHub å°†ä»£ç ä¸‹è½½åˆ°æœåŠ¡å™¨

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** æœåŠ¡å™¨éœ€è¦æœ‰é¡¹ç›®çš„å®Œæ•´ä»£ç æ‰èƒ½è¿è¡Œåº”ç”¨

é¦–å…ˆï¼ŒSSH ç™»å½•åˆ°æœåŠ¡å™¨ï¼Œåˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•ï¼Œç„¶åä» GitHub æ‹‰å–ä»£ç ï¼š

```bash
# 1. SSH ç™»å½•æœåŠ¡å™¨
ssh root@42.193.227.185

# 2. åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /www/wwwroot/my-next-app

# 3. ä» GitHub å…‹éš†ä»£ç ï¼ˆæ³¨æ„æœ€åæœ‰ä¸ªç‚¹ï¼Œè¡¨ç¤ºå…‹éš†åˆ°å½“å‰ç›®å½•ï¼‰
git clone git@github.com:ä½ çš„ç”¨æˆ·å/Spring-Lament-Blog.git .

# å¦‚æœæ˜¯å…¬å¼€ä»“åº“ï¼Œä¹Ÿå¯ä»¥ç”¨ HTTPS æ–¹å¼ï¼š
# git clone https://github.com/ä½ çš„ç”¨æˆ·å/Spring-Lament-Blog.git .
```

![ä»GitHubæ‹‰å–ä»£ç åˆ°æœåŠ¡å™¨](https://www.zhiboblog.com/wp-content/uploads/2025/01/14.png)

**æ³¨æ„äº‹é¡¹**ï¼š

- å‘½ä»¤æœ«å°¾çš„ `.` è¡¨ç¤ºå…‹éš†åˆ°å½“å‰ç›®å½•ï¼ˆ`/www/wwwroot/my-next-app`ï¼‰
- å¦‚æœä½¿ç”¨ `git@github.com` æ ¼å¼ï¼ˆSSHï¼‰ï¼Œéœ€è¦å…ˆå®Œæˆ SSH å¯†é’¥é…ç½®
- å¦‚æœä½¿ç”¨ HTTPS æ ¼å¼ï¼Œå¯èƒ½éœ€è¦è¾“å…¥ GitHub ç”¨æˆ·åå’Œå¯†ç ï¼ˆæˆ– Personal Access Tokenï¼‰

**å®‰è£…ä¾èµ–**ï¼š

```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** é…ç½®ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“è¿æ¥ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** ç¯å¢ƒå˜é‡åŒ…å«æ•°æ®åº“è¿æ¥ã€åŠ å¯†å¯†é’¥ç­‰é…ç½®ï¼Œä¸åŒç¯å¢ƒï¼ˆå¼€å‘/ç”Ÿäº§ï¼‰éœ€è¦ä¸åŒçš„é…ç½®ã€‚ç”Ÿäº§ç¯å¢ƒçš„é…ç½®å¿…é¡»å•ç‹¬è®¾ç½®ï¼Œä¸èƒ½ä½¿ç”¨å¼€å‘ç¯å¢ƒçš„é…ç½®

åˆ›å»º `.env.production` æ–‡ä»¶ï¼š

```bash
nano .env.production
```

å¡«å…¥å†…å®¹ï¼š

```env
# æ•°æ®åº“ï¼ˆSQLite ç®€å•ï¼ŒPostgreSQL ç”Ÿäº§æ¨èï¼‰
DATABASE_URL="file:./prod.db"

# NextAuth å¯†é’¥ï¼ˆç”Ÿæˆå‘½ä»¤ï¼šopenssl rand -base64 32ï¼‰
NEXTAUTH_SECRET="ç²˜è´´ç”Ÿæˆçš„å¯†é’¥"

# ç½‘ç«™åœ°å€ï¼ˆä¸è¦åŠ æ–œæ ï¼‰
NEXTAUTH_URL="http://powder.icu"

NODE_ENV="production"
```

ä¿å­˜å¹¶è®¾ç½®æƒé™ï¼š

```bash
chmod 600 .env.production
```

### 4. åˆå§‹åŒ–æ•°æ®åº“

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„å¹¶æ·»åŠ åˆå§‹æ•°æ®

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** åšå®¢éœ€è¦æ•°æ®åº“æ¥å­˜å‚¨æ–‡ç« ã€åˆ†ç±»ã€æ ‡ç­¾ã€ç”¨æˆ·ç­‰ä¿¡æ¯ã€‚åˆå§‹åŒ–æ•°æ®åº“ä¼šåˆ›å»ºå¿…è¦çš„è¡¨ç»“æ„ï¼Œå¹¶æ·»åŠ é»˜è®¤çš„ç®¡ç†å‘˜è´¦å·å’Œç¤ºä¾‹æ•°æ®

```bash
npm run db:generate  # ç”Ÿæˆ Prisma Client ä»£ç 
npm run db:push      # åŒæ­¥æ•°æ®åº“ç»“æ„
npm run db:seed      # æ·»åŠ åˆå§‹æ•°æ®ï¼ˆç®¡ç†å‘˜è´¦å·ç­‰ï¼‰
```

### 5. æ„å»ºé¡¹ç›®

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** å°† Next.js é¡¹ç›®ç¼–è¯‘æˆç”Ÿäº§ç¯å¢ƒçš„ä¼˜åŒ–ä»£ç 

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** Next.js éœ€è¦å…ˆæ„å»ºæ‰èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œã€‚æ„å»ºè¿‡ç¨‹ä¼šä¼˜åŒ–ä»£ç ã€ç”Ÿæˆé™æ€é¡µé¢ã€å‹ç¼©èµ„æºç­‰ï¼Œæå‡ç½‘ç«™æ€§èƒ½

```bash
npm run build        # æ„å»ºé¡¹ç›®
mkdir -p logs        # åˆ›å»ºæ—¥å¿—ç›®å½•
```

### 6. å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨å®å¡”é¢æ¿ PM2 ç®¡ç†å™¨ï¼‰

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** ä½¿ç”¨ PM2 å¯åŠ¨åšå®¢åº”ç”¨

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** PM2 ä¼šè®©åº”ç”¨åœ¨åå°æŒç»­è¿è¡Œï¼Œå¹¶æä¾›è¿›ç¨‹ç®¡ç†ã€è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†ç­‰åŠŸèƒ½

**æ–¹æ³•ä¸€ï¼šé€šè¿‡å®å¡”é¢æ¿å¯åŠ¨ï¼ˆæ¨èæ–°æ‰‹ â­ï¼‰**

1. æ‰“å¼€å®å¡”é¢æ¿
2. ç‚¹å‡»å·¦ä¾§èœå• â†’ **ç½‘ç«™** â†’ **Node ç‰ˆæœ¬ç®¡ç†å™¨**
3. åˆ‡æ¢åˆ° **PM2 ç®¡ç†å™¨** æ ‡ç­¾
4. ç‚¹å‡» **æ·»åŠ é¡¹ç›®** æŒ‰é’®

![æ·»åŠ Nodeé¡¹ç›®](https://www.zhiboblog.com/wp-content/uploads/2025/01/15.png)

5. å¡«å†™é…ç½®ï¼š
   - **æ·»åŠ æ–¹å¼**ï¼šé€‰æ‹© "ä»æ–‡ä»¶/å†…å®¹æ·»åŠ "
   - **é…ç½®æ–‡ä»¶**ï¼šé€‰æ‹©é¡¹ç›®ç›®å½•ä¸‹çš„ `ecosystem.config.js` æ–‡ä»¶
   - è·¯å¾„ç¤ºä¾‹ï¼š`/www/wwwroot/my-next-app/ecosystem.config.js`
6. ç‚¹å‡» **æäº¤**

![PM2é…ç½®](https://www.zhiboblog.com/wp-content/uploads/2025/01/16.png)

7. å¯åŠ¨æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°é¡¹ç›®è¿è¡ŒçŠ¶æ€

![é¡¹ç›®è¿è¡ŒæˆåŠŸ](https://www.zhiboblog.com/wp-content/uploads/2025/01/17.png)

**æ–¹æ³•äºŒï¼šé€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨**

```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # è®¾ç½®å¼€æœºè‡ªå¯ï¼Œæ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤
```

---

### 7. é…ç½®å¤–ç½‘è®¿é—®ï¼ˆå®å¡”é¢æ¿ï¼‰

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** é…ç½®åŸŸåå’Œç«¯å£æ˜ å°„ï¼Œè®©å¤–éƒ¨èƒ½è®¿é—®åšå®¢

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** é»˜è®¤æƒ…å†µä¸‹åº”ç”¨åªç›‘å¬ localhost:3000ï¼Œå¤–éƒ¨æ— æ³•è®¿é—®ã€‚éœ€è¦é…ç½®ç«¯å£æ˜ å°„æˆ–åå‘ä»£ç†ï¼Œæ‰èƒ½é€šè¿‡åŸŸåæˆ– IP è®¿é—®åšå®¢

å¦‚æœä½¿ç”¨å®å¡”é¢æ¿ï¼Œéœ€è¦å¼€å¯å¤–ç½‘æ˜ å°„æ‰èƒ½ä»å¤–éƒ¨è®¿é—®ï¼š

1. åœ¨ PM2 ç®¡ç†å™¨ä¸­æ‰¾åˆ°ä½ çš„é¡¹ç›®
2. ç‚¹å‡» **æ˜ å°„** æŒ‰é’®
3. é…ç½®æ˜ å°„è§„åˆ™ï¼š
   - **å¼€å¯å¤–ç½‘æ˜ å°„**ï¼šå‹¾é€‰
   - **ç»‘å®šåŸŸå**ï¼š`powder.icu`ï¼ˆä½ çš„åŸŸåï¼‰
   - **å†…ç½‘ç«¯å£**ï¼š`3000`ï¼ˆNext.js é»˜è®¤ç«¯å£ï¼‰
   - **å¤–ç½‘ç«¯å£**ï¼š`80`ï¼ˆHTTP é»˜è®¤ç«¯å£ï¼‰
4. ä¿å­˜é…ç½®

![å¼€å¯å¤–ç½‘æ˜ å°„](https://www.zhiboblog.com/wp-content/uploads/2025/01/18.png)

**æˆ–è€…é€šè¿‡ Nginx åå‘ä»£ç†**ï¼ˆæ¨èï¼Œè§åç»­ç« èŠ‚ï¼‰

---

### 8. éªŒè¯éƒ¨ç½²

**æ£€æŸ¥ PM2 çŠ¶æ€**ï¼š

```bash
pm2 status                      # åº”è¯¥æ˜¾ç¤º online
curl http://localhost:3000      # æµ‹è¯•è®¿é—®
```

**æµè§ˆå™¨è®¿é—®æµ‹è¯•**ï¼š

- é¦–é¡µï¼šhttp://powder.icu
- åå°ï¼šhttp://powder.icu/admin
- é»˜è®¤è´¦å·ï¼š`admin` / `0919`

å¦‚æœèƒ½æ­£å¸¸è®¿é—®ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼ ğŸ‰

---

## ğŸ¯ Nginx åå‘ä»£ç†é…ç½®

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** é…ç½® Nginx åå‘ä»£ç†ï¼Œå®ç°åŸŸåè®¿é—®å’Œæ›´å¥½çš„æ€§èƒ½

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** ä½¿ç”¨ Nginx åå‘ä»£ç†çš„å¥½å¤„ï¼š

- âœ… å¯ä»¥ç›´æ¥é€šè¿‡åŸŸåè®¿é—®ï¼ˆä¸éœ€è¦åŠ ç«¯å£å·ï¼‰
- âœ… å¯ä»¥é…ç½® SSL è¯ä¹¦å®ç° HTTPS
- âœ… Nginx å¯ä»¥å¤„ç†é™æ€æ–‡ä»¶ã€è´Ÿè½½å‡è¡¡ï¼Œæ€§èƒ½æ›´å¥½
- âœ… å¯ä»¥é…ç½®ç¼“å­˜ã€å‹ç¼©ç­‰ä¼˜åŒ–

åœ¨å®å¡”é¢æ¿ â†’ ç½‘ç«™è®¾ç½® â†’ é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```nginx
server {
    listen 80;
    server_name powder.icu;
    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

é…ç½®å®Œæˆåé‡å¯ Nginx å³å¯é€šè¿‡åŸŸåè®¿é—®ã€‚

---

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2 è¿›ç¨‹ç®¡ç†

#### å‘½ä»¤è¡Œæ–¹å¼

```bash
pm2 status                      # æŸ¥çœ‹çŠ¶æ€
pm2 logs spring-lament-blog     # æŸ¥çœ‹æ—¥å¿—
pm2 restart spring-lament-blog  # é‡å¯
pm2 stop spring-lament-blog     # åœæ­¢
pm2 delete spring-lament-blog   # åˆ é™¤
pm2 monit                       # ç›‘æ§
```

#### å®å¡”é¢æ¿å›¾å½¢åŒ–ç®¡ç†ï¼ˆæ¨èæ–°æ‰‹ â­ï¼‰

å¦‚æœä½ ä½¿ç”¨å®å¡”é¢æ¿ï¼Œå¯ä»¥é€šè¿‡å¯è§†åŒ–ç•Œé¢ç®¡ç† PM2ï¼š

**æ·»åŠ  Node é¡¹ç›®**ï¼š

1. æ‰“å¼€ **Node ç‰ˆæœ¬ç®¡ç†å™¨**
2. ç‚¹å‡» **PM2 ç®¡ç†å™¨** æ ‡ç­¾
3. ç‚¹å‡» **æ·»åŠ é¡¹ç›®**
4. é€‰æ‹© **ä»æ–‡ä»¶/å†…å®¹æ·»åŠ **
5. **é…ç½®æ–‡ä»¶è·¯å¾„**ï¼š`/www/wwwroot/my-next-app/ecosystem.config.js`
6. ç‚¹å‡» **æäº¤**

**ç®¡ç†é¡¹ç›®**ï¼ˆå¯åŠ¨åï¼‰ï¼š

- ğŸ”„ **é‡å¯**ï¼šç‚¹å‡»é¡¹ç›®å³ä¾§çš„é‡å¯æŒ‰é’®
- â¸ï¸ **åœæ­¢**ï¼šç‚¹å‡»åœæ­¢æŒ‰é’®
- ğŸ“Š **æŸ¥çœ‹æ—¥å¿—**ï¼šç‚¹å‡»"æ—¥å¿—"æŒ‰é’®æŸ¥çœ‹å®æ—¶æ—¥å¿—
- ğŸ“ˆ **æŸ¥çœ‹çŠ¶æ€**ï¼šæŸ¥çœ‹ CPUã€å†…å­˜å ç”¨
- ğŸŒ **ç»‘å®šåŸŸå**ï¼šç‚¹å‡»"æ˜ å°„"è®¾ç½®å¤–ç½‘è®¿é—®

**å¼€å¯å¤–ç½‘æ˜ å°„**ï¼ˆè®©å¤–éƒ¨èƒ½è®¿é—®ï¼‰ï¼š

1. åœ¨é¡¹ç›®åˆ—è¡¨ä¸­æ‰¾åˆ° `spring-lament-blog`
2. ç‚¹å‡» **æ˜ å°„** æŒ‰é’®
3. å‹¾é€‰ **å¼€å¯å¤–ç½‘æ˜ å°„**
4. å¡«å†™åŸŸåï¼š`powder.icu`
5. å†…ç½‘ç«¯å£ï¼š`3000`
6. å¤–ç½‘ç«¯å£ï¼š`80`
7. ä¿å­˜

### æ•°æ®åº“ç®¡ç†

```bash
npm run db:generate  # ç”Ÿæˆ Prisma Client
npm run db:push      # åŒæ­¥æ•°æ®åº“ç»“æ„
npm run db:seed      # åˆ›å»ºåˆå§‹æ•°æ®
npm run db:studio    # æ•°æ®åº“ç®¡ç†ç•Œé¢
```

---

## ğŸ”„ ä»£ç æ›´æ–°ï¼ˆä¸‰ç§æ–¹å¼ï¼‰

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** æŒæ¡ä¸‰ç§ä»£ç æ›´æ–°æ–¹æ³•ï¼Œé€‰æ‹©æœ€é€‚åˆä½ çš„æ–¹å¼

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** å¼€å‘è¿‡ç¨‹ä¸­ä¼šç»å¸¸ä¿®æ”¹ä»£ç ï¼Œéœ€è¦å°†æ›´æ–°éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚æä¾›ä¸‰ç§æ–¹å¼ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ã€GitHub Actions è‡ªåŠ¨éƒ¨ç½²ã€æ‰‹åŠ¨æ›´æ–°ï¼Œé€‚åˆä¸åŒåœºæ™¯å’Œéœ€æ±‚

---

### æ–¹æ³• 1ï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨è â­ï¼‰

**ä¼˜åŠ¿**ï¼š

- âœ… ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰æ­¥éª¤
- âœ… è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬
- âœ… å‡ºé—®é¢˜å¯ä»¥å¿«é€Ÿå›æ»š

**æ­¥éª¤**ï¼š

```bash
# 1. SSH ç™»å½•æœåŠ¡å™¨
ssh root@42.193.227.185

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/my-next-app

# 3. è¿è¡Œæ›´æ–°è„šæœ¬
bash scripts/update-deploy.sh
```

**è„šæœ¬è‡ªåŠ¨æ‰§è¡Œ**ï¼š

- ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬åˆ° `../backups/backup-YYYYMMDD-HHMMSS/`
- ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç  `git pull`
- ğŸ“¦ æ›´æ–°ä¾èµ– `npm ci --production`
- â“ è¯¢é—®æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®åº“
- ğŸ”¨ é‡æ–°æ„å»º `npm run build`
- ğŸ”„ é‡å¯åº”ç”¨ `pm2 restart`

**å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå›æ»š**ï¼š

```bash
# è„šæœ¬ä¼šæ˜¾ç¤ºå¤‡ä»½ä½ç½®ï¼Œä¾‹å¦‚ï¼š
# å¤‡ä»½å®Œæˆ: ../backups/backup-20251010-143000

# å¤åˆ¶å¤‡ä»½å›æ¥
cp -r ../backups/backup-20251010-143000/* /www/wwwroot/my-next-app/  # cp è¡¨ç¤ºå¤åˆ¶æ–‡ä»¶ï¼Œ-r è¡¨ç¤ºé€’å½’å¤åˆ¶ç”¨äºæ–‡ä»¶å¤¹ã€‚è¯¥å‘½ä»¤ç”¨äºæ¢å¤å¤‡ä»½æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•ï¼Œå®ç°å›æ»š
pm2 restart spring-lament-blog
```

---

### æ–¹æ³• 2ï¼šGitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼ˆæœ€æ–¹ä¾¿ â­â­â­ï¼‰

**ä¼˜åŠ¿**ï¼š

- ğŸš€ å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ¨é€ä»£ç å³éƒ¨ç½²
- ğŸ¯ ä¸éœ€è¦ç™»å½•æœåŠ¡å™¨
- ğŸ“Š GitHub å¯è§†åŒ–æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€å’Œæ—¥å¿—
- â±ï¸ èŠ‚çœå¤§é‡æ—¶é—´
- ğŸ **å·²ä¼˜åŒ–**ï¼šåªä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œé€Ÿåº¦å¿« 10-20 å€

**å‰ææ¡ä»¶**ï¼šå·²é…ç½®å¥½ GitHub Secretsï¼ˆè§ä¸‹é¢çš„è¯¦ç»†è¯´æ˜ï¼‰

**ä½¿ç”¨æ­¥éª¤**ï¼š

```bash
# 1. åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç 
git add .
git commit -m "æ·»åŠ æ–°åŠŸèƒ½"

# 2. æ¨é€åˆ° GitHub
git push origin main

# 3. è‡ªåŠ¨éƒ¨ç½²å¼€å§‹ï¼
# GitHub Actions ä¼šè‡ªåŠ¨ï¼š
# - æ£€å‡ºä»£ç 
# - å®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®ï¼ˆåœ¨ GitHub æœåŠ¡å™¨ä¸Šï¼‰
# - åªä¸Šä¼ æ„å»ºåçš„ .nextã€é…ç½®æ–‡ä»¶ç­‰å¿…è¦æ–‡ä»¶ï¼ˆä¸åŒ…æ‹¬ node_modulesï¼‰
# - åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ç”Ÿäº§ä¾èµ–
# - æ¨é€æ•°æ®åº“å˜æ›´
# - é‡å¯åº”ç”¨
```

**âš¡ æ€§èƒ½ä¼˜åŒ–è¯´æ˜**ï¼š

æˆ‘ä»¬çš„éƒ¨ç½²é…ç½®å·²ç»è¿‡ä¼˜åŒ–ï¼Œ**ä¸ä¼šä¸Šä¼  node_modules**ï¼ˆæ•°ä¸‡ä¸ªå°æ–‡ä»¶ï¼‰ï¼Œè€Œæ˜¯ï¼š

1. åœ¨ GitHub Actions æœåŠ¡å™¨ä¸Šæ„å»º
2. åªä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆ`.next`ã€`prisma` ç­‰å¿…è¦æ–‡ä»¶ï¼‰
3. åœ¨æœåŠ¡å™¨ä¸Šé€šè¿‡ `npm ci --production` å®‰è£…ç”Ÿäº§ä¾èµ–

**æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€**ï¼š

1. æ‰“å¼€ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡»é¡¶éƒ¨ **Actions** æ ‡ç­¾
3. æŸ¥çœ‹æœ€æ–°çš„å·¥ä½œæµè¿è¡ŒçŠ¶æ€
   - ğŸŸ¢ ç»¿è‰²å¯¹å‹¾ = éƒ¨ç½²æˆåŠŸ
   - ğŸ”´ çº¢è‰²å‰å· = éƒ¨ç½²å¤±è´¥ï¼Œç‚¹å‡»æŸ¥çœ‹é”™è¯¯æ—¥å¿—
   - ğŸŸ¡ é»„è‰²åœ†åœˆ = æ­£åœ¨éƒ¨ç½²ä¸­

---

### æ–¹æ³• 3ï¼šæ‰‹åŠ¨æ›´æ–°ï¼ˆå®Œå…¨æ‰‹åŠ¨æ§åˆ¶ï¼‰

**ä¼˜åŠ¿**ï¼š

- ğŸ¯ ç²¾ç¡®æ§åˆ¶æ¯ä¸€æ­¥
- ğŸ” é€‚åˆå­¦ä¹ ç†è§£éƒ¨ç½²æµç¨‹
- ğŸ†˜ è‡ªåŠ¨è„šæœ¬å‡ºé—®é¢˜æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

**å®Œæ•´æ­¥éª¤**ï¼š

```bash
# 1. SSH ç™»å½•æœåŠ¡å™¨
ssh root@42.193.227.185

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/my-next-app

# 3. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å¦‚æœæç¤ºå†²çªï¼Œå¼ºåˆ¶è¦†ç›–æœ¬åœ°ä¿®æ”¹ï¼š
git fetch origin
git reset --hard origin/main

# 4. æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ package.json æœ‰å˜åŒ–ï¼‰
npm install

# 5. å¦‚æœä¿®æ”¹äº†æ•°æ®åº“ç»“æ„
# âš ï¸ é‡è¦ï¼šå…ˆåˆ é™¤ .env æ–‡ä»¶
rm .env
npm run db:push

# 6. é‡æ–°æ„å»º
npm run build

# 7. é‡å¯åº”ç”¨ï¼ˆå¦‚æœä¿®æ”¹äº† .env.productionï¼‰
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save

# æˆ–è€…åªæ˜¯é‡å¯ï¼ˆæ²¡æœ‰ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼‰
pm2 restart spring-lament-blog

# 8. éªŒè¯
pm2 status
pm2 logs spring-lament-blog --lines 20
```

---

---

## ğŸ¤– GitHub Actions è‡ªåŠ¨éƒ¨ç½²é…ç½®

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** é…ç½® GitHub Actions å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** GitHub Actions æ˜¯æœ€æ–¹ä¾¿çš„éƒ¨ç½²æ–¹å¼ï¼š

- âœ… æ¨é€ä»£ç åˆ° GitHub åè‡ªåŠ¨éƒ¨ç½²ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… åœ¨ GitHub ç•Œé¢æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€å’Œæ—¥å¿—ï¼Œä¸€ç›®äº†ç„¶
- âœ… èŠ‚çœå¤§é‡æ—¶é—´ï¼Œä¸“æ³¨äºå¼€å‘è€Œéè¿ç»´
- âœ… æ‰€æœ‰éƒ¨ç½²éƒ½æœ‰è®°å½•ï¼Œä¾¿äºè¿½æº¯é—®é¢˜

GitHub Actions å¯ä»¥å®ç°ï¼šæ¯æ¬¡æ¨é€ä»£ç åˆ° GitHubï¼Œè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚

---

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º GitHub Actions å·¥ä½œæµæ–‡ä»¶

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** åˆ›å»ºè‡ªåŠ¨éƒ¨ç½²çš„é…ç½®æ–‡ä»¶

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** å·¥ä½œæµæ–‡ä»¶å®šä¹‰äº†è‡ªåŠ¨éƒ¨ç½²çš„å®Œæ•´æµç¨‹ï¼ˆæ‹‰å–ä»£ç ã€æ„å»ºã€ä¸Šä¼ ã€é‡å¯ç­‰ï¼‰ï¼ŒGitHub Actions ä¼šæŒ‰ç…§è¿™ä¸ªæ–‡ä»¶æ‰§è¡Œéƒ¨ç½²

åœ¨**æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•**ä¸‹åˆ›å»ºå·¥ä½œæµé…ç½®æ–‡ä»¶ã€‚

#### 1. åˆ›å»ºç›®å½•ç»“æ„

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
mkdir -p .github/workflows
```

#### 2. åˆ›å»ºå·¥ä½œæµæ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ `.github/workflows/deploy.yml`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
name: Deploy Next.js

on:
  push:
    branches:
      - main # åªåœ¨ main åˆ†æ”¯ä¸Šè§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22 # ä½¿ç”¨ Node.js 22

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }} # æœåŠ¡å™¨ IP æˆ–åŸŸå
          username: ${{ secrets.SSH_USERNAME }} # SSH ç”¨æˆ·å
          key: ${{ secrets.SSH_PRIVATE_KEY }} # SSH ç§é’¥
          source: "." # ä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•
          target: "/www/wwwroot/my-next-app" # æœåŠ¡å™¨ä¸Šçš„ç›®æ ‡ç›®å½•

      - name: Install dependencies on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /www/wwwroot/my-next-app
            npm install --production

      - name: Restart PM2 process
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /www/wwwroot/my-next-app
            pm2 restart ecosystem.config.js --env production
```

**å·¥ä½œæµè¯´æ˜**ï¼š

- `on.push.branches`: å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
- `Checkout code`: æ‹‰å–ä»£ç 
- `Set up Node.js`: é…ç½® Node.js ç¯å¢ƒ
- `Install dependencies`: å®‰è£…ä¾èµ–
- `Build project`: æ„å»ºé¡¹ç›®
- `Deploy to Server`: å°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ°æœåŠ¡å™¨
- `Install dependencies on server`: åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ç”Ÿäº§ä¾èµ–
- `Restart PM2 process`: é‡å¯ PM2 è¿›ç¨‹

---

### ç¬¬äºŒæ­¥ï¼šé…ç½® GitHub Secrets

**ğŸ“‹ æœ¬æ­¥éª¤ç›®æ ‡ï¼š** åœ¨ GitHub ä»“åº“ä¸­é…ç½®æœåŠ¡å™¨è¿æ¥ä¿¡æ¯

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** GitHub Actions éœ€è¦çŸ¥é“æœåŠ¡å™¨çš„ IPã€ç”¨æˆ·åã€SSH å¯†é’¥ç­‰ä¿¡æ¯ï¼Œæ‰èƒ½è¿æ¥åˆ°æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²ã€‚è¿™äº›æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ GitHub Secrets ä¸­ï¼Œå®‰å…¨ä¸”ä¸ä¼šæš´éœ²åœ¨ä»£ç é‡Œ

#### æ·»åŠ  Secrets çš„ä½ç½®

1. æ‰“å¼€ä½ çš„ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡» `Settings`ï¼ˆè®¾ç½®ï¼‰æ ‡ç­¾
3. å·¦ä¾§èœå•ç‚¹å‡» `Secrets and variables` â†’ `Actions`
4. ç‚¹å‡» `New repository secret` æŒ‰é’®

![æ·»åŠ GitHub Secrets](https://www.zhiboblog.com/wp-content/uploads/2025/01/19.png)

![Secretsé…ç½®ç•Œé¢](https://www.zhiboblog.com/wp-content/uploads/2025/01/20.png)

---

#### éœ€è¦é…ç½®çš„ Secrets

### 1ï¸âƒ£ SERVER_HOSTï¼ˆæœåŠ¡å™¨ IPï¼‰

**å€¼**ï¼š`42.193.227.185`

**å¦‚ä½•è·å–**ï¼š

- è¿™æ˜¯ä½ çš„**è…¾è®¯äº‘æœåŠ¡å™¨ IP åœ°å€**
- åœ¨è…¾è®¯äº‘æ§åˆ¶å° â†’ äº‘æœåŠ¡å™¨ â†’ å®ä¾‹åˆ—è¡¨ä¸­æŸ¥çœ‹
- æˆ–è€…åœ¨å®å¡”é¢æ¿å³ä¸Šè§’å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨ IP

---

### 2ï¸âƒ£ SERVER_USERï¼ˆSSH ç”¨æˆ·åï¼‰

**å€¼**ï¼š`root`

**è¯´æ˜**ï¼š

- æœåŠ¡å™¨çš„ SSH ç™»å½•ç”¨æˆ·å
- é€šå¸¸æ˜¯ `root`ï¼ˆLinux æœ€é«˜æƒé™ç”¨æˆ·ï¼‰
- å¦‚æœä½¿ç”¨å…¶ä»–ç”¨æˆ·ï¼Œå¡«å†™å¯¹åº”çš„ç”¨æˆ·å

---

### 3ï¸âƒ£ SERVER_SSH_KEYï¼ˆSSH ç§é’¥ï¼‰

> ğŸ’¡ **å¦‚ä½•è·å–**ï¼šå‚è€ƒå‰é¢ [ğŸ”‘ GitHub ä»“åº“å’Œ SSH é…ç½® â†’ 4. é…ç½® GitHub Actions çš„ SSH å¯†é’¥](#ğŸ”‘-github-ä»“åº“å’Œ-ssh-é…ç½®) ç« èŠ‚

**ç®€è¦æ­¥éª¤**ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹å·²ç”Ÿæˆçš„ç§é’¥
cat ~/.ssh/github_actions_rsa

# å¦‚æœè¿˜æ²¡ç”Ÿæˆï¼Œè¿è¡Œï¼š
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy" -f ~/.ssh/github_actions_rsa
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

![æŸ¥çœ‹SSHç§é’¥](https://www.zhiboblog.com/wp-content/uploads/2025/01/21.png)

**éœ€è¦å¤åˆ¶çš„å†…å®¹æ ¼å¼**ï¼š

```
-----BEGIN OPENSSH PRIVATE KEY-----
ï¼ˆå®Œæ•´çš„ç§é’¥å†…å®¹ï¼ŒåŒ…æ‹¬æ‰€æœ‰è¡Œï¼‰
-----END OPENSSH PRIVATE KEY-----
```

**âš ï¸ é‡è¦**ï¼š

- å¿…é¡»å¤åˆ¶**å®Œæ•´å†…å®¹**ï¼ŒåŒ…æ‹¬ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œ
- è¿™æ˜¯å‰é¢ç”Ÿæˆçš„ `github_actions_rsa` **ç§é’¥**ï¼ˆä¸æ˜¯å…¬é’¥ï¼‰

---

### 4ï¸âƒ£ SERVER_PORTï¼ˆSSH ç«¯å£ï¼‰

**å€¼**ï¼š`22`

**è¯´æ˜**ï¼š

- SSH é»˜è®¤ç«¯å£æ˜¯ `22`
- å¦‚æœä½ ä¿®æ”¹è¿‡ SSH ç«¯å£ï¼Œå¡«å†™ä¿®æ”¹åçš„ç«¯å£å·
- åœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹ï¼š`cat /etc/ssh/sshd_config | grep Port`

---

### 5ï¸âƒ£ DATABASE_URLï¼ˆæ•°æ®åº“è¿æ¥ï¼‰

**SQLiteï¼ˆç®€å•ï¼‰**ï¼š

```
file:./prod.db
```

**PostgreSQLï¼ˆæ¨èç”Ÿäº§ï¼‰**ï¼š

```
postgresql://ç”¨æˆ·å:å¯†ç @localhost:5432/æ•°æ®åº“å?schema=public
```

**ç¤ºä¾‹**ï¼š

```
postgresql://blog_user:MyStr0ngP@ssw0rd@localhost:5432/spring_lament_blog?schema=public
```

**å¦‚ä½•è·å–**ï¼š

- è¿™æ˜¯ä½ åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ•°æ®åº“æ—¶è®¾ç½®çš„
- ç”¨æˆ·åå’Œå¯†ç æ˜¯ä½ è‡ªå·±å®šä¹‰çš„
- å¦‚æœå¿˜è®°äº†ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨çš„ `.env.production` æ–‡ä»¶ä¸­æŸ¥çœ‹

---

### 6ï¸âƒ£ NEXTAUTH_SECRETï¼ˆNextAuth å¯†é’¥ï¼‰

**å¦‚ä½•ç”Ÿæˆ**ï¼š

åœ¨**æœåŠ¡å™¨ä¸Š**æˆ–**æœ¬åœ°ç»ˆç«¯**è¿è¡Œï¼š

```bash
openssl rand -base64 32
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX
```

**âš ï¸ æ³¨æ„**ï¼š

- è¿™æ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„å¼ºå¯†é’¥
- ç”¨äºåŠ å¯†ç”¨æˆ·ä¼šè¯ï¼Œå¿…é¡»ä¿å¯†
- å¤åˆ¶ç”Ÿæˆçš„å­—ç¬¦ä¸²ä½œä¸º Secret å€¼

---

### 7ï¸âƒ£ NEXTAUTH_URLï¼ˆç½‘ç«™åœ°å€ï¼‰

**å€¼**ï¼š`http://powder.icu`

**è¯´æ˜**ï¼š

- ä½ çš„ç½‘ç«™å®Œæ•´åœ°å€
- HTTP ç‰ˆæœ¬ï¼š`http://powder.icu`
- HTTPS ç‰ˆæœ¬ï¼ˆé…ç½® SSL åï¼‰ï¼š`https://powder.icu`
- **âš ï¸ æœ«å°¾ä¸è¦åŠ æ–œæ ï¼**

---

### ğŸ“ æ·»åŠ  Secrets çš„æ­¥éª¤

1. æ‰“å¼€ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡» `Settings`ï¼ˆè®¾ç½®ï¼‰
3. å·¦ä¾§èœå•ç‚¹å‡» `Secrets and variables` â†’ `Actions`
4. ç‚¹å‡» `New repository secret` æŒ‰é’®
5. å¡«å†™ï¼š
   - **Name**ï¼šSecret åç§°ï¼ˆå¦‚ `SERVER_HOST`ï¼‰
   - **Secret**ï¼šå¯¹åº”çš„å€¼ï¼ˆå¦‚ `42.193.227.185`ï¼‰
6. ç‚¹å‡» `Add secret` ä¿å­˜
7. é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œæ·»åŠ æ‰€æœ‰ 7 ä¸ª Secrets

---

### âœ… é…ç½®å®Œæˆæ£€æŸ¥

æ·»åŠ å®Œæ‰€æœ‰ Secrets åï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
SERVER_HOST
SERVER_USER
SERVER_SSH_KEY
SERVER_PORT
DATABASE_URL
NEXTAUTH_SECRET
NEXTAUTH_URL
```

---

### ğŸ“¤ æ¨é€å·¥ä½œæµæ–‡ä»¶åˆ° GitHub

åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°† GitHub Actions å·¥ä½œæµæ–‡ä»¶æ¨é€åˆ° GitHubï¼š

```bash
# 1. æ·»åŠ å·¥ä½œæµæ–‡ä»¶
git add .github/workflows/deploy.yml

# 2. æäº¤
git commit -m "æ·»åŠ  GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ"

# 3. æ¨é€åˆ° GitHub
git push origin main
```

æ¨é€åï¼ŒGitHub Actions ä¼šè‡ªåŠ¨è§¦å‘ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼

---

### ğŸ” æŸ¥çœ‹ GitHub Actions æ‰§è¡Œç»“æœ

é…ç½®å®Œæˆåï¼Œæ¯æ¬¡æ¨é€ä»£ç åˆ° main åˆ†æ”¯ï¼ŒGitHub Actions éƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²ã€‚

**æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€çš„æ­¥éª¤**ï¼š

1. æ‰“å¼€ä½ çš„ GitHub ä»“åº“é¡µé¢
2. ç‚¹å‡»é¡¶éƒ¨çš„ **Actions** æ ‡ç­¾
3. ä½ ä¼šçœ‹åˆ°å·¥ä½œæµè¿è¡Œåˆ—è¡¨ï¼Œæ˜¾ç¤ºæ¯æ¬¡éƒ¨ç½²çš„çŠ¶æ€

![æŸ¥çœ‹GitHub Actionsæ‰§è¡Œç»“æœ](https://www.zhiboblog.com/wp-content/uploads/2025/01/22.png)

**çŠ¶æ€è¯´æ˜**ï¼š

- ğŸŸ¢ **ç»¿è‰²å¯¹å‹¾ï¼ˆâœ“ï¼‰**ï¼šéƒ¨ç½²æˆåŠŸï¼ä½ çš„ä»£ç å·²ç»æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨
- ğŸ”´ **çº¢è‰²å‰å·ï¼ˆâœ—ï¼‰**ï¼šéƒ¨ç½²å¤±è´¥ï¼Œç‚¹å‡»è¿›å…¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
- ğŸŸ¡ **é»„è‰²åœ†åœˆ**ï¼šæ­£åœ¨éƒ¨ç½²ä¸­ï¼Œè¯·ç¨ç­‰...

**æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**ï¼š

1. ç‚¹å‡»æŸæ¬¡å·¥ä½œæµè¿è¡Œï¼ˆç‚¹å‡»å·¥ä½œæµåç§°ï¼‰
2. ç‚¹å‡» `build-and-deploy` ä»»åŠ¡
3. å±•å¼€æ¯ä¸ªæ­¥éª¤ï¼ˆå¦‚ "Build project"ã€"Deploy to Server" ç­‰ï¼‰
4. æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†è¾“å‡ºæ—¥å¿—

å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ä¼šåœ¨ç›¸åº”çš„æ­¥éª¤ä¸­æ˜¾ç¤ºï¼Œå¸®åŠ©ä½ å¿«é€Ÿå®šä½é—®é¢˜ã€‚

---

### ğŸ‰ è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼

é…ç½®å®Œæˆåï¼Œä½ çš„å¼€å‘æµç¨‹å˜å¾—éå¸¸ç®€å•ï¼š

```bash
# 1. åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç 
# ... ç¼–è¾‘æ–‡ä»¶ ...

# 2. æäº¤å¹¶æ¨é€
git add .
git commit -m "æ·»åŠ æ–°åŠŸèƒ½ï¼šæ–‡ç« è¯„è®ºç³»ç»Ÿ"
git push origin main

# 3. GitHub Actions è‡ªåŠ¨æ‰§è¡Œï¼š
#    âœ… æ£€å‡ºä»£ç 
#    âœ… å®‰è£… Node.js ç¯å¢ƒ
#    âœ… å®‰è£…ä¾èµ–
#    âœ… æ„å»ºé¡¹ç›®
#    âœ… ä¸Šä¼ åˆ°æœåŠ¡å™¨
#    âœ… åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ç”Ÿäº§ä¾èµ–
#    âœ… é‡å¯ PM2 è¿›ç¨‹

# 4. å‡ åˆ†é’Ÿåï¼Œè®¿é—®ç½‘ç«™æŸ¥çœ‹æ›´æ–°ï¼
```

**ä¼˜åŠ¿**ï¼š

- âœ… **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šæ¨é€ä»£ç å³éƒ¨ç½²ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… **çœæ—¶çœåŠ›**ï¼šä¸ç”¨å† SSH ç™»å½•æœåŠ¡å™¨æ‰§è¡Œä¸€å †å‘½ä»¤
- âœ… **å¯è§†åŒ–ç›‘æ§**ï¼šåœ¨ GitHub Actions ç•Œé¢å®æ—¶æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
- âœ… **è®°å½•å®Œæ•´**ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤šäººå¼€å‘æ—¶ï¼Œæ¯ä¸ªäººæ¨é€ä»£ç éƒ½ä¼šè‡ªåŠ¨éƒ¨ç½²

**å†ä¹Ÿä¸ç”¨æ‰‹åŠ¨éƒ¨ç½²äº†ï¼** ğŸš€

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** å­¦ä¼šæ’æŸ¥å’Œè§£å†³éƒ¨ç½²è¿‡ç¨‹ä¸­çš„å¸¸è§é—®é¢˜

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** éƒ¨ç½²è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å„ç§é—®é¢˜ï¼Œäº†è§£å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆå¯ä»¥å¸®ä½ å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ï¼Œé¿å…æµªè´¹æ—¶é—´

---

### GitHub Actions éƒ¨ç½²å¤±è´¥ âŒ

**å¦‚ä½•æŸ¥çœ‹è¯¦ç»†é”™è¯¯**ï¼š

1. æ‰“å¼€ GitHub ä»“åº“ â†’ **Actions** æ ‡ç­¾
2. ç‚¹å‡»å¤±è´¥çš„å·¥ä½œæµï¼ˆçº¢è‰²å‰å·ï¼‰
3. ç‚¹å‡» **build-and-deploy** ä»»åŠ¡
4. å±•å¼€å¤±è´¥çš„æ­¥éª¤ï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**ï¼š

#### 1. SSH è¿æ¥å¤±è´¥

```
Error: connect ECONNREFUSED
```

**åŸå› **ï¼šæœåŠ¡å™¨ IPã€ç«¯å£æˆ– SSH å¯†é’¥é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

- æ£€æŸ¥ GitHub Secrets ä¸­çš„ `SERVER_HOST`ã€`SERVER_PORT`ã€`SERVER_SSH_KEY` æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æœåŠ¡å™¨é˜²ç«å¢™å…è®¸ SSH è¿æ¥ï¼ˆç«¯å£ 22ï¼‰
- æµ‹è¯• SSH è¿æ¥ï¼š`ssh root@ä½ çš„æœåŠ¡å™¨IP`

#### 2. æƒé™è¢«æ‹’ç»

```
Permission denied (publickey)
```

**åŸå› **ï¼šSSH ç§é’¥æœªæ­£ç¡®æ·»åŠ åˆ°æœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

#### 3. npm ci å¤±è´¥

```
npm error code ELIFECYCLE
```

**åŸå› **ï¼šä¾èµ–å®‰è£…å¤±è´¥æˆ– Node ç‰ˆæœ¬ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# ç™»å½•æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP
cd /www/wwwroot/my-next-app

# æ¸…ç†å¹¶é‡æ–°å®‰è£…
rm -rf node_modules package-lock.json
npm install
npm run build
pm2 restart spring-lament-blog
```

#### 4. æ•°æ®åº“é”™è¯¯

```
Error: P1001: Can't reach database server
```

**åŸå› **ï¼šæœåŠ¡å™¨ä¸Šçš„ `.env.production` æ–‡ä»¶ä¸å­˜åœ¨æˆ–é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# ç™»å½•æœåŠ¡å™¨ï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
cd /www/wwwroot/my-next-app
cat .env.production  # æŸ¥çœ‹é…ç½®

# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
nano .env.production
# æŒ‰ç…§å‰é¢ç« èŠ‚çš„è¯´æ˜å¡«å…¥é…ç½®
```

### 502 Bad Gateway

```bash
pm2 status
pm2 logs spring-lament-blog --err --lines 50
pm2 restart spring-lament-blog
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
cat .env.production  # æ£€æŸ¥é…ç½®
npm run db:push      # æµ‹è¯•è¿æ¥
```

### ç«¯å£ 80 è¢«å ç”¨

```bash
lsof -i :80          # æŸ¥çœ‹å ç”¨è¿›ç¨‹
kill -9 [PID]        # ç»“æŸè¿›ç¨‹
```

### npm install å¤±è´¥

```bash
rm -rf node_modules .next
npm cache clean --force
npm install
```

### GitHub Actions éƒ¨ç½²å¾ˆæ…¢ï¼ˆè¶…è¿‡ 10 åˆ†é’Ÿï¼‰

**åŸå› **ï¼šå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–é…ç½®æœªä¼˜åŒ–

**æ£€æŸ¥è¦ç‚¹**ï¼š

1. ç¡®ä¿ `.github/workflows/deploy.yml` ä¸­çš„ `source` å‚æ•°**ä¸åŒ…å« `node_modules`**
2. åº”è¯¥åªä¸Šä¼ ï¼š`.next,package.json,package-lock.json,prisma,public,...`
3. æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´ï¼š`df -h`
4. æ£€æŸ¥æœåŠ¡å™¨å†…å­˜ï¼š`free -h`

**å¦‚æœä»ç„¶å¾ˆæ…¢**ï¼š

```bash
# ç™»å½•æœåŠ¡å™¨ï¼Œæ‰‹åŠ¨æ¸…ç†æ—§æ–‡ä»¶
cd /www/wwwroot/my-next-app
rm -rf .next.backup node_modules/.cache
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** æä¾›å®Œæ•´çš„éƒ¨ç½²æ£€æŸ¥æ¸…å•ï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•æ­¥éª¤

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** éƒ¨ç½²æ¶‰åŠå¾ˆå¤šæ­¥éª¤ï¼Œä½¿ç”¨æ£€æŸ¥æ¸…å•å¯ä»¥ï¼š

- âœ… ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½å®Œæˆäº†
- âœ… å¿«é€Ÿå®šä½é—æ¼çš„é…ç½®
- âœ… é€‚åˆæ–°æ‰‹è·Ÿéšï¼Œé¿å…å‡ºé”™
- âœ… ä½œä¸ºéƒ¨ç½²æ–‡æ¡£çš„å¿«é€Ÿå‚è€ƒ

---

### ğŸ”§ æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

- [ ] æœåŠ¡å™¨å·²å®‰è£… Node.js 20.xï¼ˆé€šè¿‡å®å¡”é¢æ¿æˆ–å‘½ä»¤è¡Œï¼‰
- [ ] æœåŠ¡å™¨å·²å®‰è£… PM2
- [ ] å·²åˆ›å»ºé¡¹ç›®ç›®å½• `/www/wwwroot/my-next-app`
- [ ] åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨ IP

### ğŸ”‘ GitHub å’Œ SSH é…ç½®

- [ ] å·²åˆ›å»º GitHub ä»“åº“
- [ ] æœ¬åœ°ä»£ç å·²æ¨é€åˆ° GitHub
- [ ] æœåŠ¡å™¨ SSH å¯†é’¥å·²ç”Ÿæˆ
- [ ] æœåŠ¡å™¨å…¬é’¥å·²æ·»åŠ åˆ° GitHubï¼ˆç”¨äºæ‹‰å–ä»£ç ï¼‰
- [ ] GitHub Actions SSH å¯†é’¥å·²ç”Ÿæˆï¼ˆç”¨äºè‡ªåŠ¨éƒ¨ç½²ï¼‰
- [ ] 7 ä¸ª GitHub Secrets å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼‰

### ğŸ“¦ é¦–æ¬¡éƒ¨ç½²

- [ ] ä»£ç å·²å…‹éš†åˆ°æœåŠ¡å™¨
- [ ] `.env.production` å·²åˆ›å»ºå¹¶é…ç½®
- [ ] ç¡®è®¤æ²¡æœ‰ `.env` æ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼‰
- [ ] ä¾èµ–å·²å®‰è£…ï¼ˆ`npm install`ï¼‰
- [ ] Prisma Client å·²ç”Ÿæˆï¼ˆ`npm run db:generate`ï¼‰
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆ`npm run db:push` å’Œ `npm run db:seed`ï¼‰
- [ ] é¡¹ç›®å·²æ„å»ºï¼ˆ`npm run build`ï¼‰
- [ ] PM2 å·²å¯åŠ¨ï¼ˆ`pm2 start ecosystem.config.js`ï¼‰
- [ ] PM2 å·²ä¿å­˜ï¼ˆ`pm2 save`ï¼‰
- [ ] PM2 å¼€æœºè‡ªå¯å·²è®¾ç½®ï¼ˆ`pm2 startup`ï¼‰

### âœ… éªŒè¯æµ‹è¯•

- [ ] PM2 çŠ¶æ€ä¸º onlineï¼ˆ`pm2 status`ï¼‰
- [ ] æœ¬åœ°æµ‹è¯•å¯è®¿é—®ï¼ˆ`curl http://localhost:3000`ï¼‰
- [ ] ç½‘ç«™é¦–é¡µå¯ä»¥è®¿é—®ï¼ˆhttp://powder.icuï¼‰
- [ ] åå°å¯ä»¥è®¿é—®ï¼ˆhttp://powder.icu/adminï¼‰
- [ ] å¯ä»¥ç™»å½•åå°ï¼ˆè´¦å·ï¼šadmin / 0919ï¼‰
- [ ] å·²ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 

### ğŸš€ å¯é€‰ä¼˜åŒ–

- [ ] Nginx åå‘ä»£ç†å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆHTTPSï¼‰
- [ ] GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·²æµ‹è¯•
- [ ] å®å¡”é¢æ¿ PM2 ç®¡ç†ç•Œé¢å·²é…ç½®
- [ ] å¤–ç½‘æ˜ å°„å·²å¼€å¯ï¼ˆå®å¡”é¢æ¿ï¼‰

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

**ğŸ“‹ æœ¬ç« ç›®æ ‡ï¼š** äº†è§£éƒ¨ç½²è¿‡ç¨‹ä¸­çš„å…³é”®æ³¨æ„äº‹é¡¹ï¼Œé¿å…å¸¸è§é”™è¯¯

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ï¼š** è¿™äº›æ˜¯å®è·µä¸­æ€»ç»“çš„é‡è¦ç»éªŒï¼Œäº†è§£è¿™äº›å¯ä»¥é¿å…å¾ˆå¤šå‘ï¼ŒèŠ‚çœå¤§é‡æ’é”™æ—¶é—´

---

### 1. ç¯å¢ƒå˜é‡æ–‡ä»¶ç®¡ç†

> **ğŸ”´ é‡è¦ï¼šç”Ÿäº§ç¯å¢ƒä¸è¦æœ‰ `.env` æ–‡ä»¶ï¼**

- **æœ¬åœ°å¼€å‘**ï¼šä½¿ç”¨ `.env.local`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šåªç”¨ `.env.production`

**åŸå› **ï¼šPrisma ä¼˜å…ˆè¯»å– `.env`ï¼Œå¦‚æœå­˜åœ¨ä¼šå¿½ç•¥ `.env.production`ï¼Œå¯¼è‡´æ•°æ®åº“æ“ä½œé”™è¯¯ã€‚

```bash
# æœåŠ¡å™¨ä¸Šæ£€æŸ¥
cd /www/wwwroot/my-next-app
ls -la .env*       # åº”è¯¥åªæœ‰ .env.production
rm .env            # å¦‚æœå­˜åœ¨å°±åˆ é™¤
```

### 2. NextAuth URL é…ç½®

- âœ… æ­£ç¡®ï¼š`NEXTAUTH_URL="http://powder.icu"`ï¼ˆæœ«å°¾ä¸è¦åŠ æ–œæ ï¼‰
- âŒ é”™è¯¯ï¼š`NEXTAUTH_URL="http://powder.icu/"`

### 3. PM2 ç¯å¢ƒå˜é‡æ›´æ–°

ä¿®æ”¹ `.env.production` åï¼Œå¿…é¡»**å®Œå…¨é‡å¯**ï¼š

```bash
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save
```

**ä¸è¦ç”¨** `pm2 restart`ï¼å› ä¸º restart ä¸ä¼šé‡æ–°åŠ è½½ç¯å¢ƒå˜é‡ã€‚

### 4. æ•°æ®åº“è¿ç§»æ³¨æ„

å¦‚æœä¿®æ”¹äº† Prisma schemaï¼Œæ›´æ–°æ—¶éœ€è¦ï¼š

```bash
npm run db:generate  # ç”Ÿæˆæ–°çš„ Prisma Client
npm run db:push      # æ¨é€æ•°æ®åº“å˜æ›´
npm run build        # é‡æ–°æ„å»º
pm2 restart spring-lament-blog
```

### 5. æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶

å¦‚æœéœ€è¦ä¸Šä¼ å¤§æ–‡ä»¶ï¼Œè®°å¾—åœ¨ Nginx é…ç½®ä¸­è®¾ç½®ï¼š

```nginx
client_max_body_size 50M;  # æ ¹æ®éœ€æ±‚è°ƒæ•´
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Next.js å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs)
- [Prisma å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs)
- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/docs)
- [å®å¡”é¢æ¿æ–‡æ¡£](https://www.bt.cn/bbs/forum-39-1.html)
