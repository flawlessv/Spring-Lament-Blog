---
created: 2025-11-03T10:33:43 (UTC +08:00)
tags:
  [
    å‰ç«¯,
    JavaScriptä¸­æ–‡æŠ€æœ¯ç¤¾åŒº,
    å‰ç«¯å¼€å‘ç¤¾åŒº,
    å‰ç«¯æŠ€æœ¯äº¤æµ,
    å‰ç«¯æ¡†æ¶æ•™ç¨‹,
    JavaScript å­¦ä¹ èµ„æº,
    CSS æŠ€å·§ä¸æœ€ä½³å®è·µ,
    HTML5 æœ€æ–°åŠ¨æ€,
    å‰ç«¯å·¥ç¨‹å¸ˆèŒä¸šå‘å±•,
    å¼€æºå‰ç«¯é¡¹ç›®,
    å‰ç«¯æŠ€æœ¯è¶‹åŠ¿,
  ]
source: https://juejin.cn/post/7326803868326592539?searchId=202511031024380A7BF1F3E50798995A63
author: æš®æ˜Ÿ
---

# ã€Event Loopã€‘æµè§ˆå™¨ä¸ Node.js äº‹ä»¶å¾ªç¯è¯¦è§£äº‹ä»¶å¾ªç¯æ˜¯å®¿ä¸»ç¯å¢ƒå¤„ç† JS å¼‚æ­¥æ“ä½œï¼Œè®©å…¶èƒ½å¤Ÿéé˜»å¡å¼è¿ - æ˜é‡‘

> ## Excerpt
>
> äº‹ä»¶å¾ªç¯æ˜¯å®¿ä¸»ç¯å¢ƒå¤„ç† JS å¼‚æ­¥æ“ä½œï¼Œè®©å…¶èƒ½å¤Ÿéé˜»å¡å¼è¿è¡Œçš„æœºåˆ¶ã€‚ä¸åŒå®¿ä¸»ç¯å¢ƒå¯¹äº‹ä»¶å¾ªç¯çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œæ¥ä¸‹æ¥ï¼Œæœ¬æ–‡å°†è¯¦ç»†æè¿° JS åœ¨æµè§ˆå™¨å’Œ Node.js è¿™ä¸¤ä¸ªå®¿ä¸»ç¯å¢ƒä¸­çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚

---

## å•çº¿ç¨‹çš„ JavaScript

### åŒæ­¥ä¸å¼‚æ­¥

JavaScript åœ¨è®¾è®¡ä¹‹åˆæ˜¯ä½œä¸º**æµè§ˆå™¨è„šæœ¬è¯­è¨€**ï¼Œä¸»è¦ç”¨äºä¸ç”¨æˆ·è¿›è¡Œ**é¡µé¢äº¤äº’**å’Œ**æ“çºµ DOM**ã€‚å› æ­¤ï¼Œä¸ºé¿å…ç”±ä¸å¯é¢„æµ‹çš„ç”¨æˆ·æ“ä½œå¯èƒ½å¸¦æ¥çš„å¤æ‚çš„å¹¶å‘é—®é¢˜ï¼ŒJavaScript åªèƒ½è®¾è®¡æˆ**å•çº¿ç¨‹**çš„ï¼Œè¿™ä¹Ÿæ˜¯è¿™é—¨è¯­è¨€çš„æ ¸å¿ƒç‰¹å¾ä¹‹ä¸€ã€‚

> JS çš„å®¿ä¸»ç¯å¢ƒé€šè¿‡ä»…æä¾›ä¸€ä¸ªçº¿ç¨‹è¿è¡Œ JS æ¥ä¿è¯ JS ä»£ç çš„å•çº¿ç¨‹è¿è¡Œã€‚

å•çº¿ç¨‹æ„å‘³ç€ JS å¼•æ“åœ¨åŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹æƒ…ï¼Œå³**åŒæ­¥**åœ°æ‰§è¡Œä»£ç ã€‚ä½†åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å¯é¿å…åœ°ä¼šé‡åˆ°ä¸€äº›**æ— æ³•ç«‹å³æ‰§è¡Œ**çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- è®¡æ—¶å™¨åˆ°è¾¾æ—¶é—´åè¦æ‰§è¡Œçš„ä»»åŠ¡ --- `setInterval`ã€`setTimeout`
- ç½‘ç»œè¯·æ±‚å®Œæˆåè¦æ‰§è¡Œçš„ä»»åŠ¡ --- `XMLHttpRequest`ã€`Fetch`
- ç›‘å¬åˆ°ç”¨æˆ·æ“ä½œåè¦æ‰§è¡Œçš„ä»»åŠ¡ --- `addEventListener`
- ... ... ...

å¦‚æœè®©æ‰§è¡Œ JS çš„çº¿ç¨‹å»å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œå°±ä¼šå¯¼è‡´è¯¥çº¿ç¨‹å¤„äº**é•¿æœŸé˜»å¡**çš„çŠ¶æ€ï¼Œè€Œå®¿ä¸»ç¯å¢ƒä¸­çš„ JS æ‰§è¡Œçº¿ç¨‹å¾€å¾€è¿˜æ‰¿æ‹…ç€æå…¶é‡è¦çš„å·¥ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼Œå¦‚æœæ‰§è¡Œ JS çš„çº¿ç¨‹é•¿æœŸé˜»å¡ï¼Œå°±ä¼šå¯¼è‡´æµè§ˆå™¨å¡æ­»ï¼

ä¸ºé¿å…ä¸Šè¿°æƒ…å†µå‘ç”Ÿï¼ŒJS çš„å®¿ä¸»ç¯å¢ƒä½¿ç”¨äº†**å¼‚æ­¥**çš„æ–¹å¼æ¥å¤„ç†è¿™ç§æ— æ³•ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ã€‚

å½“é‡åˆ°å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œå®¿ä¸»ç¯å¢ƒä¼šå°†å…¶äº¤ç»™**å…¶ä»–çº¿ç¨‹**å¤„ç†ï¼Œæ‰§è¡Œ JS çš„çº¿ç¨‹åˆ™ä¼šç«‹å³ç»“æŸå½“å‰ä»»åŠ¡è½¬è€Œå»æ‰§è¡Œåç»­ä»£ç ã€‚

### äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯æ˜¯å®¿ä¸»ç¯å¢ƒå¤„ç† JS å¼‚æ­¥æ“ä½œï¼Œè®©å…¶èƒ½å¤Ÿ**éé˜»å¡å¼è¿è¡Œ**çš„æœºåˆ¶ã€‚

ä¸åŒå®¿ä¸»ç¯å¢ƒå¯¹äº‹ä»¶å¾ªç¯çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä¸è¿‡åœ¨æ ¸å¿ƒæœºåˆ¶ä¸Šå¤§åŒå°å¼‚ã€‚

æ¥ä¸‹æ¥ï¼Œæœ¬æ–‡å°†è¯¦ç»†æè¿° JavaScript åœ¨**æµè§ˆå™¨**å’Œ **Node.js** è¿™ä¸¤ä¸ªå®¿ä¸»ç¯å¢ƒä¸­çš„äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚

## æµè§ˆå™¨äº‹ä»¶å¾ªç¯

### æµ…è°ˆæµè§ˆå™¨

èŠæµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¯´è¯´æµè§ˆå™¨æœ¬èº«ã€‚

ç°ä»£æµè§ˆå™¨æ˜¯ä¸€ä¸ª**å¤šè¿›ç¨‹å¤šçº¿ç¨‹**çš„åº”ç”¨ç¨‹åºï¼Œå†…éƒ¨å·¥ä½œæå…¶å¤æ‚ï¼Œå…¶ç¨‹åº¦ç›´é€¼æ“ä½œç³»ç»Ÿã€‚å®ƒæ‹¥æœ‰æ•°ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œä¸ºé¿å…å•ä¸ªæ¨¡å—å´©æºƒç‰µè¿å…¶ä»–æ¨¡å—ï¼Œå¯¼è‡´è¿é”ååº”ï¼Œä½¿æµè§ˆå™¨å½»åº•å´©æºƒã€‚æµè§ˆå™¨åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå¼€å¯å¤šä¸ªè¿›ç¨‹ï¼ŒæŠŠä¸åŒçš„åŠŸèƒ½æ¨¡å—æ”¾åœ¨**ä¸åŒçš„è¿›ç¨‹**é‡Œã€‚

![è°·æ­Œæµè§ˆå™¨æ¶æ„.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce3a90c15bd74f5b9513c2c2bfb9030d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1518&h=1022&s=186040&e=png&b=fcf5f3)

æµè§ˆå™¨è¿›ç¨‹ä¼—å¤šï¼Œå…¶ä¸­æ¯”è¾ƒ**é‡è¦**çš„æœ‰ï¼š

ğŸ“š æµè§ˆå™¨è¿›ç¨‹

æµè§ˆå™¨è¿›ç¨‹æ˜¯æµè§ˆå™¨çš„**ä¸»è¿›ç¨‹**ï¼Œæ— è®ºæ‰“å¼€å¤šå°‘æµè§ˆå™¨çª—å£ï¼Œå®ƒä»…æœ‰**ä¸€ä¸ª**ã€‚

å®ƒä¸»è¦è´Ÿè´£æµè§ˆå™¨**ç•Œé¢æ˜¾ç¤º**ã€**ç”¨æˆ·äº¤äº’**å’Œ**è¿›ç¨‹ç®¡ç†**ã€‚

> è¿™é‡Œè¯´çš„ç•Œé¢å’Œäº¤äº’ï¼Œä¸æ˜¯è§†çª—å†…çš„ç½‘ç«™ç•Œé¢ã€‚è€Œæ˜¯æŒ‡æµè§ˆå™¨æœ¬èº«è‡ªå¸¦çš„éƒ¨åˆ†ï¼Œå¦‚å¯¼èˆªæ ã€ä¹¦ç­¾æ ã€åˆ·æ–°æŒ‰é’®ç­‰ã€‚

åˆšæ‰“å¼€æµè§ˆå™¨çš„æ—¶å€™åªæœ‰ä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒåˆ›å»ºçš„ã€‚

ğŸ“š ç½‘ç»œè¿›ç¨‹

ç½‘ç»œè¿›ç¨‹ä¸»è¦è´Ÿè´£å¤„ç†ç½‘ç«™çš„**æ•°æ®è¯·æ±‚å’Œå“åº”**ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒä¸**æ¸²æŸ“è¿›ç¨‹**çš„äº¤äº’æœ€ä¸ºå¯†åˆ‡ã€‚æ¯å½“ç½‘ç«™éœ€è¦è¿›è¡Œèµ„æºè¯·æ±‚ï¼Œæ¸²æŸ“è¿›ç¨‹å°±ä¼šå°†ä»»åŠ¡äº¤ç»™ç½‘ç»œè¿›ç¨‹å¤„ç†ï¼Œç½‘ç»œè¿›ç¨‹å–å¾—å“åº”ç»“æœåå†è¿”å›ç»™æ¸²æŸ“è¿›ç¨‹ã€‚

ç½‘ç»œè¿›ç¨‹å†…éƒ¨ä¼šå¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œä»¥å®ç°**å¤šç½‘ç»œè¯·æ±‚**çš„**å¼‚æ­¥åŒ–å¤„ç†**ã€‚

ğŸ“š æ¸²æŸ“è¿›ç¨‹

æ¸²æŸ“è¿›ç¨‹è´Ÿè´£æ§åˆ¶å’Œæ˜¾ç¤º**è§†çª—**éƒ¨åˆ†ï¼ˆç½‘ç«™é¡µé¢ï¼‰çš„æ‰€æœ‰å†…å®¹ï¼Œä¸»è¦æ˜¯è§£æ HTMLã€CSSã€JS å’Œå…¶ä»–èµ„æºï¼Œå¹¶ç”Ÿæˆæ¸²æŸ“æ ‘ã€æ‰§è¡Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰æ“ä½œã€‚

åœ¨ç°ä»£æµè§ˆå™¨ä¸­ï¼Œé»˜è®¤ä¼šä¸º**æ¯ä¸ªæ ‡ç­¾é¡µ**åˆ›å»ºä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚  
å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæ¸²æŸ“è¿›ç¨‹è¿è¡Œåœ¨**æ²™ç®±æ¨¡å¼**ä¸‹ï¼Œæ— æ³•è®¿é—®ç³»ç»Ÿèµ„æºã€‚

> é€šå¸¸å¯ä»¥é€šè¿‡æµè§ˆå™¨çš„ _æ›´å¤šå·¥å…·_ -> _ä»»åŠ¡ç®¡ç†å™¨_ æŸ¥çœ‹å½“å‰æµè§ˆå™¨å¼€å¯çš„æ‰€æœ‰è¿›ç¨‹åŠèµ„æºæ¶ˆè€—æƒ…å†µã€‚

![æµè§ˆå™¨ä»»åŠ¡ç®¡ç†å™¨.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f416e004edad427c86fad78c373640d7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=801&h=442&s=22875&e=png&b=fdfdfd)

### æµè§ˆå™¨ä¸­çš„ Event Loop

æ¸²æŸ“è¿›ç¨‹å¯åŠ¨åï¼Œä¼šå¼€å¯ä¸€ä¸ª**æ¸²æŸ“ä¸»çº¿ç¨‹**ï¼Œå®ƒæ˜¯æµè§ˆå™¨ä¸­**æœ€ç¹å¿™**çš„çº¿ç¨‹ï¼Œéœ€è¦å®ƒå¤„ç†çš„ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äºï¼š

- è§£æ HTMLã€CSS
- è®¡ç®—æ ·å¼ã€å¸ƒå±€
- å¤„ç†å›¾å±‚ã€ç»˜åˆ¶é¡µé¢
- æ‰§è¡Œ JSã€æ‰§è¡Œå„ç§å›è°ƒå‡½æ•°
- ... ... ...

![æ¸²æŸ“ä¸»çº¿ç¨‹.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b39490cbbade47458e10d0d5944417f4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=803&h=724&s=97042&e=png&b=fdfdfd)

æ¸²æŸ“ä¸»çº¿ç¨‹ä¸€ä¸ªçº¿ç¨‹è¦å¤„ç†å¥½è¿™ä¹ˆå¤šä»»åŠ¡ï¼Œé‚£å¦‚ä½•è¿›è¡Œ**ä»»åŠ¡è°ƒåº¦**ä¾¿æˆäº†é‡ç‚¹ï¼Œè€Œæµè§ˆå™¨é‡‡ç”¨çš„åˆ™æ˜¯**æ’é˜Ÿ**æœºåˆ¶ã€‚

æµè§ˆå™¨ä¼šæä¾›ä¸€ä¸ª**å…ˆè¿›å…ˆå‡º**çš„**æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆä¹Ÿç§°ä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼Œç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚æ¸²æŸ“ä¸»çº¿ç¨‹ä¸æ–­ä¾æ¬¡ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹¿å‡ºä»»åŠ¡æ‰§è¡Œï¼Œé‡åˆ°å¼‚æ­¥æ“ä½œåˆ™æ‰”ç»™**å…¶ä»–çº¿ç¨‹**å¤„ç†ï¼Œå“åº”ç»“æœ**å†æ¬¡åŠ å…¥**æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…æ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–ã€‚å¦‚æ­¤ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½èƒ½æœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯**äº‹ä»¶å¾ªç¯**ï¼ˆä¹Ÿç§°æ¶ˆæ¯å¾ªç¯ï¼‰ã€‚

ğŸ’ äº‹ä»¶å¾ªç¯å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

1.  ä»è°·æ­Œæµè§ˆå™¨æºç æ¥çœ‹ï¼Œæ¸²æŸ“è¿›ç¨‹è¿›å…¥æ¸²æŸ“æµç¨‹ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¾¿ä¼šå¼€å¯ä¸€ä¸ª**æ— é™å¾ªç¯**ã€‚
2.  æ¯æ¬¡å¾ªç¯éƒ½ä¼šæ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ã€‚
    - _å¦‚æœæœ‰_ï¼Œå°±æ‹¿å‡ºé˜Ÿåˆ—ä¸­çš„**ç¬¬ä¸€ä¸ª**ä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­è‹¥é‡åˆ°**å¼‚æ­¥æ“ä½œ**ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šå°†å…¶åŠ å…¥å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œå¤„ç†ï¼Œå®ƒè‡ªå·±åˆ™ä¸ä¼šç­‰å¾…ï¼Œè½¬è€Œå»æ‰§è¡Œåç»­ä»£ç 
    - _å¦‚æœæ²¡æœ‰_ï¼Œåˆ™è¿›å…¥**ä¼‘çœ çŠ¶æ€**
3.  å½“å…¶ä»–çº¿ç¨‹æŠŠå¼‚æ­¥ä»»åŠ¡å¤„ç†å®Œæˆï¼Œå°±ä¼š**å°†åç»­çš„å›è°ƒæ“ä½œåŒ…è£…æˆæ–°ä»»åŠ¡**ï¼ŒåŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ï¼Œç­‰å¾…æ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–æ‰§è¡Œã€‚
4.  å…¶ä»–æ‰€æœ‰çº¿ç¨‹ï¼ŒåŒ…æ‹¬**å…¶ä»–è¿›ç¨‹**çš„çº¿ç¨‹ï¼Œéƒ½å¯ä»¥å¾€æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾æ·»åŠ ä»»åŠ¡ã€‚å½“æ–°ä»»åŠ¡æ·»åŠ æ—¶å¦‚æœä¸»çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼Œåˆ™ä¼šå°†å…¶**å”¤é†’**ä»¥ç»§ç»­å¾ªç¯æ‹¿å–ä»»åŠ¡æ‰§è¡Œã€‚

![æµè§ˆå™¨äº‹ä»¶å¾ªç¯2.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf5ad748f3944492b0b1c8c5140e64d6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1177&h=476&s=65233&e=png&b=fdf8f8)

ä»»åŠ¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡Œå…ˆè¿›å…ˆå‡ºå¹¶æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œè€Œæµè§ˆå™¨ä¸­æ¶ˆæ¯é˜Ÿåˆ—**ä¸æ­¢ä¸€æ¡**ï¼Œå®ƒä»¬æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œè¿‡å»æˆ‘ä»¬æŠŠæ¶ˆæ¯é˜Ÿåˆ—åˆ†ä¸º**å®é˜Ÿåˆ—**å’Œ**å¾®é˜Ÿåˆ—**ã€‚

å®é˜Ÿåˆ—æ’é˜Ÿ**å®ä»»åŠ¡**ï¼ˆDOM æ“ä½œå›è°ƒã€å®šæ—¶å™¨å›è°ƒã€UI ç»˜åˆ¶ç­‰ï¼‰ï¼Œå¾®é˜Ÿåˆ—æ’é˜Ÿ**å¾®ä»»åŠ¡**ï¼ˆPromise å›è°ƒã€...ï¼‰ã€‚æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¯æ¬¡å¾ªç¯ä¼š**ä¼˜å…ˆ**æ‰§è¡Œå¹¶æ¸…ç©ºå¾®é˜Ÿåˆ—ä»»åŠ¡ï¼Œå†æ‰§è¡Œå®é˜Ÿåˆ—ã€‚

ä¸è¿‡éšç€æ—¶é—´æ¨ç§»ï¼Œæµè§ˆå™¨å¤æ‚åº¦æ€¥å‰§æå‡ï¼Œä»…ä¸¤ä¸ªé˜Ÿåˆ—å·²ç»ä¸èƒ½æ»¡è¶³ç°ä»£æµè§ˆå™¨çš„éœ€æ±‚äº†ã€‚äºæ˜¯ï¼ŒW3C åœ¨åˆ¶å®š [HTML è§„èŒƒ](https://link.juejin.cn/?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23event-loops "https://html.spec.whatwg.org/multipage/webappapis.html#event-loops")çš„æ—¶å€™å·²æŠ›å¼ƒå®é˜Ÿåˆ—çš„è¯´æ³•ã€‚

å„æµè§ˆå™¨å‚å•†åœ¨å®ç°äº‹ä»¶å¾ªç¯çš„æ—¶å€™ä¼šæ ¹æ®æœ€æ–°çš„è§£é‡Šï¼š_æ¯ä¸ªä»»åŠ¡éƒ½æœ‰å…¶ä»»åŠ¡ç±»å‹ï¼ŒåŒä¸€ä¸ªç±»å‹çš„ä»»åŠ¡å¿…é¡»åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿã€‚åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œæµè§ˆå™¨å¯æ ¹æ®å®é™…æƒ…å†µä»ä¸åŒçš„é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚å¹¶ä¸”æµè§ˆå™¨å¿…é¡»å‡†å¤‡å¥½ä¸€ä¸ªå¾®é˜Ÿåˆ—ï¼Œå…¶ä¸­çš„ä»»åŠ¡ä¼˜å…ˆäºæ‰€æœ‰å…¶ä»–é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œ_ã€‚

ä¸åŒæµè§ˆå™¨ï¼Œé™¤å¾®é˜Ÿåˆ—å¤–ï¼Œé˜Ÿåˆ—çš„ç§ç±»å’Œæ•°é‡å‡å¯èƒ½ä¸åŒï¼Œè¿™å–å†³äºæµè§ˆå™¨å‚å•†ã€‚  
åœ¨ç›®å‰çš„ Chrome çš„å®ç°ä¸­ï¼Œè‡³å°‘åŒ…å«äº†ä¸‹é¢å‡ ä¸ªé˜Ÿåˆ—ï¼š

- å¾®é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾éœ€è¦æœ€å¿«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æé«˜ï¼Œå°†ä»»åŠ¡åŠ å…¥å¾®é˜Ÿåˆ—çš„æ–¹å¼æœ‰ `promise.then()` ã€`MutationObserver`
- äº¤äº’é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾ç”¨æˆ·æ“ä½œåäº§ç”Ÿçš„äº‹ä»¶å¤„ç†ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æ¬¡äºå¾®é˜Ÿåˆ—
- å»¶è¿Ÿé˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾å®šæ—¶å™¨åˆ°è¾¾åçš„å›è°ƒä»»åŠ¡ï¼Œä¼˜å…ˆçº§æ¬¡äºäº¤äº’é˜Ÿåˆ—

> éœ€è¦ç‰¹åˆ«å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œäººå·¥åˆæˆçš„äº‹ä»¶æ´¾å‘ï¼Œå³ç›´æ¥å†™åœ¨ä»£ç é‡Œçš„ `dom.click()` æˆ– `dispatchEvent()`ï¼Œç›¸å¯¹äºæµè§ˆå™¨è€Œè¨€å¹¶ä¸æ˜¯çœŸæ­£çš„ç”¨æˆ·äº¤äº’ï¼Œä¼šè¢«å½“ä½œåŒæ­¥ä»»åŠ¡æ‰§è¡Œã€‚
>
> åªæœ‰ç”¨æˆ·åŠ¨ä½œè§¦å‘çš„äº‹ä»¶ï¼Œæ‰ä¼šä½œä¸ºå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­ç­‰å¾…æ‰§è¡Œã€‚
>
> [MDN å‚è€ƒ](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventTarget%2FdispatchEvent "https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/dispatchEvent")

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“æ¡ˆä¾‹ï¼Œè¯´æ˜æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„è¿‡ç¨‹ï¼š

```javascript
// å†™å‡ºä¸‹è¿°ç¨‹åºçš„è¾“å‡ºç»“æœ
const btn = document.getElementById("button");
function test() {
  console.log("function test!");
  Promise.resolve().then(() => {
    console.log("promise1");
  });
}

setTimeout(() => {
  console.log("set timer");
  Promise.resolve().then(test);
}, 0);

btn.onclick = () => {
  console.log("click button");
};

btn.click();

Promise.resolve().then(() => {
  console.log("promise2");
});

console.log("script start");

// è¾“å‡ºç»“æœä¾æ¬¡ä¸ºï¼š
// click button
// script start
// promise2
// set timer
// function test!
// promise1
```

ğŸ”¨ ç»“æœåˆ†æï¼š

![æ¡ˆä¾‹åˆ†æ1.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdf42c11d5234f3e9e3c1b13b4f40c7b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1692&h=807&s=162552&e=png&b=f8f2f2)

1.  æ‰§è¡Œå…¨å±€ä»£ç ï¼Œåˆ°è¾¾ `setTimeout` äº¤ç»™è®¡æ—¶å™¨çº¿ç¨‹å¤„ç†ï¼Œç”±äºç­‰å¾… 0 ms æ•…ç«‹åˆ»åŠ å…¥å»¶è¿Ÿé˜Ÿåˆ—ã€‚
2.  åˆ°è¾¾ `btn.click()`ï¼Œç”±äºæ˜¯äººå·¥åˆæˆçš„ç‚¹å‡»äº‹ä»¶ï¼Œç›´æ¥å½“åŒæ­¥ä»»åŠ¡æ‰§è¡Œï¼Œè¾“å‡º `click button`ã€‚
3.  åˆ°è¾¾ `Promise.resolve().then()`ï¼Œäº¤ç»™å…¶ä»–çº¿ç¨‹å¤„ç†ï¼Œç«‹å³å®Œæˆå¹¶åŠ å…¥å¾®é˜Ÿåˆ—ã€‚
4.  è¾“å‡º `script start`ï¼Œè‡³æ­¤åŒæ­¥ä»»åŠ¡å®Œæˆï¼Œå„æ¶ˆæ¯é˜Ÿåˆ—çš„æƒ…å†µä¸ºï¼šå¾®é˜Ÿåˆ—æœ‰ 1 ä¸ªæ’é˜Ÿä»»åŠ¡ï¼Œå»¶è¿Ÿé˜Ÿåˆ—æœ‰ 1 ä¸ªæ’ä½ä»»åŠ¡ã€‚
5.  äº‹ä»¶å¾ªç¯å¼€å§‹ï¼Œæ ¹æ®é˜Ÿåˆ—ä¼˜å…ˆçº§ï¼Œé¦–å…ˆæ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–å¹¶æ¸…ç©ºå¾®é˜Ÿåˆ—ä»»åŠ¡ï¼Œè¾“å‡º `promise2`ã€‚
6.  æ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–å¹¶æ¸…ç©ºå»¶è¿Ÿé˜Ÿåˆ—ä»»åŠ¡ï¼Œè¾“å‡º `set timer`ï¼Œé‡åˆ°ç¬¬äºŒä¸ª `Promise.resolve().then()`ï¼Œäº¤ç»™å…¶ä»–çº¿ç¨‹å¤„ç†ï¼Œå®ŒæˆååŠ å…¥å¾®é˜Ÿåˆ—ã€‚
7.  æ¸²æŸ“ä¸»çº¿ç¨‹æ— ä»»åŠ¡å¯åšï¼Œè¿›å…¥ä¼‘çœ ã€‚
8.  å…¶ä»–çº¿ç¨‹ä¼šç«‹åˆ»å®Œæˆå¯¹ç¬¬äºŒä¸ª `Promise.resolve().then()` çš„å¤„ç†ï¼Œå¹¶å°†å›è°ƒå‡½æ•° `test` åŠ å…¥å¾®é˜Ÿåˆ—ã€‚
9.  å¾®é˜Ÿåˆ—å‡ºç°ä»»åŠ¡ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹è¢«å”¤é†’ï¼Œæ‹¿å–å¹¶æ¸…ç©ºå¾®é˜Ÿåˆ—ä»»åŠ¡ã€‚
10. æ‰§è¡Œ `test` å‡½æ•°ï¼Œè¾“å‡º `function test!`ï¼Œé‡åˆ°ç¬¬ä¸‰ä¸ª `Promise.resolve().then()`ï¼Œäº¤ç»™å…¶ä»–çº¿ç¨‹å¤„ç†ï¼Œå®ŒæˆååŠ å…¥å¾®é˜Ÿåˆ—ã€‚
11. æ¸²æŸ“ä¸»çº¿ç¨‹æ— ä»»åŠ¡å¯åšï¼Œè¿›å…¥ä¼‘çœ ã€‚
12. å…¶ä»–çº¿ç¨‹ä¼šç«‹åˆ»å®Œæˆå¯¹ç¬¬ä¸‰ä¸ª `Promise.resolve().then()` çš„å¤„ç†ï¼Œå¹¶å°†å›è°ƒå‡½æ•°æ“ä½œ `console.log` åŠ å…¥å¾®é˜Ÿåˆ—ã€‚
13. å¾®é˜Ÿåˆ—å‡ºç°ä»»åŠ¡ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹è¢«å”¤é†’ï¼Œæ‹¿å–å¹¶æ¸…ç©ºå¾®é˜Ÿåˆ—ä»»åŠ¡ã€‚
14. æ‰§è¡Œ `console.log` æ“ä½œï¼Œè¾“å‡º `promise1`ã€‚

## Node.js äº‹ä»¶å¾ªç¯

### Libuv

åœ¨ JavaScript çš„æ‰€æœ‰å®¿ä¸»ç¯å¢ƒä¸­ï¼Œæ— è®ºæ˜¯æµè§ˆå™¨è¿˜æ˜¯ Node.jsï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶éƒ½ä¸æ˜¯ **ECMAScript** çš„è¯­è¨€è§„èŒƒå®šä¹‰çš„ã€‚æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯æ˜¯æ ¹æ® **HTML æ ‡å‡†**å®ç°çš„ï¼Œè€Œ Node.js ä¸­çš„äº‹ä»¶å¾ªç¯åˆ™æ˜¯åŸºäº `libuv` å®ç°çš„ã€‚

`libuv` æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å®ç°çš„é«˜æ€§èƒ½è§£å†³å•çº¿ç¨‹éé˜»å¡å¼‚æ­¥ I/O çš„å¼€æºåº“ï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯å¯¹å¸¸è§**æ“ä½œç³»ç»Ÿåº•å±‚å¼‚æ­¥ I/O æ“ä½œ**çš„å°è£…ã€‚åœ¨ nodejs åº•å±‚ï¼ŒNode API çš„å®ç°å…¶å®å°±æ˜¯è°ƒç”¨çš„å®ƒã€‚

æˆ‘ä»¬çŸ¥é“æµè§ˆå™¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„å…¶ä»–çº¿ç¨‹æ˜¯ç”±æµè§ˆå™¨æœ¬èº«æä¾›çš„ï¼Œå¤šçº¿ç¨‹è°ƒåº¦æ˜¯ç”±æ¸²æŸ“ä¸»çº¿ç¨‹å®Œæˆçš„ã€‚è€Œåœ¨ nodejs ä¸­ï¼Œè¿™éƒ½æ˜¯ `libuv` å®Œæˆçš„ã€‚

å‡ ä¹æ¯ä¸ª Node API éƒ½æœ‰**å¼‚æ­¥æ‰§è¡Œç‰ˆæœ¬**ï¼Œ`libuv` ç›´æ¥è´Ÿè´£å®ƒä»¬çš„æ‰§è¡Œï¼Œ`libuv` ä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸»çº¿ç¨‹æ‰§è¡Œåˆ°å¼‚æ­¥æ“ä½œåï¼Œ`libuv` å°±ä¼šåœ¨**çº¿ç¨‹æ± **ä¸­è°ƒåº¦ç©ºé—²çº¿ç¨‹å»æ‰§è¡Œï¼Œå¯ä»¥è¯´ `libuv` ä¸º nodejs æä¾›äº†æ•´ä¸ªäº‹ä»¶å¾ªç¯åŠŸèƒ½ã€‚

![libuv.webp](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c863acea121c4631ab7e2a827520a528~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&h=403&s=9242&e=webp&b=fdfaf9)

### Node.js ä¸­çš„ Event Loop

ä¸åœ¨æµè§ˆå™¨ä¸­ä¸€æ ·ï¼Œåœ¨ nodejs ä¸­ JS æœ€å¼€å§‹åœ¨**ä¸»çº¿ç¨‹**ä¸Šæ‰§è¡Œï¼Œæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€å‘å‡ºå¼‚æ­¥è¯·æ±‚ã€è§„åˆ’å®šæ—¶å™¨ç”Ÿæ•ˆæ—¶é—´ã€æ‰§è¡Œ process.nextTick ç­‰ï¼Œè¿™æ—¶äº‹ä»¶å¾ªç¯è¿˜æ²¡å¼€å§‹ã€‚

åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰å¼‚æ­¥æ“ä½œï¼Œä»£ç åœ¨æ‰§è¡Œå®Œæˆåä¾¿**ç›´æ¥é€€å‡º**ã€‚å¦‚æœæœ‰ï¼Œ`libuv` ä¼šæŠŠä¸åŒçš„å¼‚æ­¥ä»»åŠ¡åˆ†é…ç»™**ä¸åŒçš„çº¿ç¨‹**ï¼Œå½¢æˆäº‹ä»¶å¾ªç¯ã€‚åœ¨åŒæ­¥ä»£ç æ‰§è¡Œå®Œåï¼Œnodejs ä¾¿ä¼šè¿›å…¥äº‹ä»¶å¾ªç¯ï¼Œä¾æ¬¡æ‰§è¡Œä¸åŒé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚`libuv` ä¼šä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™ **V8 å¼•æ“**ï¼ŒV8 å¼•æ“å†è¿”å›ç»™ç”¨æˆ·ã€‚

![nodejs äº‹ä»¶å¾ªç¯.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d7ac572250349c3b11f80f21e496481~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1336&h=1214&s=334402&e=png&b=fdfbfb)

Nodejs äº‹ä»¶å¾ªç¯ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—å…±æœ‰ **8** ä¸ªï¼Œè‹¥å¼•ç”¨ä¹‹å‰å®é˜Ÿåˆ—ã€å¾®é˜Ÿåˆ—çš„è¯´æ³•ï¼Œå…·ä½“å¯åˆ’åˆ†ä¸ºï¼š

- å®é˜Ÿåˆ—
  - timers (é‡è¦)
  - pending callback
    - è°ƒç”¨ä¸Šä¸€æ¬¡äº‹ä»¶å¾ªç¯æ²¡åœ¨ `poll` é˜¶æ®µç«‹åˆ»æ‰§è¡Œï¼Œè€Œå»¶è¿Ÿçš„Â I/OÂ å›è°ƒå‡½æ•°
  - idle prepare
    - ä»…ä¾› nodejs å†…éƒ¨ä½¿ç”¨
  - poll (é‡è¦)
  - check (é‡è¦)
  - close callbacks
    - æ‰§è¡Œæ‰€æœ‰æ³¨å†ŒÂ `close`Â äº‹ä»¶çš„å›è°ƒå‡½æ•°
- å¾®é˜Ÿåˆ—
  - nextTick
  - Promise

æˆ‘ä»¬å…ˆæ¥è¯´è¯´å®é˜Ÿåˆ—ä¸­æ¯”è¾ƒé‡è¦çš„ 3 ä¸ªï¼š

ğŸ“š timers

`timers`ï¼Œä¹Ÿå°±æ˜¯**è®¡æ—¶å™¨é˜Ÿåˆ—**ï¼Œè´Ÿè´£å¤„ç† `setTimeout` å’Œ `setInterval` å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡åœ¨æµè§ˆå™¨ä¸­è¿˜æ˜¯ nodejs ä¸­ï¼Œæ‰€æœ‰çš„å®šæ—¶å™¨å›è°ƒå‡½æ•°éƒ½**ä¸èƒ½ä¿è¯**åˆ°è¾¾æ—¶é—´åç«‹å³æ‰§è¡Œã€‚ä¸€æ˜¯å› ä¸ºä»è®¡ç®—æœºç¡¬ä»¶å’Œåº•å±‚æ“ä½œç³»ç»Ÿæ¥çœ‹ï¼Œè®¡æ—¶å™¨çš„å®ç°æœ¬èº«å°±æ˜¯ä¸ç²¾å‡†çš„ï¼ŒäºŒæ˜¯å› ä¸º `poll` é˜¶æ®µå¯¹ `timers` é˜¶æ®µçš„æ·±åˆ»å½±å“ã€‚å› ä¸ºåœ¨æ²¡æœ‰æ»¡è¶³ `poll` é˜¶æ®µçš„ç»“æŸæ¡ä»¶å‰ï¼Œå°±æ— æ³•è¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„ `timers` é˜¶æ®µï¼Œå³ä½¿ `timers` é˜Ÿåˆ—ä¸­å·²ç»æœ‰è®¡æ—¶å™¨åˆ°æœŸçš„å›è°ƒå‡½æ•°ã€‚

ğŸ“š poll

`poll` ç§°ä¸º**è½®è¯¢é˜Ÿåˆ—**ï¼Œè¯¥é˜¶æ®µä¼šå¤„ç†é™¤ `timers` å’Œ `check` é˜Ÿåˆ—å¤–çš„ç»å¤§å¤šæ•° I/O å›è°ƒä»»åŠ¡ï¼Œå¦‚æ–‡ä»¶è¯»å–ã€ç›‘å¬ç”¨æˆ·è¯·æ±‚ç­‰ã€‚

äº‹ä»¶å¾ªç¯åˆ°è¾¾è¯¥é˜¶æ®µæ—¶ï¼Œå®ƒçš„è¿è¡Œæ–¹å¼ä¸ºï¼š

- å¦‚æœ `poll` é˜Ÿåˆ—ä¸­æœ‰å›è°ƒä»»åŠ¡ï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œå›è°ƒç›´åˆ°æ¸…ç©ºé˜Ÿåˆ—ã€‚
- å¦‚æœ `poll` é˜Ÿåˆ—ä¸­æ²¡æœ‰å›è°ƒä»»åŠ¡
  - è‹¥å…¶ä»–é˜Ÿåˆ—ä¸­åç»­å¯èƒ½ä¼šå‡ºç°å›è°ƒä»»åŠ¡ï¼Œåˆ™ä¸€ç›´ç­‰å¾…ï¼Œç­‰å…¶ä»–é˜Ÿåˆ—ä¸­åç»­çš„å›è°ƒä»»åŠ¡æ¥ä¸´æ—¶ï¼Œç»“æŸè¯¥é˜¶æ®µï¼Œå¼€å¯ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
  - è‹¥ç­‰å¾…æ—¶é—´è¶…è¿‡é¢„è®¾çš„æ—¶é—´é™åˆ¶ï¼Œä¹Ÿä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
  - è‹¥å…¶ä»–é˜Ÿåˆ—ä¸­åç»­ä¸å¯èƒ½å†å‡ºç°å›è°ƒä»»åŠ¡äº†ï¼Œåˆ™ç«‹å³ç»“æŸè¯¥é˜¶æ®µï¼Œå¹¶åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯å®Œæˆåï¼Œé€€å‡º node ç¨‹åº

> `poll` é˜¶æ®µçš„è¶…æ—¶æ—¶é—´åœ¨è¿›å…¥ `poll` é˜¶æ®µä¹‹å‰è®¡ç®—ã€‚

ğŸ’ æ¡ˆä¾‹ 1ï¼šä¸ç²¾å‡†çš„è®¡æ—¶å™¨

```javascript
const fs = require("fs");
const start = Date.now();

setTimeout(() => {
  console.log("setTimeout exec", Date.now() - start);
}, 200);

fs.readFile("./index.js", "utf-8", (err, data) => {
  console.log("file read");
  const start = Date.now();
  while (Date.now() - start < 300) {}
});

// è¾“å‡ºç»“æœï¼š
// file read
// setTimeout exec 313ms
```

ğŸ”¨ åˆ†æ 1ï¼š

1.  è¿›å…¥äº‹ä»¶å¾ªç¯åï¼Œå®šæ—¶å™¨è¿˜æ²¡åˆ°æ—¶é—´ï¼Œ`timers` é˜Ÿåˆ—ç©ºï¼Œæ¥åˆ° `poll` é˜¶æ®µ
2.  è¯»å–æ–‡ä»¶éœ€è¦ä¸€å®šæ—¶é—´ï¼Œ`poll` é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…
3.  æ–‡ä»¶è¯»å–å®Œæˆï¼Œå›è°ƒå‡½æ•°åŠ å…¥ `poll` é˜Ÿåˆ—ï¼Œæ‰§è¡Œè¾“å‡º `file read`ï¼Œå¼€å¯å¾ªç¯ï¼Œé˜»å¡ 300ms
4.  å®šæ—¶å™¨åˆ°æ—¶é—´ï¼Œå›è°ƒå‡½æ•°åŠ å…¥ `timers` é˜Ÿåˆ—ï¼Œç”±äº `poll` é˜¶æ®µæœªç»“æŸï¼Œè¢«é˜»å¡ï¼Œç­‰å¾…
5.  `poll` ä¸­çš„å¾ªç¯ç»“æŸï¼Œæ£€æµ‹åˆ° `timers` ä¸­æœ‰ä»»åŠ¡ï¼Œç»“æŸ `poll` é˜¶æ®µï¼Œå¼€å§‹ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
6.  æ‰§è¡Œ `timers` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œè¾“å‡º `setTimeout exec 313ms`ï¼Œè®¡æ—¶å™¨å›è°ƒå‡½æ•°å¹¶æ²¡æœ‰åœ¨è®¡æ—¶å™¨åˆ°è¾¾æ—¶ç«‹å³æ‰§è¡Œ

ğŸ“š check

`check` ç§°ä¸º**æ£€æŸ¥é˜Ÿåˆ—**ï¼Œè´Ÿè´£å¤„ç† `setImmediate` å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚

`setTimeout` å’Œ `setImmediate` çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ¯æ¬¡æ‰§è¡Œåˆ° `timers` é˜Ÿåˆ—æ—¶ï¼Œå®šæ—¶å™¨è§‚å¯Ÿè€…å†…éƒ¨ä¼šå»**æ£€æŸ¥**ä»£ç ä¸­çš„å®šæ—¶å™¨æ˜¯å¦è¶…è¿‡å®šæ—¶æ—¶é—´ï¼Œè€Œ `setImmediate` åˆ™æ˜¯**ç›´æ¥**å°†å›è°ƒä»»åŠ¡**åŠ å…¥**åˆ° `check` é˜Ÿåˆ—ã€‚

æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œ`setImmediate` çš„æ‰§è¡Œæ•ˆç‡è¦è¿œé«˜äº `setTimeout`ï¼Œäºæ˜¯ä¹Ÿå°±å‡ºç°äº†ä¸‹é¢**æ— æ³•é¢„æµ‹**è¾“å‡ºç»“æœçš„æƒ…å†µï¼š

```javascript
setTimeout(() => {
  console.log("setTimeout");
}, 0);

setImmediate(() => {
  console.log("setImmediate");
});

// ä¸Šè¿°ä»£ç æ˜¯æ— æ³•é¢„æµ‹å…ˆè¾“å‡ºé‚£ä¸ªçš„
// å› ä¸ºå³ä½¿ setTimeout(xxx, 0)ï¼Œåœ¨è®¡ç®—æœºè¿ç®—æ…¢çš„æƒ…å†µä¸‹ä¹Ÿä¸èƒ½ç«‹åˆ»åŠ å…¥ timers é˜Ÿåˆ—
```

å¯¹äºå¾®é˜Ÿåˆ—çš„ `nextTick` å’Œ `Promise`ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šè®²ä¹Ÿä¸å±äºäº‹ä»¶å¾ªç¯ã€‚åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯æ¬¡æ‰“ç®—è¿›å…¥ä¸‹ä¸ªé˜¶æ®µä¹‹å‰ï¼Œå¿…é¡»è¦å…ˆä¾æ¬¡åå¤æ¸…ç©º `nextTick` å’Œ `promise` é˜Ÿåˆ—ï¼Œç›´åˆ°ä¸¤ä¸ªé˜Ÿåˆ—å®Œå…¨æ²¡æœ‰å³å°†è¦åˆ°æ¥çš„ä»»åŠ¡çš„æ—¶å€™å†è¿›å…¥ä¸‹ä¸ªé˜¶æ®µã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `process.nextTick()` å°†å›è°ƒå‡½æ•°åŠ å…¥ `nextTick` é˜Ÿåˆ—ï¼Œå’Œé€šè¿‡ `Promise.resolve().then()` å°†å›è°ƒå‡½æ•°åŠ å…¥ `Promise` é˜Ÿåˆ—ï¼Œä¸” `nextTick` é˜Ÿåˆ—çš„ä¼˜å…ˆçº§è¿˜è¦**é«˜äº** `Promise` é˜Ÿåˆ—ï¼Œæ‰€ä»¥ `process.nextTick` æ˜¯ nodejs ä¸­æ‰§è¡Œ**æœ€å¿«**çš„å¼‚æ­¥æ“ä½œã€‚

ğŸ’ æ¡ˆä¾‹ 2

```javascript
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}

async function async2() {
  console.log("async2");
}

console.log("script start");

setTimeout(function () {
  console.log("setTimeout0");
}, 0);

setTimeout(function () {
  console.log("setTimeout3");
}, 3);

setImmediate(() => console.log("setImmediate"));

process.nextTick(() => console.log("nextTick"));

async1();

new Promise(function (resolve) {
  console.log("promise1");
  resolve();
  console.log("promise2");
}).then(function () {
  console.log("promise3");
});

console.log("script end");

// è¾“å‡ºç»“æœä¾æ¬¡ä¸ºï¼š
// script start
// async1 start
// async2
// promise1
// promise2
// script end
// nextTick
// async1 end
// promise3
// å‰©ä¸‹çš„ setTimeout0ã€setTimeout3ã€setImmediate é¡ºåºä¸å®š
// å”¯ä¸€èƒ½ç¡®å®šçš„æ˜¯ setTimeout0 åœ¨ setTimeout3 å‰è¾“å‡º
// è€Œ setImmediate å¯èƒ½åœ¨ setTimeout0 å‰ä¹Ÿå¯èƒ½åœ¨ setTimeout3 ä¹‹åï¼Œä¹Ÿå¯èƒ½åœ¨ä¸¤è€…ä¸­é—´
```

ğŸ”¨ åˆ†æ 2ï¼š

1.  æ‰§è¡Œå…¨å±€ä»£ç ï¼Œè¾“å‡º `script start`ã€‚
2.  åˆ°è¾¾ `setTimeout(0)` å’Œ `setTimeout(3)`ï¼Œäº¤ç»™è®¡æ—¶å™¨çº¿ç¨‹å¼€å§‹è®¡æ—¶ï¼Œæ³¨æ„åœ¨çº¿ç¨‹è®¡æ—¶å®Œæˆå‰ï¼Œä¸¤ä¸ªå›è°ƒä»»åŠ¡ `console.log` è¿˜æœªåŠ å…¥ `timers` é˜Ÿåˆ—ã€‚
3.  åˆ°è¾¾ `setImmediate`ï¼Œç«‹åˆ»å°† `console.log` ä»»åŠ¡åŠ å…¥ `check` é˜Ÿåˆ—ã€‚
4.  åˆ°è¾¾ `process.nextTick`ï¼Œç«‹åˆ»å°† `console.log` ä»»åŠ¡åŠ å…¥ `nextTick` é˜Ÿåˆ—ã€‚
5.  æ‰§è¡Œ `async1`ï¼Œè¾“å‡º `async1 start`ã€‚`await async2()` ç«‹åˆ»æ‰§è¡Œ `async2()`ï¼Œè¾“å‡º `async2` å°†åç»­ `console.log` ä»»åŠ¡åŒ…è£…æˆ `Promise.then()` åŠ å…¥ `Promise` é˜Ÿåˆ—ã€‚
6.  æ‰§è¡Œ `new Promise()`ï¼Œè¾“å‡º `promise1`ã€`promise2`ï¼Œè¿™ä¸¤æ­¥æ˜¯åŒæ­¥ä»£ç ã€‚ç„¶åå°† `.then()` é‡Œçš„ `console.log` ä»»åŠ¡æ‰”è¿› `Promise` é˜Ÿåˆ—ã€‚
7.  æ‰§è¡Œæœ€åçš„ `console.log`ï¼Œè¾“å‡º `script end`ã€‚
8.  è‡³æ­¤åŒæ­¥ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­ä»æœ‰ä»»åŠ¡ï¼Œè¿›å…¥äº‹ä»¶å¾ªç¯ã€‚

> æ¢³ç†ä¸€ä¸‹æ­¤æ—¶å„æ¶ˆæ¯é˜Ÿåˆ—çš„çŠ¶æ€ï¼š
>
> å·²æœ‰çš„è¾“å‡ºï¼š`script start`ã€`async1 start`ã€`async2`ã€`promise1`ã€`promise2`ã€`script end`  
> `nextTick` é˜Ÿåˆ—ï¼š`console.log("nextTick")`  
> `Promise` é˜Ÿåˆ—ï¼š`console.log("async1 end")`ã€`console.log("promise3")`  
> `timers` é˜Ÿåˆ—ï¼š`console.log("setTimeout0")`ã€`console.log("setTimeout3")`  
> `check` é˜Ÿåˆ—ï¼š`console.log("setImmediate")`

9.  åœ¨è¿›å…¥ `timers` é˜¶æ®µå‰å…ˆæ¸…ç©ºå¾®é˜Ÿåˆ—ï¼Œå…ˆæ‰§è¡Œ `nextTick` é˜Ÿåˆ—ï¼Œè¾“å‡º `nextTick`ã€‚
10. æ‰§è¡Œ `Promise` é˜Ÿåˆ—ï¼Œä¾æ¬¡è¾“å‡º `async1 end`ã€`promise3`ã€‚
11. è¿›å…¥ `timers` é˜¶æ®µï¼Œç”±äºä¸ç¡®å®šåœ¨åˆ°è¾¾è¿™ä¸ªé˜¶æ®µå‰ï¼Œè®¡æ—¶å™¨çº¿ç¨‹æœ‰æ²¡æœ‰æŠŠå®Œæˆå¯¹ `setTimeout(0)` å’Œ `setTimeout(3)` ä¸­çš„ä¸€è€…æˆ–ä¸¤è€…çš„æ—¶é—´æ£€æŸ¥ï¼Œå¹¶å°†å›è°ƒå‡½æ•°æ¨å…¥ `timers` é˜Ÿåˆ—ï¼Œæ•…æ— æ³•é¢„æµ‹å®ƒä»¬ä¸ `check` é˜Ÿåˆ—ä¸­çš„ `setImmediate` è°å…ˆè¾“å‡ºã€‚

---

## å†™åœ¨æœ€å

> _One day you'll leave this world behind. So live a life you will remember! --- Avicii_

æˆ‘æ˜¯æš®æ˜Ÿï¼Œä¸€æšæœ‰å¿—äºåœ¨å‰ç«¯é¢†åŸŸè¯é“çš„æ”»åŸç‹®ã€‚

ä¼˜è´¨å‰ç«¯å†…å®¹æŒç»­è¾“å‡ºä¸­......ï¼Œæ¬¢è¿**ç‚¹èµ + å…³æ³¨ + æ”¶è—**ã€‚

![ç‚¹èµ.jpeg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a8c25f041894ffdb08a27b3444065d1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=600&h=484&s=18341&e=jpg&b=fdfbfb)
