# æ·±å…¥ç†è§£ Event Loop åŸç†

## ä¸€ã€è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«

åœ¨äº†è§£ Event Loop ä¹‹å‰,æˆ‘ä»¬éœ€è¦å…ˆç†è§£è¿›ç¨‹å’Œçº¿ç¨‹çš„æ¦‚å¿µ:

- **è¿›ç¨‹ (Process)**: æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½,æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´
- **çº¿ç¨‹ (Thread)**: æ˜¯è¿›ç¨‹å†…çš„æ‰§è¡Œå•å…ƒ,ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹,å®ƒä»¬å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´
- **å…³ç³»**: è¿›ç¨‹å¥½æ¯”å·¥å‚,çº¿ç¨‹å¥½æ¯”å·¥å‚ä¸­çš„å·¥äºº,å¤šä¸ªå·¥äºº(çº¿ç¨‹)ååŒå®Œæˆå·¥å‚(è¿›ç¨‹)çš„ä»»åŠ¡

## äºŒã€ä¸ºä»€ä¹ˆ JavaScript æ˜¯å•çº¿ç¨‹

> JavaScript åœ¨è®¾è®¡ä¹‹åˆæ˜¯ä½œä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€,ä¸»è¦ç”¨äºä¸ç”¨æˆ·è¿›è¡Œé¡µé¢äº¤äº’å’Œæ“çºµ DOMã€‚ä¸ºé¿å…ç”±ä¸å¯é¢„æµ‹çš„ç”¨æˆ·æ“ä½œå¯èƒ½å¸¦æ¥çš„å¤æ‚çš„å¹¶å‘é—®é¢˜,JavaScript è¢«è®¾è®¡æˆå•çº¿ç¨‹çš„,è¿™ä¹Ÿæ˜¯è¿™é—¨è¯­è¨€çš„æ ¸å¿ƒç‰¹å¾ä¹‹ä¸€ã€‚

JavaScript å¼•æ“ä¹‹æ‰€ä»¥æ˜¯å•çº¿ç¨‹,ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› :

1. **é¿å… DOM æ“ä½œå†²çª**: å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ DOM,å¯èƒ½ä¼šå‡ºç°ç«æ€æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å‡è®¾çº¿ç¨‹ A è¦åˆ é™¤æŸä¸ª DOM èŠ‚ç‚¹,è€Œçº¿ç¨‹ B è¦ä¿®æ”¹è¿™ä¸ªèŠ‚ç‚¹çš„æ ·å¼,é‚£ä¹ˆå°±ä¼šäº§ç”Ÿå†²çª
2. **ç®€åŒ–ç¼–ç¨‹æ¨¡å‹**: å•çº¿ç¨‹é¿å…äº†å¤æ‚çš„é”æœºåˆ¶å’Œçº¿ç¨‹åŒæ­¥é—®é¢˜
3. **å†å²è®¾è®¡**: JavaScript æœ€åˆåªæ˜¯ä¸€ä¸ªç®€å•çš„è„šæœ¬è¯­è¨€,å•çº¿ç¨‹è¶³ä»¥æ»¡è¶³å½“æ—¶çš„éœ€æ±‚

## ä¸‰ã€æµè§ˆå™¨çš„å¤šè¿›ç¨‹æ¶æ„

ç°ä»£æµè§ˆå™¨æ˜¯ä¸€ä¸ªå¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„åº”ç”¨ç¨‹åº,å†…éƒ¨å·¥ä½œæå…¶å¤æ‚,å…¶ç¨‹åº¦ç›´é€¼æ“ä½œç³»ç»Ÿã€‚å®ƒæ‹¥æœ‰æ•°ä¸ªåŠŸèƒ½æ¨¡å—,ä¸ºé¿å…å•ä¸ªæ¨¡å—å´©æºƒç‰µè¿å…¶ä»–æ¨¡å—,å¯¼è‡´è¿é”ååº”ä½¿æµè§ˆå™¨å½»åº•å´©æºƒ,æµè§ˆå™¨åœ¨å¯åŠ¨æ—¶ä¼šå¼€å¯å¤šä¸ªè¿›ç¨‹,æŠŠä¸åŒçš„åŠŸèƒ½æ¨¡å—æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹é‡Œã€‚

![æµè§ˆå™¨å¤šè¿›ç¨‹æ¶æ„](https://youke1.picui.cn/s1/2025/11/05/690b0f7acd95a.png)

æµè§ˆå™¨è¿›ç¨‹ä¼—å¤š,å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æœ‰:

### 1. æµè§ˆå™¨è¿›ç¨‹

æµè§ˆå™¨è¿›ç¨‹æ˜¯æµè§ˆå™¨çš„ä¸»è¿›ç¨‹,**æ— è®ºæ‰“å¼€å¤šå°‘æµè§ˆå™¨çª—å£,å®ƒä»…æœ‰ä¸€ä¸ª**ã€‚

å®ƒä¸»è¦è´Ÿè´£:

- æµè§ˆå™¨ç•Œé¢æ˜¾ç¤º(å¯¼èˆªæ ã€ä¹¦ç­¾æ ã€åˆ·æ–°æŒ‰é’®ç­‰)
- ç”¨æˆ·äº¤äº’å¤„ç†
- å„å­è¿›ç¨‹ç®¡ç†

> æ³¨æ„: è¿™é‡Œè¯´çš„ç•Œé¢å’Œäº¤äº’,ä¸æ˜¯è§†çª—å†…çš„ç½‘ç«™ç•Œé¢,è€Œæ˜¯æŒ‡æµè§ˆå™¨æœ¬èº«è‡ªå¸¦çš„éƒ¨åˆ†ã€‚åˆšæ‰“å¼€æµè§ˆå™¨çš„æ—¶å€™åªæœ‰ä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹,å…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒåˆ›å»ºçš„ã€‚

### 2. ç½‘ç»œè¿›ç¨‹

ç½‘ç»œè¿›ç¨‹ä¸»è¦è´Ÿè´£å¤„ç†ç½‘ç«™çš„æ•°æ®è¯·æ±‚å’Œå“åº”,é€šå¸¸æƒ…å†µä¸‹,å®ƒä¸æ¸²æŸ“è¿›ç¨‹çš„äº¤äº’æœ€ä¸ºå¯†åˆ‡ã€‚

å·¥ä½œæµç¨‹:

1. æ¸²æŸ“è¿›ç¨‹éœ€è¦è¯·æ±‚èµ„æºæ—¶,å°†ä»»åŠ¡äº¤ç»™ç½‘ç»œè¿›ç¨‹å¤„ç†
2. ç½‘ç»œè¿›ç¨‹å–å¾—å“åº”ç»“æœåè¿”å›ç»™æ¸²æŸ“è¿›ç¨‹
3. ç½‘ç»œè¿›ç¨‹å†…éƒ¨å¼€å¯å¤šä¸ªçº¿ç¨‹,å®ç°å¤šç½‘ç»œè¯·æ±‚çš„å¼‚æ­¥åŒ–å¤„ç†

### 3. æ¸²æŸ“è¿›ç¨‹

æ¸²æŸ“è¿›ç¨‹è´Ÿè´£æ§åˆ¶å’Œæ˜¾ç¤ºè§†çª—éƒ¨åˆ†(ç½‘ç«™é¡µé¢)çš„æ‰€æœ‰å†…å®¹,ä¸»è¦å·¥ä½œåŒ…æ‹¬:

- è§£æ HTMLã€CSS
- ç”Ÿæˆæ¸²æŸ“æ ‘
- æ‰§è¡Œå¸ƒå±€å’Œç»˜åˆ¶
- æ‰§è¡Œ JavaScript ä»£ç 

**å…³é”®ç‰¹æ€§**:

- åœ¨ç°ä»£æµè§ˆå™¨ä¸­,**é»˜è®¤ä¼šä¸ºæ¯ä¸ªæ ‡ç­¾é¡µåˆ›å»ºä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹**
- å‡ºäºå®‰å…¨è€ƒè™‘,æ¸²æŸ“è¿›ç¨‹è¿è¡Œåœ¨æ²™ç®±æ¨¡å¼ä¸‹,æ— æ³•è®¿é—®ç³»ç»Ÿèµ„æº

### æµè§ˆå™¨å¤šè¿›ç¨‹çš„ä¼˜åŠ¿

ç›¸æ¯”äºå•è¿›ç¨‹æµè§ˆå™¨ï¼Œå¤šè¿›ç¨‹æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

- é¿å…å•ä¸ªpage crashå½±å“æ•´ä¸ªæµè§ˆå™¨
- é¿å…ç¬¬ä¸‰æ–¹æ’ä»¶crashå½±å“æ•´ä¸ªæµè§ˆå™¨
- å¤šè¿›ç¨‹å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿
- æ–¹ä¾¿ä½¿ç”¨æ²™ç›’æ¨¡å‹éš”ç¦»æ’ä»¶ç­‰è¿›ç¨‹ï¼Œæé«˜æµè§ˆå™¨ç¨³å®šæ€§
  ç®€å•ç‚¹ç†è§£ï¼šå¦‚æœæµè§ˆå™¨æ˜¯å•è¿›ç¨‹ï¼Œé‚£ä¹ˆæŸä¸ªTabé¡µå´©æºƒäº†ï¼Œå°±å½±å“äº†æ•´ä¸ªæµè§ˆå™¨ï¼Œä½“éªŒæœ‰å¤šå·®ï¼›åŒç†å¦‚æœæ˜¯å•è¿›ç¨‹ï¼Œæ’ä»¶å´©æºƒäº†ä¹Ÿä¼šå½±å“æ•´ä¸ªæµè§ˆå™¨ï¼›è€Œä¸”å¤šè¿›ç¨‹è¿˜æœ‰å…¶å®ƒçš„è¯¸å¤šä¼˜åŠ¿ã€‚ã€‚ã€‚

## å››ã€æ¸²æŸ“è¿›ç¨‹çš„çº¿ç¨‹ç»„æˆ

è™½ç„¶ JavaScript æ˜¯å•çº¿ç¨‹çš„,ä½†æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹çš„ã€‚æ¸²æŸ“è¿›ç¨‹å†…åŒ…å«å¤šä¸ªçº¿ç¨‹:

![æ¸²æŸ“çº¿ç¨‹æ¶æ„](https://youke1.picui.cn/s1/2025/11/05/690b0f7bace08.png)

### 1. GUI æ¸²æŸ“çº¿ç¨‹

- è´Ÿè´£æ¸²æŸ“æµè§ˆå™¨ç•Œé¢,è§£æ HTMLã€CSS
- æ„å»º DOM æ ‘å’Œæ¸²æŸ“æ ‘
- è¿›è¡Œå¸ƒå±€å’Œç»˜åˆ¶
- **ä¸ JS å¼•æ“çº¿ç¨‹äº’æ–¥**: å½“ JS å¼•æ“æ‰§è¡Œæ—¶,GUI çº¿ç¨‹ä¼šè¢«æŒ‚èµ·,GUI æ›´æ–°ä¼šè¢«ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾… JS å¼•æ“ç©ºé—²æ—¶ç«‹å³æ‰§è¡Œ

### 2. JS å¼•æ“çº¿ç¨‹

- ä¹Ÿå« JS å†…æ ¸,è´Ÿè´£è§£ææ‰§è¡Œ JavaScript è„šæœ¬ç¨‹åºçš„ä¸»çº¿ç¨‹(ä¾‹å¦‚ V8 å¼•æ“)
- ä¸€ç›´ç­‰å¾…ç€ä»»åŠ¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„åˆ°æ¥,ç„¶ååŠ ä»¥å¤„ç†
- **ä¸€ä¸ª Tab é¡µ(æ¸²æŸ“è¿›ç¨‹)ä¸­æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½åªæœ‰ä¸€ä¸ª JS çº¿ç¨‹åœ¨è¿è¡Œ JS ç¨‹åº**

### 3. äº‹ä»¶è§¦å‘çº¿ç¨‹

- å±äºæµè§ˆå™¨å†…æ ¸çº¿ç¨‹,ä¸»è¦ç”¨äºæ§åˆ¶äº‹ä»¶å¾ªç¯
- å½“ JS å¼•æ“æ‰§è¡Œä»£ç å—å¦‚ `setTimeout` æ—¶(ä¹Ÿå¯æ¥è‡ªæµè§ˆå™¨å†…æ ¸çš„å…¶ä»–çº¿ç¨‹,å¦‚é¼ æ ‡ç‚¹å‡»ã€AJAX å¼‚æ­¥è¯·æ±‚ç­‰)
- ä¼šå°†å¯¹åº”ä»»åŠ¡æ·»åŠ åˆ°äº‹ä»¶è§¦å‘çº¿ç¨‹ä¸­
- å½“å¯¹åº”çš„äº‹ä»¶ç¬¦åˆè§¦å‘æ¡ä»¶è¢«è§¦å‘æ—¶,è¯¥çº¿ç¨‹ä¼šæŠŠäº‹ä»¶æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—çš„é˜Ÿå°¾,ç­‰å¾… JS å¼•æ“çš„å¤„ç†

### 4. å®šæ—¶å™¨è§¦å‘çº¿ç¨‹

- ä¸»è¦æ§åˆ¶ `setInterval` å’Œ `setTimeout`
- æµè§ˆå™¨å®šæ—¶è®¡æ•°å™¨å¹¶ä¸æ˜¯ç”± JavaScript å¼•æ“è®¡æ•°çš„,å› ä¸º JavaScript å¼•æ“æ˜¯å•çº¿ç¨‹çš„,å¦‚æœå¤„äºé˜»å¡çº¿ç¨‹çŠ¶æ€å°±ä¼šå½±å“è®°è®¡æ—¶çš„å‡†ç¡®æ€§
- å½“è®¡æ—¶å®Œæ¯•å,ä¼šæŠŠå®šæ—¶å™¨çš„å¤„ç†å‡½æ•°æ¨è¿›äº‹ä»¶é˜Ÿåˆ—ä¸­,ç­‰å¾… JS å¼•æ“çº¿ç¨‹æ‰§è¡Œ

### 5. å¼‚æ­¥ HTTP è¯·æ±‚çº¿ç¨‹

- åœ¨ XMLHttpRequest è¿æ¥åé€šè¿‡æµè§ˆå™¨æ–°å¼€çš„ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚
- æ£€æµ‹åˆ°çŠ¶æ€å˜æ›´æ—¶,å¦‚æœè®¾ç½®æœ‰å›è°ƒå‡½æ•°,è¯¥çº¿ç¨‹ä¼šæŠŠå›è°ƒå‡½æ•°æ¨è¿›äº‹ä»¶é˜Ÿåˆ—ä¸­,ç­‰å¾… JS å¼•æ“çº¿ç¨‹æ‰§è¡Œ

## äº”ã€æ¸²æŸ“ä¸»çº¿ç¨‹ä¸äº‹ä»¶å¾ªç¯

æ¸²æŸ“è¿›ç¨‹å¯åŠ¨å,ä¼šå¼€å¯ä¸€ä¸ª**æ¸²æŸ“ä¸»çº¿ç¨‹**,å®ƒæ˜¯æµè§ˆå™¨ä¸­æœ€ç¹å¿™çš„çº¿ç¨‹,éœ€è¦å¤„ç†çš„ä»»åŠ¡åŒ…æ‹¬ä½†ä¸é™äº:

- è§£æ HTMLã€CSS
- è®¡ç®—æ ·å¼ã€å¸ƒå±€
- å¤„ç†å›¾å±‚ã€ç»˜åˆ¶é¡µé¢
- æ‰§è¡Œ JavaScript ä»£ç 
- æ‰§è¡Œå„ç§å›è°ƒå‡½æ•°

### æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶

æ¸²æŸ“ä¸»çº¿ç¨‹ä¸€ä¸ªçº¿ç¨‹è¦å¤„ç†å¥½è¿™ä¹ˆå¤šä»»åŠ¡,é‚£å¦‚ä½•è¿›è¡Œä»»åŠ¡è°ƒåº¦ä¾¿æˆäº†é‡ç‚¹,è€Œ**æµè§ˆå™¨é‡‡ç”¨çš„åˆ™æ˜¯æ’é˜Ÿæœºåˆ¶**ã€‚

æµè§ˆå™¨ä¼šæä¾›ä¸€ä¸ª**å…ˆè¿›å…ˆå‡ºçš„æ¶ˆæ¯é˜Ÿåˆ—**(ä¹Ÿç§°ä»»åŠ¡é˜Ÿåˆ—),ç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡:

1. æ¸²æŸ“ä¸»çº¿ç¨‹ä¸æ–­ä¾æ¬¡ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œ
2. é‡åˆ°å¼‚æ­¥æ“ä½œåˆ™äº¤ç»™å…¶ä»–çº¿ç¨‹å¤„ç†
3. å¼‚æ­¥æ“ä½œå®Œæˆå,å“åº”ç»“æœå†æ¬¡åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—
4. ç­‰å¾…æ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–æ‰§è¡Œ

å¦‚æ­¤,æ‰€æœ‰çš„ä»»åŠ¡éƒ½èƒ½æœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œ,è€Œ**è¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯äº‹ä»¶å¾ªç¯(Event Loop)**(ä¹Ÿç§°æ¶ˆæ¯å¾ªç¯)ã€‚

### å¤šé˜Ÿåˆ—ä¼˜å…ˆçº§

ä»»åŠ¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡Œå…ˆè¿›å…ˆå‡ºå¹¶æ²¡æœ‰ä¼˜å…ˆçº§,ä½†**æµè§ˆå™¨ä¸­æ¶ˆæ¯é˜Ÿåˆ—ä¸æ­¢ä¸€æ¡,å®ƒä»¬æ˜¯æœ‰ä¼˜å…ˆçº§çš„**ã€‚

è¿‡å»æˆ‘ä»¬æŠŠæ¶ˆæ¯é˜Ÿåˆ—åˆ†ä¸º**å®é˜Ÿåˆ—**å’Œ**å¾®é˜Ÿåˆ—**:

- **å®é˜Ÿåˆ—**: æ’é˜Ÿå®ä»»åŠ¡(DOM æ“ä½œå›è°ƒã€å®šæ—¶å™¨å›è°ƒã€UI ç»˜åˆ¶ç­‰)
- **å¾®é˜Ÿåˆ—**: æ’é˜Ÿå¾®ä»»åŠ¡(Promise å›è°ƒç­‰)
- æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¯æ¬¡å¾ªç¯ä¼š**ä¼˜å…ˆæ‰§è¡Œå¹¶æ¸…ç©ºå¾®é˜Ÿåˆ—ä»»åŠ¡**,å†æ‰§è¡Œå®é˜Ÿåˆ—

ä¸è¿‡éšç€æ—¶é—´æ¨ç§»,æµè§ˆå™¨å¤æ‚åº¦æ€¥å‰§æå‡,ä»…ä¸¤ä¸ªé˜Ÿåˆ—å·²ç»ä¸èƒ½æ»¡è¶³ç°ä»£æµè§ˆå™¨çš„éœ€æ±‚äº†ã€‚äºæ˜¯,**W3C åœ¨åˆ¶å®š HTML è§„èŒƒçš„æ—¶å€™å·²æŠ›å¼ƒå®é˜Ÿåˆ—çš„è¯´æ³•**ã€‚

### ç°ä»£æµè§ˆå™¨çš„é˜Ÿåˆ—å®ç°

å„æµè§ˆå™¨å‚å•†åœ¨å®ç°äº‹ä»¶å¾ªç¯æ—¶ä¼šæ ¹æ®æœ€æ–°çš„ W3C è§„èŒƒ:

> æ¯ä¸ªä»»åŠ¡éƒ½æœ‰å…¶ä»»åŠ¡ç±»å‹,åŒä¸€ä¸ªç±»å‹çš„ä»»åŠ¡å¿…é¡»åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—é‡Œæ’é˜Ÿã€‚åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­,æµè§ˆå™¨å¯æ ¹æ®å®é™…æƒ…å†µä»ä¸åŒçš„é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚å¹¶ä¸”æµè§ˆå™¨å¿…é¡»å‡†å¤‡å¥½ä¸€ä¸ªå¾®é˜Ÿåˆ—,å…¶ä¸­çš„ä»»åŠ¡ä¼˜å…ˆäºæ‰€æœ‰å…¶ä»–é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œã€‚

ä¸åŒæµè§ˆå™¨,é™¤å¾®é˜Ÿåˆ—å¤–,é˜Ÿåˆ—çš„ç§ç±»å’Œæ•°é‡å‡å¯èƒ½ä¸åŒ,è¿™å–å†³äºæµè§ˆå™¨å‚å•†ã€‚

**åœ¨ç›®å‰çš„ Chrome å®ç°ä¸­,è‡³å°‘åŒ…å«äº†ä¸‹é¢å‡ ä¸ªé˜Ÿåˆ—**:

1. **å¾®é˜Ÿåˆ—**: ç”¨äºå­˜æ”¾éœ€è¦æœ€å¿«æ‰§è¡Œçš„ä»»åŠ¡,ä¼˜å…ˆçº§æé«˜,å°†ä»»åŠ¡åŠ å…¥å¾®é˜Ÿåˆ—çš„æ–¹å¼æœ‰ `Promise.then()`ã€`MutationObserver`
2. **äº¤äº’é˜Ÿåˆ—**: ç”¨äºå­˜æ”¾ç”¨æˆ·æ“ä½œåäº§ç”Ÿçš„äº‹ä»¶å¤„ç†ä»»åŠ¡,ä¼˜å…ˆçº§æ¬¡äºå¾®é˜Ÿåˆ—
3. **å»¶è¿Ÿé˜Ÿåˆ—**: ç”¨äºå­˜æ”¾å®šæ—¶å™¨åˆ°è¾¾åçš„å›è°ƒä»»åŠ¡,ä¼˜å…ˆçº§æ¬¡äºäº¤äº’é˜Ÿåˆ—

> âš ï¸ **ç‰¹åˆ«æ³¨æ„**: äººå·¥åˆæˆçš„äº‹ä»¶æ´¾å‘,å³ç›´æ¥å†™åœ¨ä»£ç é‡Œçš„ `dom.click()` æˆ– `dispatchEvent()`,ç›¸å¯¹äºæµè§ˆå™¨è€Œè¨€å¹¶ä¸æ˜¯çœŸæ­£çš„ç”¨æˆ·äº¤äº’,ä¼šè¢«å½“ä½œåŒæ­¥ä»»åŠ¡æ‰§è¡Œã€‚åªæœ‰ç”¨æˆ·åŠ¨ä½œè§¦å‘çš„äº‹ä»¶,æ‰ä¼šä½œä¸ºå¼‚æ­¥ä»»åŠ¡,åœ¨äº‹ä»¶å¾ªç¯ä¸­ç­‰å¾…æ‰§è¡Œã€‚

**å‚è€ƒé“¾æ¥**: [MDN - EventTarget.dispatchEvent()](https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/dispatchEvent)

## å…­ã€äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†

### ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯

å•çº¿ç¨‹æ„å‘³ç€ JavaScript å¼•æ“åœ¨åŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹æƒ…,å³åŒæ­¥åœ°æ‰§è¡Œä»£ç ã€‚ä½†åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å¯é¿å…åœ°ä¼šé‡åˆ°ä¸€äº›æ— æ³•ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡,ä¾‹å¦‚:

- è®¡æ—¶å™¨åˆ°è¾¾æ—¶é—´åè¦æ‰§è¡Œçš„ä»»åŠ¡ â†’ `setInterval`ã€`setTimeout`
- ç½‘ç»œè¯·æ±‚å®Œæˆåè¦æ‰§è¡Œçš„ä»»åŠ¡ â†’ `XMLHttpRequest`ã€`Fetch`
- ç›‘å¬åˆ°ç”¨æˆ·æ“ä½œåè¦æ‰§è¡Œçš„ä»»åŠ¡ â†’ `addEventListener`

å¦‚æœè®©æ‰§è¡Œ JavaScript çš„çº¿ç¨‹å»å¤„ç†è¿™äº›ä»»åŠ¡,å°±ä¼šå¯¼è‡´è¯¥çº¿ç¨‹å¤„äºé•¿æœŸé˜»å¡çš„çŠ¶æ€,è€Œå®¿ä¸»ç¯å¢ƒä¸­çš„ JavaScript æ‰§è¡Œçº¿ç¨‹å¾€å¾€è¿˜æ‰¿æ‹…ç€æå…¶é‡è¦çš„å·¥ä½œã€‚ä¾‹å¦‚,åœ¨æµè§ˆå™¨ä¸­,å¦‚æœæ‰§è¡Œ JavaScript çš„çº¿ç¨‹é•¿æœŸé˜»å¡,å°±ä¼šå¯¼è‡´æµè§ˆå™¨å¡æ­»!

ä¸ºé¿å…ä¸Šè¿°æƒ…å†µå‘ç”Ÿ,**JavaScript çš„å®¿ä¸»ç¯å¢ƒä½¿ç”¨äº†å¼‚æ­¥çš„æ–¹å¼æ¥å¤„ç†è¿™ç§æ— æ³•ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡**ã€‚

å½“é‡åˆ°å¼‚æ­¥ä»»åŠ¡æ—¶:

1. å®¿ä¸»ç¯å¢ƒä¼šå°†å…¶äº¤ç»™å…¶ä»–çº¿ç¨‹å¤„ç†
2. æ‰§è¡Œ JavaScript çš„çº¿ç¨‹åˆ™ä¼šç«‹å³ç»“æŸå½“å‰ä»»åŠ¡
3. è½¬è€Œå»æ‰§è¡Œåç»­ä»£ç 

### äº‹ä»¶å¾ªç¯æµç¨‹å›¾

![äº‹ä»¶å¾ªç¯æµç¨‹](https://youke1.picui.cn/s1/2025/11/05/690b0f7c25a07.png)

**äº‹ä»¶å¾ªç¯çš„åŸºæœ¬æµç¨‹**:

1. åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡åˆ†åˆ«è¿›å…¥ä¸åŒçš„æ‰§è¡Œ"åœºæ‰€",åŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹,å¼‚æ­¥çš„è¿›å…¥ Event Table å¹¶æ³¨å†Œå‡½æ•°
2. å½“æŒ‡å®šçš„äº‹æƒ…å®Œæˆæ—¶,Event Table ä¼šå°†è¿™ä¸ªå‡½æ•°ç§»å…¥ Event Queue
3. ä¸»çº¿ç¨‹å†…çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¸ºç©º,ä¼šå» Event Queue è¯»å–å¯¹åº”çš„å‡½æ•°,è¿›å…¥ä¸»çº¿ç¨‹æ‰§è¡Œ
4. ä¸Šè¿°è¿‡ç¨‹ä¼šä¸æ–­é‡å¤,ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ **Event Loop(äº‹ä»¶å¾ªç¯)**

### ä¸»çº¿ç¨‹å¦‚ä½•çŸ¥é“æ‰§è¡Œæ ˆä¸ºç©º

ä»è°·æ­Œæµè§ˆå™¨æºç æ¥çœ‹,æ¸²æŸ“è¿›ç¨‹è¿›å…¥æ¸²æŸ“æµç¨‹,æ¸²æŸ“ä¸»çº¿ç¨‹ä¾¿ä¼šå¼€å¯ä¸€ä¸ª**æ— é™å¾ªç¯**ã€‚

æ¯æ¬¡å¾ªç¯éƒ½ä¼šæ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡:

- **å¦‚æœæœ‰**: å°±æ‹¿å‡ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ,æ‰§è¡Œè¿‡ç¨‹ä¸­è‹¥é‡åˆ°å¼‚æ­¥æ“ä½œ,æ¸²æŸ“ä¸»çº¿ç¨‹ä¼šå°†å…¶åŠ å…¥å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œå¤„ç†,å®ƒè‡ªå·±åˆ™ä¸ä¼šç­‰å¾…,è½¬è€Œå»æ‰§è¡Œåç»­ä»£ç 
- **å¦‚æœæ²¡æœ‰**: åˆ™è¿›å…¥ä¼‘çœ çŠ¶æ€

å½“å…¶ä»–çº¿ç¨‹æŠŠå¼‚æ­¥ä»»åŠ¡å¤„ç†å®Œæˆ,å°±ä¼šå°†åç»­çš„å›è°ƒæ“ä½œåŒ…è£…æˆæ–°ä»»åŠ¡,åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾,ç­‰å¾…æ¸²æŸ“ä¸»çº¿ç¨‹æ‹¿å–æ‰§è¡Œã€‚

å…¶ä»–æ‰€æœ‰çº¿ç¨‹,åŒ…æ‹¬å…¶ä»–è¿›ç¨‹çš„çº¿ç¨‹,éƒ½å¯ä»¥å¾€æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾æ·»åŠ ä»»åŠ¡ã€‚å½“æ–°ä»»åŠ¡æ·»åŠ æ—¶å¦‚æœä¸»çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€,åˆ™ä¼šå°†å…¶å”¤é†’ä»¥ç»§ç»­å¾ªç¯æ‹¿å–ä»»åŠ¡æ‰§è¡Œã€‚

### äº‹ä»¶å¾ªç¯çš„æ‰§è¡Œé¡ºåº

**äº‹ä»¶å¾ªç¯çš„é¡ºåº,å†³å®šäº† JavaScript ä»£ç çš„æ‰§è¡Œé¡ºåº**ã€‚è¿›å…¥æ•´ä½“ä»£ç (å®ä»»åŠ¡)å,å¼€å§‹ç¬¬ä¸€æ¬¡å¾ªç¯ã€‚æ¥ç€æ‰§è¡Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ã€‚ç„¶åå†æ¬¡ä»å®ä»»åŠ¡å¼€å§‹,æ‰¾åˆ°å…¶ä¸­ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•,å†æ‰§è¡Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ã€‚

![äº‹ä»¶å¾ªç¯å…³ç³»å›¾](https://youke1.picui.cn/s1/2025/11/05/690b0f7bec01d.png)

#### ç¤ºä¾‹ä»£ç åˆ†æ

```javascript
setTimeout(function () {
  console.log("setTimeout");
});

new Promise(function (resolve) {
  console.log("promise");
  resolve();
}).then(function () {
  console.log("then");
});

console.log("console");
```

**æ‰§è¡Œæµç¨‹åˆ†æ**:

1. è¿™æ®µä»£ç ä½œä¸ºå®ä»»åŠ¡,è¿›å…¥ä¸»çº¿ç¨‹
2. å…ˆé‡åˆ° `setTimeout`,å°†å…¶å›è°ƒå‡½æ•°æ³¨å†Œååˆ†å‘åˆ°å®ä»»åŠ¡ Event Queue
3. æ¥ä¸‹æ¥é‡åˆ°äº† `Promise`,`new Promise` **ç«‹å³æ‰§è¡Œ**,è¾“å‡º `'promise'`,`then` å‡½æ•°åˆ†å‘åˆ°å¾®ä»»åŠ¡ Event Queue
4. é‡åˆ° `console.log()`,ç«‹å³æ‰§è¡Œ,è¾“å‡º `'console'`
5. ç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œç»“æŸ,æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—,å‘ç° `then` åœ¨å¾®ä»»åŠ¡ Event Queue é‡Œé¢,æ‰§è¡Œ,è¾“å‡º `'then'`
6. ç¬¬ä¸€è½®äº‹ä»¶å¾ªç¯ç»“æŸ,å¼€å§‹ç¬¬äºŒè½®å¾ªç¯,ä»å®ä»»åŠ¡ Event Queue å¼€å§‹,å‘ç° `setTimeout` å¯¹åº”çš„å›è°ƒå‡½æ•°,ç«‹å³æ‰§è¡Œ,è¾“å‡º `'setTimeout'`
7. ç»“æŸ

**è¾“å‡ºç»“æœ**: `promise` â†’ `console` â†’ `then` â†’ `setTimeout`

## ä¸ƒã€å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

### å®ä»»åŠ¡ (MacroTask)

| ä»»åŠ¡ç±»å‹              | æµè§ˆå™¨ | Node.js |
| --------------------- | ------ | ------- |
| æ•´ä½“ä»£ç  (script)     | âœ…     | âœ…      |
| UI äº¤äº’äº‹ä»¶           | âœ…     | âŒ      |
| I/O                   | âœ…     | âœ…      |
| setTimeout            | âœ…     | âœ…      |
| setInterval           | âœ…     | âœ…      |
| setImmediate          | âŒ     | âœ…      |
| requestAnimationFrame | âœ…     | âŒ      |

### å¾®ä»»åŠ¡ (MicroTask)

| ä»»åŠ¡ç±»å‹                   | æµè§ˆå™¨ | Node.js |
| -------------------------- | ------ | ------- |
| process.nextTick           | âŒ     | âœ…      |
| MutationObserver           | âœ…     | âŒ      |
| Promise.then/catch/finally | âœ…     | âœ…      |

## å…«ã€äº‹ä»¶å¾ªç¯å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ä¸€: async/await çš„æ‰§è¡Œé¡ºåº

ECMAScript 2017 ä¸­æ·»åŠ äº† `async functions` å’Œ `await`ã€‚

- **async å…³é”®å­—**: å°†ä¸€ä¸ªåŒæ­¥å‡½æ•°å˜æˆä¸€ä¸ªå¼‚æ­¥å‡½æ•°,å¹¶å°†è¿”å›å€¼å˜ä¸º Promise
- **await å…³é”®å­—**: å¯ä»¥æ”¾åœ¨ä»»ä½•å¼‚æ­¥çš„ã€åŸºäº Promise çš„å‡½æ•°ä¹‹å‰ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­,å®ƒä¼šæš‚åœä»£ç åœ¨è¯¥è¡Œä¸Š,ç›´åˆ° Promise å®Œæˆ,ç„¶åè¿”å›ç»“æœå€¼ã€‚è€Œåœ¨æš‚åœçš„åŒæ—¶,å…¶ä»–æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»£ç å°±æœ‰æœºä¼šæ‰§è¡Œäº†

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ·±å…¥ç†è§£:

```javascript
async function async1() {
  console.log("a");
  const res = await async2();
  console.log("b");
}

async function async2() {
  console.log("c");
  return 2;
}

console.log("d");

setTimeout(() => {
  console.log("e");
}, 0);

async1().then((res) => {
  console.log("f");
});

new Promise((resolve) => {
  console.log("g");
  resolve();
}).then(() => {
  console.log("h");
});

console.log("i");
```

**è¯¦ç»†æ‰§è¡Œæµç¨‹åˆ†æ**:

1. **å¼€å§‹æ‰§è¡Œå‰**,å°†æ•´ä½“ä»£ç  script æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸­,å¹¶å¼€å§‹æ‰§è¡Œ

2. **æ‰§è¡Œ `console.log("d")`**
   - è¾“å‡º: `d`

3. **é‡åˆ° `setTimeout`**
   - å°†å…¶å›è°ƒæ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—ä¸­
   - ç»§ç»­æ‰§è¡Œ

4. **è°ƒç”¨ `async1()` å‡½æ•°**
   - å°†å…¶å‡½æ•°ä¸Šä¸‹æ–‡æ”¾ç½®åˆ°è°ƒç”¨æ ˆ

5. **æ‰§è¡Œ `async1` ä¸­çš„ `console.log("a")`**
   - è¾“å‡º: `a`

6. **é‡åˆ° `await` å…³é”®å­—è¯­å¥**
   - `await` åé¢è°ƒç”¨çš„æ˜¯ `async2` å‡½æ•°,å°†å…¶æ”¾å…¥è°ƒç”¨æ ˆ

7. **æ‰§è¡Œ `async2` ä¸­çš„ `console.log("c")`**
   - è¾“å‡º: `c`
   - `async2` è¿”å›å€¼ `2`
   - `async2` è¢«ç§»å‡ºè°ƒç”¨æ ˆ

8. **`await` é˜»å¡æ‰§è¡Œ**
   - `await` ä¼šé˜»å¡,å…ˆè·³å‡º `async1` ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
   - æ­¤æ—¶ `async1` ä¸­çš„ `res` å˜é‡è¿˜æ˜¯ `undefined`,æ²¡æœ‰èµ‹å€¼
   - `await` åé¢çš„ä»£ç ç›¸å½“äºæ”¾å…¥äº†å¾®ä»»åŠ¡é˜Ÿåˆ—

9. **æ‰§è¡Œ `new Promise`**
   - Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„
   - æ‰§è¡Œ `console.log("g")`
   - è¾“å‡º: `g`
   - `then` å›è°ƒæ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

10. **æ‰§è¡Œ `console.log("i")`**
    - è¾“å‡º: `i`

11. **ç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•**,å¼€å§‹æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—

12. **æ‰§è¡Œ Promise çš„ then å¾®ä»»åŠ¡**
    - æ‰§è¡Œ `console.log("h")`
    - è¾“å‡º: `h`

13. **æ‰§è¡Œ `async1` çš„ await åç»­ä»£ç **
    - `res` æˆåŠŸèµ‹å€¼ä¸º `async2` çš„ç»“æœå€¼ `2`
    - æ‰§è¡Œ `console.log("b")`
    - è¾“å‡º: `b`
    - `async1` æ‰§è¡Œç»“æŸ

14. **æ‰§è¡Œ `async1().then()` çš„å›è°ƒ**
    - æ‰§è¡Œ `console.log("f")`
    - è¾“å‡º: `f`

15. **å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©º**,æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡

16. **æ‰§è¡Œ `setTimeout` çš„å›è°ƒ**
    - æ‰§è¡Œ `console.log("e")`
    - è¾“å‡º: `e`

**æœ€ç»ˆè¾“å‡ºç»“æœ**: `d` â†’ `a` â†’ `c` â†’ `g` â†’ `i` â†’ `h` â†’ `b` â†’ `f` â†’ `e`

### å…³é”®çŸ¥è¯†ç‚¹æ€»ç»“

1. **async å‡½æ•°è¿”å›ä¸€ä¸ª Promise**,å³ä½¿æ²¡æœ‰æ˜¾å¼ return Promise
2. **await ä¼šæš‚åœ async å‡½æ•°çš„æ‰§è¡Œ**,ç­‰å¾… Promise å®Œæˆ
3. **await åé¢çš„ä»£ç ç›¸å½“äºæ”¾åœ¨ Promise.then() ä¸­**,ä¼šè¢«æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
4. **Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„**,åªæœ‰ then/catch/finally æ‰æ˜¯å¼‚æ­¥çš„
5. **å¾®ä»»åŠ¡ä¼˜å…ˆäºå®ä»»åŠ¡æ‰§è¡Œ**

## ä¹ã€æ€»ç»“

1. **JavaScript æ˜¯å•çº¿ç¨‹çš„**,ä½†æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹çš„,é€šè¿‡äº‹ä»¶å¾ªç¯æœºåˆ¶å®ç°å¼‚æ­¥ç¼–ç¨‹
2. **äº‹ä»¶å¾ªç¯**æ˜¯ JavaScript å®ç°å¼‚æ­¥çš„æ ¸å¿ƒæœºåˆ¶,ç†è§£å®ƒå¯¹æŒæ¡å¼‚æ­¥ç¼–ç¨‹è‡³å…³é‡è¦
3. **ä»»åŠ¡åˆ†ä¸ºå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡**,å¾®ä»»åŠ¡ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡
4. **æ¯æ¬¡å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å**,éƒ½ä¼šæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—,ç„¶åå†æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
5. **async/await æ˜¯ Promise çš„è¯­æ³•ç³–**,ä½†æ‰§è¡Œé¡ºåºéœ€è¦ç‰¹åˆ«æ³¨æ„

ç†è§£ Event Loop å¯¹äºç¼–å†™é«˜æ€§èƒ½ã€æ— é˜»å¡çš„ JavaScript ä»£ç è‡³å…³é‡è¦,ä¹Ÿæ˜¯å‰ç«¯å¼€å‘è€…å¿…é¡»æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†ä¹‹ä¸€ã€‚

## Node.js äº‹ä»¶å¾ªç¯

### Libuv

åœ¨ JavaScript çš„æ‰€æœ‰å®¿ä¸»ç¯å¢ƒä¸­ï¼Œæ— è®ºæ˜¯æµè§ˆå™¨è¿˜æ˜¯ Node.jsï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶éƒ½ä¸æ˜¯ **ECMAScript** çš„è¯­è¨€è§„èŒƒå®šä¹‰çš„ã€‚æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªç¯æ˜¯æ ¹æ® **HTML æ ‡å‡†**å®ç°çš„ï¼Œè€Œ Node.js ä¸­çš„äº‹ä»¶å¾ªç¯åˆ™æ˜¯åŸºäº `libuv` å®ç°çš„ã€‚

`libuv` æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å®ç°çš„é«˜æ€§èƒ½è§£å†³å•çº¿ç¨‹éé˜»å¡å¼‚æ­¥ I/O çš„å¼€æºåº“ï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯å¯¹å¸¸è§**æ“ä½œç³»ç»Ÿåº•å±‚å¼‚æ­¥ I/O æ“ä½œ**çš„å°è£…ã€‚åœ¨ nodejs åº•å±‚ï¼ŒNode API çš„å®ç°å…¶å®å°±æ˜¯è°ƒç”¨çš„å®ƒã€‚

æˆ‘ä»¬çŸ¥é“æµè§ˆå™¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„å…¶ä»–çº¿ç¨‹æ˜¯ç”±æµè§ˆå™¨æœ¬èº«æä¾›çš„ï¼Œå¤šçº¿ç¨‹è°ƒåº¦æ˜¯ç”±æ¸²æŸ“ä¸»çº¿ç¨‹å®Œæˆçš„ã€‚è€Œåœ¨ nodejs ä¸­ï¼Œè¿™éƒ½æ˜¯ `libuv` å®Œæˆçš„ã€‚

å‡ ä¹æ¯ä¸ª Node API éƒ½æœ‰**å¼‚æ­¥æ‰§è¡Œç‰ˆæœ¬**ï¼Œ`libuv` ç›´æ¥è´Ÿè´£å®ƒä»¬çš„æ‰§è¡Œï¼Œ`libuv` ä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸»çº¿ç¨‹æ‰§è¡Œåˆ°å¼‚æ­¥æ“ä½œåï¼Œ`libuv` å°±ä¼šåœ¨**çº¿ç¨‹æ± **ä¸­è°ƒåº¦ç©ºé—²çº¿ç¨‹å»æ‰§è¡Œï¼Œå¯ä»¥è¯´ `libuv` ä¸º nodejs æä¾›äº†æ•´ä¸ªäº‹ä»¶å¾ªç¯åŠŸèƒ½ã€‚

![libuv.webp](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c863acea121c4631ab7e2a827520a528~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080&h=403&s=9242&e=webp&b=fdfaf9)

### Node.js ä¸­çš„ Event Loop

ä¸åœ¨æµè§ˆå™¨ä¸­ä¸€æ ·ï¼Œåœ¨ nodejs ä¸­ JS æœ€å¼€å§‹åœ¨**ä¸»çº¿ç¨‹**ä¸Šæ‰§è¡Œï¼Œæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€å‘å‡ºå¼‚æ­¥è¯·æ±‚ã€è§„åˆ’å®šæ—¶å™¨ç”Ÿæ•ˆæ—¶é—´ã€æ‰§è¡Œ process.nextTick ç­‰ï¼Œè¿™æ—¶äº‹ä»¶å¾ªç¯è¿˜æ²¡å¼€å§‹ã€‚

åœ¨ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰å¼‚æ­¥æ“ä½œï¼Œä»£ç åœ¨æ‰§è¡Œå®Œæˆåä¾¿**ç›´æ¥é€€å‡º**ã€‚å¦‚æœæœ‰ï¼Œ`libuv` ä¼šæŠŠä¸åŒçš„å¼‚æ­¥ä»»åŠ¡åˆ†é…ç»™**ä¸åŒçš„çº¿ç¨‹**ï¼Œå½¢æˆäº‹ä»¶å¾ªç¯ã€‚åœ¨åŒæ­¥ä»£ç æ‰§è¡Œå®Œåï¼Œnodejs ä¾¿ä¼šè¿›å…¥äº‹ä»¶å¾ªç¯ï¼Œä¾æ¬¡æ‰§è¡Œä¸åŒé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚`libuv` ä¼šä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™ **V8 å¼•æ“**ï¼ŒV8 å¼•æ“å†è¿”å›ç»™ç”¨æˆ·ã€‚

![nodejs äº‹ä»¶å¾ªç¯.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d7ac572250349c3b11f80f21e496481~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1336&h=1214&s=334402&e=png&b=fdfbfb)

Nodejs äº‹ä»¶å¾ªç¯ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—å…±æœ‰ **8** ä¸ªï¼Œè‹¥å¼•ç”¨ä¹‹å‰å®é˜Ÿåˆ—ã€å¾®é˜Ÿåˆ—çš„è¯´æ³•ï¼Œå…·ä½“å¯åˆ’åˆ†ä¸ºï¼š

- å®é˜Ÿåˆ—
  - timers (é‡è¦)
  - pending callback
    - è°ƒç”¨ä¸Šä¸€æ¬¡äº‹ä»¶å¾ªç¯æ²¡åœ¨ `poll` é˜¶æ®µç«‹åˆ»æ‰§è¡Œï¼Œè€Œå»¶è¿Ÿçš„Â I/OÂ å›è°ƒå‡½æ•°
  - idle prepare
    - ä»…ä¾› nodejs å†…éƒ¨ä½¿ç”¨
  - poll (é‡è¦)
  - check (é‡è¦)
  - close callbacks
    - æ‰§è¡Œæ‰€æœ‰æ³¨å†ŒÂ `close`Â äº‹ä»¶çš„å›è°ƒå‡½æ•°
- å¾®é˜Ÿåˆ—
  - nextTick
  - Promise

æˆ‘ä»¬å…ˆæ¥è¯´è¯´å®é˜Ÿåˆ—ä¸­æ¯”è¾ƒé‡è¦çš„ 3 ä¸ªï¼š

ğŸ“š timers

`timers`ï¼Œä¹Ÿå°±æ˜¯**è®¡æ—¶å™¨é˜Ÿåˆ—**ï¼Œè´Ÿè´£å¤„ç† `setTimeout` å’Œ `setInterval` å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡åœ¨æµè§ˆå™¨ä¸­è¿˜æ˜¯ nodejs ä¸­ï¼Œæ‰€æœ‰çš„å®šæ—¶å™¨å›è°ƒå‡½æ•°éƒ½**ä¸èƒ½ä¿è¯**åˆ°è¾¾æ—¶é—´åç«‹å³æ‰§è¡Œã€‚ä¸€æ˜¯å› ä¸ºä»è®¡ç®—æœºç¡¬ä»¶å’Œåº•å±‚æ“ä½œç³»ç»Ÿæ¥çœ‹ï¼Œè®¡æ—¶å™¨çš„å®ç°æœ¬èº«å°±æ˜¯ä¸ç²¾å‡†çš„ï¼ŒäºŒæ˜¯å› ä¸º `poll` é˜¶æ®µå¯¹ `timers` é˜¶æ®µçš„æ·±åˆ»å½±å“ã€‚å› ä¸ºåœ¨æ²¡æœ‰æ»¡è¶³ `poll` é˜¶æ®µçš„ç»“æŸæ¡ä»¶å‰ï¼Œå°±æ— æ³•è¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„ `timers` é˜¶æ®µï¼Œå³ä½¿ `timers` é˜Ÿåˆ—ä¸­å·²ç»æœ‰è®¡æ—¶å™¨åˆ°æœŸçš„å›è°ƒå‡½æ•°ã€‚

ğŸ“š poll

`poll` ç§°ä¸º**è½®è¯¢é˜Ÿåˆ—**ï¼Œè¯¥é˜¶æ®µä¼šå¤„ç†é™¤ `timers` å’Œ `check` é˜Ÿåˆ—å¤–çš„ç»å¤§å¤šæ•° I/O å›è°ƒä»»åŠ¡ï¼Œå¦‚æ–‡ä»¶è¯»å–ã€ç›‘å¬ç”¨æˆ·è¯·æ±‚ç­‰ã€‚

äº‹ä»¶å¾ªç¯åˆ°è¾¾è¯¥é˜¶æ®µæ—¶ï¼Œå®ƒçš„è¿è¡Œæ–¹å¼ä¸ºï¼š

- å¦‚æœ `poll` é˜Ÿåˆ—ä¸­æœ‰å›è°ƒä»»åŠ¡ï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œå›è°ƒç›´åˆ°æ¸…ç©ºé˜Ÿåˆ—ã€‚
- å¦‚æœ `poll` é˜Ÿåˆ—ä¸­æ²¡æœ‰å›è°ƒä»»åŠ¡
  - è‹¥å…¶ä»–é˜Ÿåˆ—ä¸­åç»­å¯èƒ½ä¼šå‡ºç°å›è°ƒä»»åŠ¡ï¼Œåˆ™ä¸€ç›´ç­‰å¾…ï¼Œç­‰å…¶ä»–é˜Ÿåˆ—ä¸­åç»­çš„å›è°ƒä»»åŠ¡æ¥ä¸´æ—¶ï¼Œç»“æŸè¯¥é˜¶æ®µï¼Œå¼€å¯ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
  - è‹¥ç­‰å¾…æ—¶é—´è¶…è¿‡é¢„è®¾çš„æ—¶é—´é™åˆ¶ï¼Œä¹Ÿä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
  - è‹¥å…¶ä»–é˜Ÿåˆ—ä¸­åç»­ä¸å¯èƒ½å†å‡ºç°å›è°ƒä»»åŠ¡äº†ï¼Œåˆ™ç«‹å³ç»“æŸè¯¥é˜¶æ®µï¼Œå¹¶åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯å®Œæˆåï¼Œé€€å‡º node ç¨‹åº

> `poll` é˜¶æ®µçš„è¶…æ—¶æ—¶é—´åœ¨è¿›å…¥ `poll` é˜¶æ®µä¹‹å‰è®¡ç®—ã€‚

ğŸ’ æ¡ˆä¾‹ 1ï¼šä¸ç²¾å‡†çš„è®¡æ—¶å™¨

```javascript
const fs = require("fs");
const start = Date.now();

setTimeout(() => {
  console.log("setTimeout exec", Date.now() - start);
}, 200);

fs.readFile("./index.js", "utf-8", (err, data) => {
  console.log("file read");
  const start = Date.now();
  while (Date.now() - start < 300) {}
});

// è¾“å‡ºç»“æœï¼š
// file read
// setTimeout exec 313ms
```

ğŸ”¨ åˆ†æ 1ï¼š

1.  è¿›å…¥äº‹ä»¶å¾ªç¯åï¼Œå®šæ—¶å™¨è¿˜æ²¡åˆ°æ—¶é—´ï¼Œ`timers` é˜Ÿåˆ—ç©ºï¼Œæ¥åˆ° `poll` é˜¶æ®µ
2.  è¯»å–æ–‡ä»¶éœ€è¦ä¸€å®šæ—¶é—´ï¼Œ`poll` é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…
3.  æ–‡ä»¶è¯»å–å®Œæˆï¼Œå›è°ƒå‡½æ•°åŠ å…¥ `poll` é˜Ÿåˆ—ï¼Œæ‰§è¡Œè¾“å‡º `file read`ï¼Œå¼€å¯å¾ªç¯ï¼Œé˜»å¡ 300ms
4.  å®šæ—¶å™¨åˆ°æ—¶é—´ï¼Œå›è°ƒå‡½æ•°åŠ å…¥ `timers` é˜Ÿåˆ—ï¼Œç”±äº `poll` é˜¶æ®µæœªç»“æŸï¼Œè¢«é˜»å¡ï¼Œç­‰å¾…
5.  `poll` ä¸­çš„å¾ªç¯ç»“æŸï¼Œæ£€æµ‹åˆ° `timers` ä¸­æœ‰ä»»åŠ¡ï¼Œç»“æŸ `poll` é˜¶æ®µï¼Œå¼€å§‹ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯
6.  æ‰§è¡Œ `timers` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œè¾“å‡º `setTimeout exec 313ms`ï¼Œè®¡æ—¶å™¨å›è°ƒå‡½æ•°å¹¶æ²¡æœ‰åœ¨è®¡æ—¶å™¨åˆ°è¾¾æ—¶ç«‹å³æ‰§è¡Œ

ğŸ“š check

`check` ç§°ä¸º**æ£€æŸ¥é˜Ÿåˆ—**ï¼Œè´Ÿè´£å¤„ç† `setImmediate` å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚

`setTimeout` å’Œ `setImmediate` çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ¯æ¬¡æ‰§è¡Œåˆ° `timers` é˜Ÿåˆ—æ—¶ï¼Œå®šæ—¶å™¨è§‚å¯Ÿè€…å†…éƒ¨ä¼šå»**æ£€æŸ¥**ä»£ç ä¸­çš„å®šæ—¶å™¨æ˜¯å¦è¶…è¿‡å®šæ—¶æ—¶é—´ï¼Œè€Œ `setImmediate` åˆ™æ˜¯**ç›´æ¥**å°†å›è°ƒä»»åŠ¡**åŠ å…¥**åˆ° `check` é˜Ÿåˆ—ã€‚

æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œ`setImmediate` çš„æ‰§è¡Œæ•ˆç‡è¦è¿œé«˜äº `setTimeout`ï¼Œäºæ˜¯ä¹Ÿå°±å‡ºç°äº†ä¸‹é¢**æ— æ³•é¢„æµ‹**è¾“å‡ºç»“æœçš„æƒ…å†µï¼š

```javascript
setTimeout(() => {
  console.log("setTimeout");
}, 0);

setImmediate(() => {
  console.log("setImmediate");
});

// ä¸Šè¿°ä»£ç æ˜¯æ— æ³•é¢„æµ‹å…ˆè¾“å‡ºé‚£ä¸ªçš„
// å› ä¸ºå³ä½¿ setTimeout(xxx, 0)ï¼Œåœ¨è®¡ç®—æœºè¿ç®—æ…¢çš„æƒ…å†µä¸‹ä¹Ÿä¸èƒ½ç«‹åˆ»åŠ å…¥ timers é˜Ÿåˆ—
```

å¯¹äºå¾®é˜Ÿåˆ—çš„ `nextTick` å’Œ `Promise`ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šè®²ä¹Ÿä¸å±äºäº‹ä»¶å¾ªç¯ã€‚åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯æ¬¡æ‰“ç®—è¿›å…¥ä¸‹ä¸ªé˜¶æ®µä¹‹å‰ï¼Œå¿…é¡»è¦å…ˆä¾æ¬¡åå¤æ¸…ç©º `nextTick` å’Œ `promise` é˜Ÿåˆ—ï¼Œç›´åˆ°ä¸¤ä¸ªé˜Ÿåˆ—å®Œå…¨æ²¡æœ‰å³å°†è¦åˆ°æ¥çš„ä»»åŠ¡çš„æ—¶å€™å†è¿›å…¥ä¸‹ä¸ªé˜¶æ®µã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `process.nextTick()` å°†å›è°ƒå‡½æ•°åŠ å…¥ `nextTick` é˜Ÿåˆ—ï¼Œå’Œé€šè¿‡ `Promise.resolve().then()` å°†å›è°ƒå‡½æ•°åŠ å…¥ `Promise` é˜Ÿåˆ—ï¼Œä¸” `nextTick` é˜Ÿåˆ—çš„ä¼˜å…ˆçº§è¿˜è¦**é«˜äº** `Promise` é˜Ÿåˆ—ï¼Œæ‰€ä»¥ `process.nextTick` æ˜¯ nodejs ä¸­æ‰§è¡Œ**æœ€å¿«**çš„å¼‚æ­¥æ“ä½œã€‚

ğŸ’ æ¡ˆä¾‹ 2

```javascript
async function async1() {
  console.log("async1 start");
  await async2();
  console.log("async1 end");
}

async function async2() {
  console.log("async2");
}

console.log("script start");

setTimeout(function () {
  console.log("setTimeout0");
}, 0);

setTimeout(function () {
  console.log("setTimeout3");
}, 3);

setImmediate(() => console.log("setImmediate"));

process.nextTick(() => console.log("nextTick"));

async1();

new Promise(function (resolve) {
  console.log("promise1");
  resolve();
  console.log("promise2");
}).then(function () {
  console.log("promise3");
});

console.log("script end");

// è¾“å‡ºç»“æœä¾æ¬¡ä¸ºï¼š
// script start
// async1 start
// async2
// promise1
// promise2
// script end
// nextTick
// async1 end
// promise3
// å‰©ä¸‹çš„ setTimeout0ã€setTimeout3ã€setImmediate é¡ºåºä¸å®š
// å”¯ä¸€èƒ½ç¡®å®šçš„æ˜¯ setTimeout0 åœ¨ setTimeout3 å‰è¾“å‡º
// è€Œ setImmediate å¯èƒ½åœ¨ setTimeout0 å‰ä¹Ÿå¯èƒ½åœ¨ setTimeout3 ä¹‹åï¼Œä¹Ÿå¯èƒ½åœ¨ä¸¤è€…ä¸­é—´
```

ğŸ”¨ åˆ†æ 2ï¼š

1.  æ‰§è¡Œå…¨å±€ä»£ç ï¼Œè¾“å‡º `script start`ã€‚
2.  åˆ°è¾¾ `setTimeout(0)` å’Œ `setTimeout(3)`ï¼Œäº¤ç»™è®¡æ—¶å™¨çº¿ç¨‹å¼€å§‹è®¡æ—¶ï¼Œæ³¨æ„åœ¨çº¿ç¨‹è®¡æ—¶å®Œæˆå‰ï¼Œä¸¤ä¸ªå›è°ƒä»»åŠ¡ `console.log` è¿˜æœªåŠ å…¥ `timers` é˜Ÿåˆ—ã€‚
3.  åˆ°è¾¾ `setImmediate`ï¼Œç«‹åˆ»å°† `console.log` ä»»åŠ¡åŠ å…¥ `check` é˜Ÿåˆ—ã€‚
4.  åˆ°è¾¾ `process.nextTick`ï¼Œç«‹åˆ»å°† `console.log` ä»»åŠ¡åŠ å…¥ `nextTick` é˜Ÿåˆ—ã€‚
5.  æ‰§è¡Œ `async1`ï¼Œè¾“å‡º `async1 start`ã€‚`await async2()` ç«‹åˆ»æ‰§è¡Œ `async2()`ï¼Œè¾“å‡º `async2` å°†åç»­ `console.log` ä»»åŠ¡åŒ…è£…æˆ `Promise.then()` åŠ å…¥ `Promise` é˜Ÿåˆ—ã€‚
6.  æ‰§è¡Œ `new Promise()`ï¼Œè¾“å‡º `promise1`ã€`promise2`ï¼Œè¿™ä¸¤æ­¥æ˜¯åŒæ­¥ä»£ç ã€‚ç„¶åå°† `.then()` é‡Œçš„ `console.log` ä»»åŠ¡æ‰”è¿› `Promise` é˜Ÿåˆ—ã€‚
7.  æ‰§è¡Œæœ€åçš„ `console.log`ï¼Œè¾“å‡º `script end`ã€‚
8.  è‡³æ­¤åŒæ­¥ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­ä»æœ‰ä»»åŠ¡ï¼Œè¿›å…¥äº‹ä»¶å¾ªç¯ã€‚

> æ¢³ç†ä¸€ä¸‹æ­¤æ—¶å„æ¶ˆæ¯é˜Ÿåˆ—çš„çŠ¶æ€ï¼š
>
> å·²æœ‰çš„è¾“å‡ºï¼š`script start`ã€`async1 start`ã€`async2`ã€`promise1`ã€`promise2`ã€`script end`  
> `nextTick` é˜Ÿåˆ—ï¼š`console.log("nextTick")`  
> `Promise` é˜Ÿåˆ—ï¼š`console.log("async1 end")`ã€`console.log("promise3")`  
> `timers` é˜Ÿåˆ—ï¼š`console.log("setTimeout0")`ã€`console.log("setTimeout3")`  
> `check` é˜Ÿåˆ—ï¼š`console.log("setImmediate")`

9.  åœ¨è¿›å…¥ `timers` é˜¶æ®µå‰å…ˆæ¸…ç©ºå¾®é˜Ÿåˆ—ï¼Œå…ˆæ‰§è¡Œ `nextTick` é˜Ÿåˆ—ï¼Œè¾“å‡º `nextTick`ã€‚
10. æ‰§è¡Œ `Promise` é˜Ÿåˆ—ï¼Œä¾æ¬¡è¾“å‡º `async1 end`ã€`promise3`ã€‚
11. è¿›å…¥ `timers` é˜¶æ®µï¼Œç”±äºä¸ç¡®å®šåœ¨åˆ°è¾¾è¿™ä¸ªé˜¶æ®µå‰ï¼Œè®¡æ—¶å™¨çº¿ç¨‹æœ‰æ²¡æœ‰æŠŠå®Œæˆå¯¹ `setTimeout(0)` å’Œ `setTimeout(3)` ä¸­çš„ä¸€è€…æˆ–ä¸¤è€…çš„æ—¶é—´æ£€æŸ¥ï¼Œå¹¶å°†å›è°ƒå‡½æ•°æ¨å…¥ `timers` é˜Ÿåˆ—ï¼Œæ•…æ— æ³•é¢„æµ‹å®ƒä»¬ä¸ `check` é˜Ÿåˆ—ä¸­çš„ `setImmediate` è°å…ˆè¾“å‡ºã€‚

---
