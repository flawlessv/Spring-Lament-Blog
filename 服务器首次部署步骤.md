# 🚀 服务器首次部署步骤

> 在服务器上 clone 代码并执行 `npm install` 后，按照以下步骤操作

---

## ✅ 你已完成

```bash
cd /www/wwwroot/my-next-app
git clone https://github.com/你的用户名/spring-lament-blog.git .
npm install  # 或 npm ci
```

---

## 📝 接下来的步骤

### 第 1 步：创建数据库

**如果使用 PostgreSQL (推荐)：**

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 在 PostgreSQL 命令行中执行：
CREATE DATABASE spring_lament_blog;
CREATE USER blog_user WITH ENCRYPTED PASSWORD '你的强密码';
GRANT ALL PRIVILEGES ON DATABASE spring_lament_blog TO blog_user;
\q  # 退出
```

### 第 2 步：创建环境变量文件

```bash
cd /www/wwwroot/my-next-app

# 创建 .env.production 文件
nano .env.production
```

**填入以下内容：**

```env
# 数据库连接（根据你使用的数据库修改）
# PostgreSQL:
DATABASE_URL="postgresql://blog_user:你的数据库密码@localhost:5432/spring_lament_blog?schema=public"

# NextAuth 密钥（必须生成）
NEXTAUTH_SECRET="在这里粘贴生成的密钥"

# 网站 URL
NEXTAUTH_URL="http://powder.icu"

# 环境
NODE_ENV="production"
```

**生成 NEXTAUTH_SECRET：**

在服务器上执行（另开一个终端或退出 nano 编辑器后执行）：

```bash
openssl rand -base64 32
```

复制输出的字符串，粘贴到上面的 `NEXTAUTH_SECRET` 处。

**保存文件：**

- 按 `Ctrl + O` (保存)
- 按 `回车` (确认)
- 按 `Ctrl + X` (退出)

**设置文件权限：**

```bash
chmod 600 .env.production
```

---

### 第 3 步：生成 Prisma Client

```bash
npm run db:generate
```

这会根据 `prisma/schema.prisma` 生成数据库客户端代码。

---

### 第 4 步：初始化数据库

```bash
npm run db:push
```

这会在数据库中创建所有必要的表（users, posts, categories, tags 等）。

---

### 第 5 步：创建初始管理员账户

```bash
npm run db:seed
```

这会创建默认管理员账户：

- 用户名: `admin`
- 密码: `admin123`
- ⚠️ **登录后务必立即修改密码！**

---

### 第 6 步：构建项目

```bash
npm run build
```

这会构建 Next.js 项目，生成生产环境代码。构建过程可能需要几分钟。

---

### 第 7 步：创建日志目录

```bash
mkdir -p logs
```

---

### 第 8 步：启动应用

**使用 PM2 启动：**

```bash
npm run pm2:start
```

或者直接使用 PM2：

```bash
pm2 start ecosystem.config.js
```

---

### 第 9 步：保存 PM2 配置并设置开机自启

```bash
# 保存 PM2 进程列表
pm2 save

# 设置开机自启动
pm2 startup

# 会输出一行命令，复制并执行，类似：
# sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root
```

---

## ✅ 验证部署

### 1. 检查应用状态

```bash
pm2 status
```

应该看到：

```
┌─────┬──────────────────────┬─────────┬─────────┐
│ id  │ name                 │ status  │ restart │
├─────┼──────────────────────┼─────────┼─────────┤
│ 0   │ spring-lament-blog   │ online  │ 0       │
└─────┴──────────────────────┴─────────┴─────────┘
```

如果 status 是 `online`，说明启动成功！

### 2. 查看日志

```bash
# 查看实时日志
pm2 logs spring-lament-blog

# 查看最近 50 行日志
pm2 logs spring-lament-blog --lines 50
```

### 3. 测试本地访问

```bash
curl http://localhost:80
```

如果返回 HTML 内容，说明应用运行正常。

### 4. 浏览器访问

打开浏览器访问：

- **首页**: http://powder.icu
- **管理后台**: http://powder.icu/admin
- **登录账号**: `admin` / `admin123`

---

## 🐛 如果遇到问题

### 问题 1: 端口 80 被占用

```bash
# 查看占用端口的进程
lsof -i :80

# 或
netstat -tunlp | grep :80

# 如果是其他进程占用，结束它
kill -9 [PID]

# 或者修改端口
# 编辑 package.json 和 ecosystem.config.js，将 80 改为 3000
# 然后修改 Nginx 配置，代理到 3000 端口
```

### 问题 2: PM2 启动失败

```bash
# 查看详细错误
pm2 logs spring-lament-blog --err

# 常见原因：
# 1. 环境变量配置错误
cat .env.production  # 检查配置

# 2. 数据库连接失败
npm run db:push  # 测试数据库连接

# 3. 构建失败
npm run build  # 重新构建

# 4. 权限问题
sudo pm2 start ecosystem.config.js  # 使用 sudo
```

### 问题 3: 数据库连接失败

```bash
# 检查环境变量
cat .env.production

# 测试数据库连接
# PostgreSQL:
psql -U blog_user -d spring_lament_blog -h localhost

# MySQL:
mysql -u blog_user -p -h localhost spring_lament_blog

# 如果无法连接，检查：
# 1. 数据库服务是否运行
systemctl status postgresql  # 或 mysql

# 2. 用户权限是否正确
# 重新执行第 1 步的数据库创建命令
```

### 问题 4: 构建失败（内存不足）

```bash
# 检查内存
free -h

# 如果内存不足，创建交换空间
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久启用
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 重新构建
npm run build
```

---

## 🎯 完整命令列表（复制粘贴版）

如果你想一次性执行所有命令（假设已经创建了数据库和 .env.production）：

```bash
cd /www/wwwroot/my-next-app

# 生成 Prisma Client
npm run db:generate

# 初始化数据库
npm run db:push

# 创建初始管理员
npm run db:seed

# 构建项目
npm run build

# 创建日志目录
mkdir -p logs

# 启动应用
pm2 start ecosystem.config.js

# 保存配置
pm2 save

# 设置开机自启（需要执行输出的命令）
pm2 startup
```

---

## 📚 常用管理命令

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs spring-lament-blog

# 重启应用
pm2 restart spring-lament-blog

# 停止应用
pm2 stop spring-lament-blog

# 删除应用
pm2 delete spring-lament-blog

# 监控资源
pm2 monit
```

---

## 🎉 完成！

如果一切顺利，你的博客现在应该可以通过 http://powder.icu 访问了！

**下一步：**

1. ✅ 登录管理后台修改密码
2. ✅ 配置 Nginx 反向代理（如果还没配置）
3. ✅ 配置 SSL 证书（启用 HTTPS）
4. ✅ 配置 GitHub Secrets（启用自动部署）
5. ✅ 开始写博客！

---

**需要帮助？** 运行状态检查脚本：

```bash
bash scripts/check-status.sh
```
