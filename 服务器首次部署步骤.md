# ğŸš€ æœåŠ¡å™¨é¦–æ¬¡éƒ¨ç½²æ­¥éª¤

> åœ¨æœåŠ¡å™¨ä¸Š clone ä»£ç å¹¶æ‰§è¡Œ `npm install` åï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œ

---

## âœ… ä½ å·²å®Œæˆ

```bash
cd /www/wwwroot/my-next-app
git clone https://github.com/ä½ çš„ç”¨æˆ·å/spring-lament-blog.git .
npm install  # æˆ– npm ci
```

---

## ğŸ“ æ¥ä¸‹æ¥çš„æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºæ•°æ®åº“

**å¦‚æœä½¿ç”¨ PostgreSQL (æ¨è)ï¼š**

```bash
# åˆ‡æ¢åˆ° postgres ç”¨æˆ·
sudo -u postgres psql

# åœ¨ PostgreSQL å‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š
CREATE DATABASE spring_lament_blog;
CREATE USER blog_user WITH ENCRYPTED PASSWORD 'ä½ çš„å¼ºå¯†ç ';
GRANT ALL PRIVILEGES ON DATABASE spring_lament_blog TO blog_user;
\q  # é€€å‡º
```

### ç¬¬ 2 æ­¥ï¼šåˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cd /www/wwwroot/my-next-app

# åˆ›å»º .env.production æ–‡ä»¶
nano .env.production
```

**å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š**

```env
# æ•°æ®åº“è¿æ¥ï¼ˆæ ¹æ®ä½ ä½¿ç”¨çš„æ•°æ®åº“ä¿®æ”¹ï¼‰
# PostgreSQL:
DATABASE_URL="postgresql://blog_user:ä½ çš„æ•°æ®åº“å¯†ç @localhost:5432/spring_lament_blog?schema=public"

# NextAuth å¯†é’¥ï¼ˆå¿…é¡»ç”Ÿæˆï¼‰
NEXTAUTH_SECRET="åœ¨è¿™é‡Œç²˜è´´ç”Ÿæˆçš„å¯†é’¥"

# ç½‘ç«™ URL
NEXTAUTH_URL="http://powder.icu"

# ç¯å¢ƒ
NODE_ENV="production"
```

**ç”Ÿæˆ NEXTAUTH_SECRETï¼š**

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆå¦å¼€ä¸€ä¸ªç»ˆç«¯æˆ–é€€å‡º nano ç¼–è¾‘å™¨åæ‰§è¡Œï¼‰ï¼š

```bash
openssl rand -base64 32
```

å¤åˆ¶è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œç²˜è´´åˆ°ä¸Šé¢çš„ `NEXTAUTH_SECRET` å¤„ã€‚

**ä¿å­˜æ–‡ä»¶ï¼š**

- æŒ‰ `Ctrl + O` (ä¿å­˜)
- æŒ‰ `å›è½¦` (ç¡®è®¤)
- æŒ‰ `Ctrl + X` (é€€å‡º)

**è®¾ç½®æ–‡ä»¶æƒé™ï¼š**

```bash
chmod 600 .env.production
```

---

### ç¬¬ 3 æ­¥ï¼šç”Ÿæˆ Prisma Client

```bash
npm run db:generate
```

è¿™ä¼šæ ¹æ® `prisma/schema.prisma` ç”Ÿæˆæ•°æ®åº“å®¢æˆ·ç«¯ä»£ç ã€‚

---

### ç¬¬ 4 æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
npm run db:push
```

è¿™ä¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ‰€æœ‰å¿…è¦çš„è¡¨ï¼ˆusers, posts, categories, tags ç­‰ï¼‰ã€‚

---

### ç¬¬ 5 æ­¥ï¼šåˆ›å»ºåˆå§‹ç®¡ç†å‘˜è´¦æˆ·

```bash
npm run db:seed
```

è¿™ä¼šåˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼š

- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123`
- âš ï¸ **ç™»å½•ååŠ¡å¿…ç«‹å³ä¿®æ”¹å¯†ç ï¼**

---

### ç¬¬ 6 æ­¥ï¼šæ„å»ºé¡¹ç›®

```bash
npm run build
```

è¿™ä¼šæ„å»º Next.js é¡¹ç›®ï¼Œç”Ÿæˆç”Ÿäº§ç¯å¢ƒä»£ç ã€‚æ„å»ºè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚

---

### ç¬¬ 7 æ­¥ï¼šåˆ›å»ºæ—¥å¿—ç›®å½•

```bash
mkdir -p logs
```

---

### ç¬¬ 8 æ­¥ï¼šå¯åŠ¨åº”ç”¨

**ä½¿ç”¨ PM2 å¯åŠ¨ï¼š**

```bash
npm run pm2:start
```

æˆ–è€…ç›´æ¥ä½¿ç”¨ PM2ï¼š

```bash
pm2 start ecosystem.config.js
```

---

### ç¬¬ 9 æ­¥ï¼šä¿å­˜ PM2 é…ç½®å¹¶è®¾ç½®å¼€æœºè‡ªå¯

```bash
# ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
pm2 startup

# ä¼šè¾“å‡ºä¸€è¡Œå‘½ä»¤ï¼Œå¤åˆ¶å¹¶æ‰§è¡Œï¼Œç±»ä¼¼ï¼š
# sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root
```

---

## âœ… éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥åº”ç”¨çŠ¶æ€

```bash
pm2 status
```

åº”è¯¥çœ‹åˆ°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name                 â”‚ status  â”‚ restart â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ spring-lament-blog   â”‚ online  â”‚ 0       â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚æœ status æ˜¯ `online`ï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸï¼

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs spring-lament-blog

# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œæ—¥å¿—
pm2 logs spring-lament-blog --lines 50
```

### 3. æµ‹è¯•æœ¬åœ°è®¿é—®

```bash
curl http://localhost:80
```

å¦‚æœè¿”å› HTML å†…å®¹ï¼Œè¯´æ˜åº”ç”¨è¿è¡Œæ­£å¸¸ã€‚

### 4. æµè§ˆå™¨è®¿é—®

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

- **é¦–é¡µ**: http://powder.icu
- **ç®¡ç†åå°**: http://powder.icu/admin
- **ç™»å½•è´¦å·**: `admin` / `admin123`

---

## ğŸ› å¦‚æœé‡åˆ°é—®é¢˜

### é—®é¢˜ 1: ç«¯å£ 80 è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :80

# æˆ–
netstat -tunlp | grep :80

# å¦‚æœæ˜¯å…¶ä»–è¿›ç¨‹å ç”¨ï¼Œç»“æŸå®ƒ
kill -9 [PID]

# æˆ–è€…ä¿®æ”¹ç«¯å£
# ç¼–è¾‘ package.json å’Œ ecosystem.config.jsï¼Œå°† 80 æ”¹ä¸º 3000
# ç„¶åä¿®æ”¹ Nginx é…ç½®ï¼Œä»£ç†åˆ° 3000 ç«¯å£
```

### é—®é¢˜ 2: PM2 å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pm2 logs spring-lament-blog --err

# å¸¸è§åŸå› ï¼š
# 1. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
cat .env.production  # æ£€æŸ¥é…ç½®

# 2. æ•°æ®åº“è¿æ¥å¤±è´¥
npm run db:push  # æµ‹è¯•æ•°æ®åº“è¿æ¥

# 3. æ„å»ºå¤±è´¥
npm run build  # é‡æ–°æ„å»º

# 4. æƒé™é—®é¢˜
sudo pm2 start ecosystem.config.js  # ä½¿ç”¨ sudo
```

### é—®é¢˜ 3: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat .env.production

# æµ‹è¯•æ•°æ®åº“è¿æ¥
# PostgreSQL:
psql -U blog_user -d spring_lament_blog -h localhost

# MySQL:
mysql -u blog_user -p -h localhost spring_lament_blog

# å¦‚æœæ— æ³•è¿æ¥ï¼Œæ£€æŸ¥ï¼š
# 1. æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
systemctl status postgresql  # æˆ– mysql

# 2. ç”¨æˆ·æƒé™æ˜¯å¦æ­£ç¡®
# é‡æ–°æ‰§è¡Œç¬¬ 1 æ­¥çš„æ•°æ®åº“åˆ›å»ºå‘½ä»¤
```

### é—®é¢˜ 4: æ„å»ºå¤±è´¥ï¼ˆå†…å­˜ä¸è¶³ï¼‰

```bash
# æ£€æŸ¥å†…å­˜
free -h

# å¦‚æœå†…å­˜ä¸è¶³ï¼Œåˆ›å»ºäº¤æ¢ç©ºé—´
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ä¹…å¯ç”¨
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# é‡æ–°æ„å»º
npm run build
```

---

## ğŸ¯ å®Œæ•´å‘½ä»¤åˆ—è¡¨ï¼ˆå¤åˆ¶ç²˜è´´ç‰ˆï¼‰

å¦‚æœä½ æƒ³ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ï¼ˆå‡è®¾å·²ç»åˆ›å»ºäº†æ•°æ®åº“å’Œ .env.productionï¼‰ï¼š

```bash
cd /www/wwwroot/my-next-app

# ç”Ÿæˆ Prisma Client
npm run db:generate

# åˆå§‹åŒ–æ•°æ®åº“
npm run db:push

# åˆ›å»ºåˆå§‹ç®¡ç†å‘˜
npm run db:seed

# æ„å»ºé¡¹ç›®
npm run build

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜é…ç½®
pm2 save

# è®¾ç½®å¼€æœºè‡ªå¯ï¼ˆéœ€è¦æ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤ï¼‰
pm2 startup
```

---

## ğŸ“š å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs spring-lament-blog

# é‡å¯åº”ç”¨
pm2 restart spring-lament-blog

# åœæ­¢åº”ç”¨
pm2 stop spring-lament-blog

# åˆ é™¤åº”ç”¨
pm2 delete spring-lament-blog

# ç›‘æ§èµ„æº
pm2 monit
```

---

## ğŸ‰ å®Œæˆï¼

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ çš„åšå®¢ç°åœ¨åº”è¯¥å¯ä»¥é€šè¿‡ http://powder.icu è®¿é—®äº†ï¼

**ä¸‹ä¸€æ­¥ï¼š**

1. âœ… ç™»å½•ç®¡ç†åå°ä¿®æ”¹å¯†ç 
2. âœ… é…ç½® Nginx åå‘ä»£ç†ï¼ˆå¦‚æœè¿˜æ²¡é…ç½®ï¼‰
3. âœ… é…ç½® SSL è¯ä¹¦ï¼ˆå¯ç”¨ HTTPSï¼‰
4. âœ… é…ç½® GitHub Secretsï¼ˆå¯ç”¨è‡ªåŠ¨éƒ¨ç½²ï¼‰
5. âœ… å¼€å§‹å†™åšå®¢ï¼

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** è¿è¡ŒçŠ¶æ€æ£€æŸ¥è„šæœ¬ï¼š

```bash
bash scripts/check-status.sh
```
