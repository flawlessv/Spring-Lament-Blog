# 🚀 Spring Lament Blog 部署指南

## ⚠️ 关键注意事项

### 1. 环境变量文件管理

> **🔴 重要：生产环境不要有 `.env` 文件！**

- **本地开发**：使用 `.env.local`
- **生产环境**：只用 `.env.production`

**原因**：Prisma 优先读取 `.env`，如果存在会忽略 `.env.production`，导致数据库操作错误。

```bash
# 服务器上检查
cd /www/wwwroot/my-next-app
ls -la .env*       # 应该只有 .env.production
rm .env            # 如果存在就删除
```

### 2. NextAuth URL 配置

> **🔴 重要：NEXTAUTH_URL 末尾不要加斜杠！**

- ✅ 正确：`NEXTAUTH_URL="http://powder.icu"`
- ❌ 错误：`NEXTAUTH_URL="http://powder.icu/"`

### 3. PM2 环境变量更新

修改 `.env.production` 后，必须**完全重启**：

```bash
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save
```

**不要用** `pm2 restart`！

---

## 📋 首次部署

### 1. 克隆代码

```bash
ssh root@42.193.227.185
cd /www/wwwroot/my-next-app
git clone https://github.com/你的用户名/Spring-Lament-Blog.git .
npm install
```

### 2. 配置环境变量

创建 `.env.production` 文件：

```bash
nano .env.production
```

填入内容：

```env
# 数据库（SQLite 简单，PostgreSQL 生产推荐）
DATABASE_URL="file:./prod.db"

# NextAuth 密钥（生成命令：openssl rand -base64 32）
NEXTAUTH_SECRET="粘贴生成的密钥"

# 网站地址（不要加斜杠）
NEXTAUTH_URL="http://powder.icu"

NODE_ENV="production"
```

保存并设置权限：

```bash
chmod 600 .env.production
```

### 3. 删除 .env 文件

```bash
ls -la .env*
rm .env  # 如果存在
```

### 4. 初始化数据库

```bash
npm run db:generate
npm run db:push
npm run db:seed
```

### 5. 构建和启动

```bash
npm run build
mkdir -p logs
pm2 start ecosystem.config.js
pm2 save
pm2 startup  # 设置开机自启，执行输出的命令
```

### 6. 验证部署

```bash
pm2 status                      # 应该显示 online
curl http://localhost:3000      # 测试访问
```

浏览器访问：

- 首页：http://powder.icu
- 后台：http://powder.icu/admin
- 账号：`admin` / `0919`

---

## 🔄 代码更新（三种方式）

### 方法 1：使用脚本（推荐 ⭐）

**优势**：

- ✅ 一条命令完成所有步骤
- ✅ 自动备份当前版本
- ✅ 出问题可以快速回滚

**步骤**：

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 进入项目目录
cd /www/wwwroot/my-next-app

# 3. 运行更新脚本
bash scripts/update-deploy.sh
```

**脚本自动执行**：

- 📦 备份当前版本到 `../backups/backup-YYYYMMDD-HHMMSS/`
- 📥 拉取最新代码 `git pull`
- 📦 更新依赖 `npm ci --production`
- ❓ 询问是否需要更新数据库
- 🔨 重新构建 `npm run build`
- 🔄 重启应用 `pm2 restart`

**如果更新失败，回滚**：

```bash
# 脚本会显示备份位置，例如：
# 备份完成: ../backups/backup-20251010-143000

# 复制备份回来
cp -r ../backups/backup-20251010-143000/* /www/wwwroot/my-next-app/
pm2 restart spring-lament-blog
```

---

### 方法 2：GitHub Actions 自动部署（最方便 ⭐⭐⭐）

**优势**：

- 🚀 完全自动化，推送代码即部署
- 🎯 不需要登录服务器
- 📊 GitHub 可视化查看部署状态和日志
- ⏱️ 节省大量时间

**前提条件**：已配置好 GitHub Secrets（见下面的详细说明）

**使用步骤**：

```bash
# 1. 在本地修改代码
git add .
git commit -m "添加新功能"

# 2. 推送到 GitHub
git push origin main

# 3. 自动部署开始！
# GitHub Actions 会自动：
# - 检出代码
# - 安装依赖
# - 构建项目
# - 上传到服务器
# - 重启应用
```

**查看部署状态**：

1. 打开 GitHub 仓库页面
2. 点击顶部 **Actions** 标签
3. 查看最新的工作流运行状态
   - 绿色 ✅ = 部署成功
   - 红色 ❌ = 部署失败，点击查看错误日志

**注意**：

- ⚠️ 只有推送到 `main` 分支才会触发部署
- ⚠️ 如果在其他分支开发，需要先合并到 `main`

---

### 方法 3：手动更新（完全手动控制）

**优势**：

- 🎯 精确控制每一步
- 🔍 适合学习理解部署流程
- 🆘 自动脚本出问题时的备用方案

**完整步骤**：

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 进入项目目录
cd /www/wwwroot/my-next-app

# 3. 拉取最新代码
git pull origin main

# 如果提示冲突，强制覆盖本地修改：
git fetch origin
git reset --hard origin/main

# 4. 更新依赖（如果 package.json 有变化）
npm install

# 5. 如果修改了数据库结构
# ⚠️ 重要：先删除 .env 文件
rm .env
npm run db:push

# 6. 重新构建
npm run build

# 7. 重启应用（如果修改了 .env.production）
pm2 delete spring-lament-blog
pm2 start ecosystem.config.js
pm2 save

# 或者只是重启（没有修改环境变量）
pm2 restart spring-lament-blog

# 8. 验证
pm2 status
pm2 logs spring-lament-blog --lines 20
```

---

### 📊 三种方法对比

| 特性         | 脚本更新 | GitHub Actions | 手动更新 |
| ------------ | -------- | -------------- | -------- |
| **难度**     | ⭐ 简单  | ⭐⭐ 中等      | ⭐⭐⭐   |
| **速度**     | 快       | 较快           | 慢       |
| **自动化**   | 半自动   | 全自动         | 手动     |
| **需登录**   | 是       | 否             | 是       |
| **自动备份** | 是       | 否             | 否       |
| **推荐度**   | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐     | ⭐⭐     |

**建议**：

- 日常开发：使用 **GitHub Actions**（最省心）
- 紧急修复：使用 **脚本更新**（有备份更安全）
- 学习调试：使用 **手动更新**（理解每一步）

---

## 🤖 GitHub Actions 配置

### 配置 7 个 GitHub Secrets

> 自动部署需要在 GitHub 仓库配置这 7 个密钥

#### 添加 Secrets 的位置

`你的仓库` → `Settings` → `Secrets and variables` → `Actions` → `New repository secret`

---

### 1️⃣ SERVER_HOST（服务器 IP）

**值**：`42.193.227.185`

**如何获取**：

- 这是你的**腾讯云服务器 IP 地址**
- 在腾讯云控制台 → 云服务器 → 实例列表中查看
- 或者在宝塔面板右上角可以看到服务器 IP

---

### 2️⃣ SERVER_USER（SSH 用户名）

**值**：`root`

**说明**：

- 服务器的 SSH 登录用户名
- 通常是 `root`（Linux 最高权限用户）
- 如果使用其他用户，填写对应的用户名

---

### 3️⃣ SERVER_SSH_KEY（SSH 私钥）

**如何生成和获取**：

```bash
# 1. SSH 登录到服务器
ssh root@42.193.227.185

# 2. 生成 SSH 密钥对（提示输入密码时直接回车）
ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions_rsa

# 输出示例：
# Generating public/private rsa key pair.
# Enter passphrase (empty for no passphrase): [直接回车]
# Enter same passphrase again: [直接回车]
# Your identification has been saved in /root/.ssh/github_actions_rsa
# Your public key has been saved in /root/.ssh/github_actions_rsa.pub

# 3. 将公钥添加到授权列表
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 4. 查看私钥（复制所有内容，包括 BEGIN 和 END 行）
cat ~/.ssh/github_actions_rsa
```

**复制的内容示例**：

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAA...
（很多行）
...AAAADGdpdGh1Yi1hY3Rpb25zAQ==
-----END OPENSSH PRIVATE KEY-----
```

**⚠️ 注意**：必须复制完整内容，包括第一行和最后一行！

---

### 4️⃣ SERVER_PORT（SSH 端口）

**值**：`22`

**说明**：

- SSH 默认端口是 `22`
- 如果你修改过 SSH 端口，填写修改后的端口号
- 在服务器上查看：`cat /etc/ssh/sshd_config | grep Port`

---

### 5️⃣ DATABASE_URL（数据库连接）

**SQLite（简单）**：

```
file:./prod.db
```

**PostgreSQL（推荐生产）**：

```
postgresql://用户名:密码@localhost:5432/数据库名?schema=public
```

**示例**：

```
postgresql://blog_user:MyStr0ngP@ssw0rd@localhost:5432/spring_lament_blog?schema=public
```

**如何获取**：

- 这是你在服务器上创建数据库时设置的
- 用户名和密码是你自己定义的
- 如果忘记了，可以在服务器的 `.env.production` 文件中查看

---

### 6️⃣ NEXTAUTH_SECRET（NextAuth 密钥）

**如何生成**：

在**服务器上**或**本地终端**运行：

```bash
openssl rand -base64 32
```

**输出示例**：

```
Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX
```

**⚠️ 注意**：

- 这是一个随机生成的强密钥
- 用于加密用户会话，必须保密
- 复制生成的字符串作为 Secret 值

---

### 7️⃣ NEXTAUTH_URL（网站地址）

**值**：`http://powder.icu`

**说明**：

- 你的网站完整地址
- HTTP 版本：`http://powder.icu`
- HTTPS 版本（配置 SSL 后）：`https://powder.icu`
- **⚠️ 末尾不要加斜杠！**

---

### 📝 添加 Secrets 的步骤

1. 打开 GitHub 仓库页面
2. 点击 `Settings`（设置）
3. 左侧菜单点击 `Secrets and variables` → `Actions`
4. 点击 `New repository secret` 按钮
5. 填写：
   - **Name**：Secret 名称（如 `SERVER_HOST`）
   - **Secret**：对应的值（如 `42.193.227.185`）
6. 点击 `Add secret` 保存
7. 重复以上步骤，添加所有 7 个 Secrets

---

### ✅ 配置完成检查

添加完所有 Secrets 后，你应该看到：

```
SERVER_HOST
SERVER_USER
SERVER_SSH_KEY
SERVER_PORT
DATABASE_URL
NEXTAUTH_SECRET
NEXTAUTH_URL
```

**测试自动部署**：

```bash
git add .
git commit -m "test: 测试自动部署"
git push origin main
```

然后在 GitHub 仓库的 **Actions** 标签查看部署状态！

---

## 🛠️ 常用命令

### PM2 管理

```bash
pm2 status                      # 查看状态
pm2 logs spring-lament-blog     # 查看日志
pm2 restart spring-lament-blog  # 重启
pm2 stop spring-lament-blog     # 停止
pm2 delete spring-lament-blog   # 删除
pm2 monit                       # 监控
```

### 数据库管理

```bash
npm run db:generate  # 生成 Prisma Client
npm run db:push      # 同步数据库结构
npm run db:seed      # 创建初始数据
npm run db:studio    # 数据库管理界面
```

---

## 🐛 常见问题

### 502 Bad Gateway

```bash
pm2 status
pm2 logs spring-lament-blog --err --lines 50
pm2 restart spring-lament-blog
```

### 数据库连接失败

```bash
cat .env.production  # 检查配置
npm run db:push      # 测试连接
```

### 端口 80 被占用

```bash
lsof -i :80          # 查看占用进程
kill -9 [PID]        # 结束进程
```

### npm install 失败

```bash
rm -rf node_modules .next
npm cache clean --force
npm install
```

---

## 🎯 Nginx 配置

在宝塔面板 → 网站设置 → 配置文件，添加：

```nginx
server {
    listen 80;
    server_name powder.icu;
    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## ✅ 部署检查清单

### 部署前

- [ ] 服务器已安装 Node.js 20.x
- [ ] 服务器已安装 PM2
- [ ] 域名已解析到服务器

### 部署中

- [ ] 代码已克隆
- [ ] `.env.production` 已配置
- [ ] 删除了 `.env` 文件
- [ ] 数据库已初始化
- [ ] 项目已构建
- [ ] PM2 已启动

### 部署后

- [ ] PM2 状态为 online
- [ ] 网站可以访问
- [ ] 可以登录后台
- [ ] 已修改默认密码
- [ ] GitHub Secrets 已配置（可选）

---

## 🎉 完成！

**访问地址**：

- 首页：http://powder.icu
- 后台：http://powder.icu/admin
- 账号：`admin` / `0919`

**下一步**：

1. 修改默认密码
2. 配置 SSL 证书（推荐）
3. 测试 GitHub Actions 自动部署

**需要帮助？**

- 查看日志：`pm2 logs spring-lament-blog`
- 状态检查：`bash scripts/check-status.sh`
