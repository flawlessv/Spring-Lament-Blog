name: 部署到腾讯云服务器

on:
  push:
    branches:
      - main  # 当推送到 main 分支时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: |
          # 跳过 postinstall 避免在没有数据库时失败
          npm ci --ignore-scripts
          
      - name: 生成 Prisma Client
        run: npm run db:generate

      - name: 构建项目
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

      # 使用 SCP 上传文件到服务器
      - name: 部署到服务器
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}          # 服务器 IP 地址
          username: ${{ secrets.SERVER_USER }}      # SSH 用户名（通常是 root）
          key: ${{ secrets.SERVER_SSH_KEY }}        # SSH 私钥（推荐使用密钥）
          port: ${{ secrets.SERVER_PORT || 22 }}    # SSH 端口（默认 22）
          source: "." # 上传整个项目目录
          target: "/www/wwwroot/my-next-app"        # 服务器项目路径
          strip_components: 0

      # SSH 连接服务器执行部署命令
      - name: 在服务器上重启应用
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}          # 服务器 IP 地址
          username: ${{ secrets.SERVER_USER }}      # SSH 用户名
          key: ${{ secrets.SERVER_SSH_KEY }}        # SSH 私钥
          port: ${{ secrets.SERVER_PORT || 22 }}    # SSH 端口
          script: |
            cd /www/wwwroot/my-next-app
            npm ci --production
            npm run db:push
            pm2 restart spring-lament-blog || pm2 start ecosystem.config.js
