name: éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ä½¿ç”¨ SCP ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}          # æœåŠ¡å™¨ IP åœ°å€
          username: ${{ secrets.SERVER_USER }}      # SSH ç”¨æˆ·å
          key: ${{ secrets.SERVER_SSH_KEY }}        # SSH ç§é’¥
          port: ${{ secrets.SERVER_PORT || 22 }}    # SSH ç«¯å£
          source: "."                               # ä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•
          target: "/www/wwwroot/my-next-app"        # æœåŠ¡å™¨ä¸Šçš„ç›®æ ‡ç›®å½•
          overwrite: true                           # è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
          rm: false                                 # ä¸åˆ é™¤ç›®æ ‡ç›®å½•å…¶ä»–æ–‡ä»¶ï¼ˆä¿ç•™ .env.productionï¼‰

      # åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
      - name: åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 30 åˆ†é’Ÿ
          script: |
            cd /www/wwwroot/my-next-app

            # æ£€æŸ¥ package.json æ˜¯å¦æœ‰å˜åŒ–
            if [ -f "node_modules/.package-lock.json" ]; then
              echo "=== æ£€æŸ¥ä¾èµ–æ˜¯å¦éœ€è¦æ›´æ–° ==="
              CURRENT_HASH=$(md5sum package.json package-lock.json 2>/dev/null | md5sum | cut -d' ' -f1)
              CACHED_HASH=$(cat node_modules/.dep-hash 2>/dev/null || echo "")

              if [ "$CURRENT_HASH" = "$CACHED_HASH" ]; then
                echo "âœ… ä¾èµ–æœªå˜åŒ–ï¼Œè·³è¿‡å®‰è£…"
                exit 0
              fi
            fi

            echo "=== å®‰è£…ä¾èµ– ==="
            npm install --registry=https://registry.npmmirror.com --no-audit --no-fund --production=false

            # ä¿å­˜ä¾èµ–å“ˆå¸Œå€¼
            md5sum package.json package-lock.json 2>/dev/null | md5sum | cut -d' ' -f1 > node_modules/.dep-hash
            echo "=== ä¾èµ–å®‰è£…å®Œæˆ ==="

      # åœ¨æœåŠ¡å™¨ä¸Šé…ç½®ç¯å¢ƒå˜é‡å¹¶æ„å»ºé¡¹ç›®
      - name: åœ¨æœåŠ¡å™¨ä¸Šæ„å»ºé¡¹ç›®
        uses: appleboy/ssh-action@master
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
          KIMI_BASE_URL: ${{ secrets.KIMI_BASE_URL }}
          KIMI_MODEL: ${{ secrets.KIMI_MODEL }}
          OLLAMA_BASE_URL: ${{ secrets.OLLAMA_BASE_URL }}
          OLLAMA_EMBEDDING_MODEL: ${{ secrets.OLLAMA_EMBEDDING_MODEL }}
          CHROMADB_HOST: ${{ secrets.CHROMADB_HOST }}
          CHROMADB_PORT: ${{ secrets.CHROMADB_PORT }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 20m
          envs: DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,KIMI_API_KEY,KIMI_BASE_URL,KIMI_MODEL,OLLAMA_BASE_URL,OLLAMA_EMBEDDING_MODEL,CHROMADB_HOST,CHROMADB_PORT
          script: |
            cd /www/wwwroot/my-next-app

            echo "=== é…ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶ ==="
            cat > .env.production << EOF
            DATABASE_URL="${DATABASE_URL}"
            NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
            NEXTAUTH_URL="${NEXTAUTH_URL}"
            NODE_ENV="production"
            EOF

            # æ·»åŠ  AI é…ç½®ï¼ˆå¦‚æœæä¾›äº† AI ç›¸å…³çš„ Secretsï¼‰
            if [ -n "${KIMI_API_KEY}" ]; then
              echo "KIMI_API_KEY=\"${KIMI_API_KEY}\"" >> .env.production
              echo "KIMI_BASE_URL=\"${KIMI_BASE_URL:-https://api.moonshot.cn/v1}\"" >> .env.production
              echo "KIMI_MODEL=\"${KIMI_MODEL:-moonshot-v1-32k}\"" >> .env.production
              echo "OLLAMA_BASE_URL=\"${OLLAMA_BASE_URL:-http://localhost:11434}\"" >> .env.production
              echo "OLLAMA_EMBEDDING_MODEL=\"${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}\"" >> .env.production
              echo "CHROMADB_HOST=\"${CHROMADB_HOST:-localhost}\"" >> .env.production
              echo "CHROMADB_PORT=\"${CHROMADB_PORT:-8000}\"" >> .env.production
              echo "âœ… AI é…ç½®å·²æ·»åŠ "
            else
              echo "âš ï¸  æœªé…ç½® AI ç›¸å…³ç¯å¢ƒå˜é‡ï¼ˆAI åŠŸèƒ½å°†ä¸å¯ç”¨ï¼‰"
            fi

            chmod 600 .env.production
            echo "ç¯å¢ƒå˜é‡æ–‡ä»¶å·²æ›´æ–°"

            echo "=== ç”Ÿæˆ Prisma Client ==="
            export DATABASE_URL="${DATABASE_URL}"
            npx prisma generate

            echo "=== æ¨é€æ•°æ®åº“å˜æ›´ ==="
            npx prisma db push

            echo "=== æ¸…ç†æ—§çš„ Next.js æ„å»ºäº§ç‰© ==="
            rm -rf .next


            echo "=== æ„å»º Next.js é¡¹ç›® ==="
            echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"


            # è¿è¡Œæ„å»ºï¼Œç¡®ä¿ç­‰å¾…å®Œæˆ
            npm run build 2>&1 | tee build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}

            echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "æ„å»ºé€€å‡ºç : $BUILD_EXIT_CODE"

            if [ $BUILD_EXIT_CODE -ne 0 ]; then
                echo "âŒ æ„å»ºå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $BUILD_EXIT_CODE"
                echo "=== æ„å»ºæ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰ ==="
                tail -100 build.log
                exit 1
            fi

            echo "âœ… æ„å»ºå‘½ä»¤æ‰§è¡Œå®Œæˆ"

            echo "=== éªŒè¯æ„å»ºæ˜¯å¦æˆåŠŸ ==="
            if [ ! -d ".next" ]; then
                echo "âŒ é”™è¯¯: æ„å»ºå¤±è´¥ï¼Œ.next ç›®å½•æœªç”Ÿæˆ"
                exit 1
            fi

            if [ ! -f ".next/BUILD_ID" ]; then
                echo "âŒ é”™è¯¯: æ„å»ºä¸å®Œæ•´ï¼ŒBUILD_ID æ–‡ä»¶ç¼ºå¤±"
                exit 1
            fi

            echo "âœ… æ„å»ºéªŒè¯æˆåŠŸ"
            echo "Build ID: $(cat .next/BUILD_ID)"
            ls -lh .next/ | head -20

      # å¯åŠ¨ AI æœåŠ¡ï¼ˆå¦‚æœé…ç½®äº† AI ç›¸å…³ç¯å¢ƒå˜é‡ï¼‰
      - name: å¯åŠ¨ AI æœåŠ¡
        uses: appleboy/ssh-action@master
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 10m
          script: |
            cd /www/wwwroot/my-next-app

            # å¦‚æœæ²¡æœ‰é…ç½® Kimi API Keyï¼Œè·³è¿‡ AI æœåŠ¡å¯åŠ¨
            if [ -z "${KIMI_API_KEY}" ]; then
              echo "âš ï¸  æœªé…ç½® AI æœåŠ¡ï¼Œè·³è¿‡ Ollama å’Œ ChromaDB å¯åŠ¨"
              exit 0
            fi

            echo "=== å¯åŠ¨ AI æœåŠ¡ ==="

            # 1. å¯åŠ¨ Ollama
            echo "ğŸ¤– æ£€æŸ¥ Ollama æœåŠ¡..."
            if pgrep -f "ollama serve" > /dev/null; then
                echo "âœ… Ollama å·²åœ¨è¿è¡Œ"
            else
                echo "å¯åŠ¨ Ollama..."
                nohup ollama serve > /tmp/ollama.log 2>&1 &
                sleep 5

                if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
                    echo "âœ… Ollama å¯åŠ¨æˆåŠŸ"
                else
                    echo "âŒ Ollama å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f /tmp/ollama.log"
                    exit 1
                fi
            fi

            # 2. æ£€æŸ¥å¹¶ä¸‹è½½ Embedding æ¨¡å‹
            echo "ğŸ” æ£€æŸ¥ Embedding æ¨¡å‹..."
            if ollama list 2>/dev/null | grep -q "nomic-embed-text"; then
                echo "âœ… æ¨¡å‹å·²å®‰è£…"
            else
                echo "ä¸‹è½½ nomic-embed-text æ¨¡å‹..."
                ollama pull nomic-embed-text
                echo "âœ… æ¨¡å‹ä¸‹è½½å®Œæˆ"
            fi

            # 3. å¯åŠ¨ ChromaDB
            echo "ğŸ“¦ æ£€æŸ¥ ChromaDB æœåŠ¡..."
            if pgrep -f "chromadb" > /dev/null || pgrep -f "chroma run" > /dev/null; then
                echo "âœ… ChromaDB å·²åœ¨è¿è¡Œ"
            else
                # åˆ›å»ºæ•°æ®ç›®å½•
                mkdir -p /www/wwwroot/my-next-app/data/chroma

                echo "å¯åŠ¨ ChromaDB..."
                nohup npx chromadb run --path /www/wwwroot/my-next-app/data/chroma --port 8000 > /tmp/chromadb.log 2>&1 &
                sleep 5

                if curl -s http://localhost:8000/api/v1/heartbeat > /dev/null 2>&1; then
                    echo "âœ… ChromaDB å¯åŠ¨æˆåŠŸ"
                else
                    echo "âŒ ChromaDB å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f /tmp/chromadb.log"
                    exit 1
                fi
            fi

            echo "âœ… AI æœåŠ¡å¯åŠ¨å®Œæˆ"
            echo "   Ollama:   http://localhost:11434"
            echo "   ChromaDB: http://localhost:8000"

      # é‡å¯ PM2 åº”ç”¨
      - name: é‡å¯åº”ç”¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 3m
          script: |
            cd /www/wwwroot/my-next-app

            echo "=== æ£€æŸ¥ç¯å¢ƒ ==="
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "PM2 version: $(pm2 --version)"

            echo "=== æ£€æŸ¥ .next ç›®å½• ==="
            if [ ! -d ".next" ]; then
                echo "âŒ é”™è¯¯: .next ç›®å½•ä¸å­˜åœ¨"
                exit 1
            fi
            echo "âœ… .next ç›®å½•å­˜åœ¨"

            echo "=== æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶ ==="
            if [ ! -f ".env.production" ]; then
                echo "âŒ é”™è¯¯: .env.production æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
            fi
            echo "âœ… .env.production æ–‡ä»¶å­˜åœ¨"

            echo "=== åœæ­¢æ—§åº”ç”¨è¿›ç¨‹ ==="
            pm2 stop spring-broken-ai-blog || true
            sleep 2

            echo "=== åˆ é™¤æ—§è¿›ç¨‹ ==="
            pm2 delete spring-broken-ai-blog || true

            echo "=== å¯åŠ¨åº”ç”¨ ==="
            pm2 start ecosystem.config.js --env production --update-env

            echo "=== ç­‰å¾…åº”ç”¨å¯åŠ¨ ==="
            sleep 15

            echo "=== éªŒè¯åº”ç”¨çŠ¶æ€ ==="
            pm2 list

            if pm2 list | grep -q "spring-broken-ai-blog.*online"; then
                echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"

                echo "=== æ£€æŸ¥ç«¯å£ 3000 æ˜¯å¦ç›‘å¬ ==="
                if netstat -tuln | grep -q ":3000"; then
                    echo "âœ… ç«¯å£ 3000 æ­£åœ¨ç›‘å¬"
                else
                    echo "âš ï¸  è­¦å‘Š: ç«¯å£ 3000 æœªç›‘å¬ï¼Œä½†è¿›ç¨‹æ˜¾ç¤º online"
                fi
            else
                echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"
                echo "=== PM2 è¿›ç¨‹è¯¦æƒ… ==="
                pm2 describe spring-broken-ai-blog || true
                echo "=== æœ€è¿‘æ—¥å¿— ==="
                pm2 logs spring-broken-ai-blog --lines 50 --nostream || true
                exit 1
            fi

            pm2 save
            echo "=== éƒ¨ç½²å®Œæˆ ==="
