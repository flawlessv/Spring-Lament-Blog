# ✅ Spring Lament Blog - 部署配置清单

> 所有配置已完成！现在可以部署到服务器了

---

## 📊 配置修复总结

### ✅ 已修复的问题

1. **next.config.js 配置错误** - 已修复
   - ❌ 删除了错误的 `basePath: "http://powder.icu/"`
   - ❌ 删除了 `output: "export"` (会导致 API 路由失败)
   - ✅ 现在配置正确，可以正常构建

2. **路径配置** - 已更新
   - 项目路径: `/www/wwwroot/my-next-app`
   - 应用端口: `80`
   - 所有脚本和配置已同步更新

3. **构建测试** - ✅ 通过
   ```
   ✓ Compiled successfully
   ✓ Linting and checking validity of types
   ✓ Generating static pages (22/22)
   ```

---

## 📁 新增的文件

### 部署配置文件

- ✅ `.github/workflows/deploy.yml` - GitHub Actions 自动部署
- ✅ `.gitignore` - Git 忽略文件配置
- ✅ `ecosystem.config.js` - PM2 配置（已更新路径和端口）

### 部署脚本

- ✅ `scripts/deploy-setup.sh` - 首次部署脚本
- ✅ `scripts/update-deploy.sh` - 更新部署脚本
- ✅ `scripts/check-status.sh` - 状态检查脚本
- ✅ `scripts/README.md` - 脚本使用说明

### 文档

- ✅ `docs/COMPLETE-DEPLOYMENT-GUIDE.md` - 完整部署指南（⭐ 主文档）
- ✅ `docs/QUICK-START-DEPLOY.md` - 快速开始指南
- ✅ `docs/ENVIRONMENT-SETUP.md` - 环境变量配置详解
- ✅ `docs/BAOTA-DEPLOYMENT.md` - 宝塔面板部署指南
- ✅ `DEPLOYMENT-README.md` - 部署配置总结
- ✅ `部署配置清单.md` - 本文档

---

## 🎯 服务器配置信息

```yaml
# 服务器信息
IP地址: 42.193.227.185
域名: powder.icu
SSH端口: 22

# 项目配置
项目路径: /www/wwwroot/my-next-app
应用端口: 80
Node版本: 20.x
进程名称: spring-lament-blog

# 部署方式
Web服务器: Nginx (反向代理)
进程管理: PM2
面板: 宝塔面板
数据库: PostgreSQL (推荐) / MySQL / SQLite
```

---

## 🚀 部署步骤（3 步）

### 第 1 步：宝塔面板创建网站

1. 登录宝塔面板：`http://42.193.227.185:8888`
2. 添加站点：
   - 域名：`powder.icu`
   - 根目录：`/www/wwwroot/my-next-app`
   - PHP：纯静态
3. 配置 Nginx（见后面的详细配置）

### 第 2 步：上传代码

```bash
# SSH 登录服务器
ssh root@42.193.227.185

# 克隆代码
cd /www/wwwroot/my-next-app
git clone https://github.com/你的用户名/spring-lament-blog.git .
```

### 第 3 步：运行部署脚本

```bash
# 赋予执行权限
chmod +x scripts/*.sh

# 运行部署脚本（会自动完成所有配置）
sudo bash scripts/deploy-setup.sh
```

脚本会自动：

- 检查环境（Node.js、npm、PM2）
- 创建环境变量配置文件
- 安装项目依赖
- 生成 Prisma Client
- 初始化数据库
- 创建初始管理员账户
- 构建项目
- 启动应用

---

## 🔐 必要的手动配置

### 1. 数据库创建

**PostgreSQL (推荐):**

```bash
sudo -u postgres psql
CREATE DATABASE spring_lament_blog;
CREATE USER blog_user WITH ENCRYPTED PASSWORD '你的强密码';
GRANT ALL PRIVILEGES ON DATABASE spring_lament_blog TO blog_user;
\q
```

**MySQL:**

```sql
CREATE DATABASE spring_lament_blog;
CREATE USER 'blog_user'@'localhost' IDENTIFIED BY '你的强密码';
GRANT ALL PRIVILEGES ON spring_lament_blog.* TO 'blog_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 环境变量配置

文件：`/www/wwwroot/my-next-app/.env.production`

```env
# 数据库连接（根据你选择的数据库修改）
DATABASE_URL="postgresql://blog_user:你的密码@localhost:5432/spring_lament_blog?schema=public"

# NextAuth 密钥（使用命令生成：openssl rand -base64 32）
NEXTAUTH_SECRET="生成的密钥粘贴在这里"

# 网站 URL
NEXTAUTH_URL="http://powder.icu"

# 环境
NODE_ENV="production"
```

**生成密钥命令：**

```bash
openssl rand -base64 32
```

### 3. Nginx 反向代理配置

在宝塔面板网站设置 → 配置文件，添加：

```nginx
server {
    listen 80;
    server_name powder.icu www.powder.icu;

    # 日志
    access_log /www/wwwlogs/powder.icu.log;
    error_log /www/wwwlogs/powder.icu.error.log;

    # 上传限制
    client_max_body_size 50M;

    # Next.js 静态文件
    location /_next/static {
        alias /www/wwwroot/my-next-app/.next/static;
        expires 365d;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    # 公共文件
    location /public {
        alias /www/wwwroot/my-next-app/public;
        expires 30d;
        access_log off;
    }

    # 反向代理到 Next.js
    location / {
        proxy_pass http://localhost:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
    }
}
```

---

## 🤖 GitHub Actions 自动部署配置

### 理解关键的 3 个环境变量

在配置 GitHub Secrets 之前，先了解这三个关键变量的来源：

#### 1. `DATABASE_URL` - 数据库连接字符串

**这不是从哪里获取的，而是你自己创建数据库时配置的！**

根据数据库类型，格式不同：

**PostgreSQL (推荐):**

```env
DATABASE_URL="postgresql://blog_user:你设置的密码@localhost:5432/spring_lament_blog?schema=public"
```

**MySQL:**

```env
DATABASE_URL="mysql://blog_user:你设置的密码@localhost:3306/spring_lament_blog"
```

**创建数据库示例：**

```bash
# PostgreSQL
sudo -u postgres psql
CREATE DATABASE spring_lament_blog;
CREATE USER blog_user WITH ENCRYPTED PASSWORD 'MyStr0ngP@ssw0rd';
GRANT ALL PRIVILEGES ON DATABASE spring_lament_blog TO blog_user;
\q

# 然后 DATABASE_URL 就是：
# postgresql://blog_user:MyStr0ngP@ssw0rd@localhost:5432/spring_lament_blog?schema=public
```

#### 2. `NEXTAUTH_SECRET` - 认证密钥

**这是一个随机生成的强密钥，用于加密用户会话。**

**生成命令：**

```bash
openssl rand -base64 32
```

会输出类似这样的字符串：

```
Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX
```

**这就是你的 `NEXTAUTH_SECRET`！** 复制这个字符串。

#### 3. `NEXTAUTH_URL` - 网站地址

**这就是你的网站域名，非常简单：**

```env
# HTTP 版本
NEXTAUTH_URL="http://powder.icu"

# HTTPS 版本（配置 SSL 后）
NEXTAUTH_URL="https://powder.icu"
```

---

### 在 GitHub 仓库添加 Secrets

准备好上面三个值后，进入：`仓库 → Settings → Secrets and variables → Actions`

#### 添加步骤：

1. 点击 **"New repository secret"**
2. 填写 **Name** 和 **Secret**
3. 点击 **"Add secret"**
4. 重复以上步骤，添加所有 7 个 Secrets

#### 需要添加的 7 个 Secrets：

| Secret 名称       | 值                                                                            | 说明             | 如何获取                  |
| ----------------- | ----------------------------------------------------------------------------- | ---------------- | ------------------------- |
| `SERVER_HOST`     | `42.193.227.185`                                                              | 服务器 IP        | 你的服务器 IP 地址        |
| `SERVER_USER`     | `root`                                                                        | SSH 用户名       | 通常是 root               |
| `SERVER_SSH_KEY`  | SSH 私钥内容                                                                  | SSH 私钥（推荐） | 见下面的详细说明          |
| `SERVER_PORT`     | `22`                                                                          | SSH 端口         | 默认 22                   |
| `DATABASE_URL`    | `postgresql://blog_user:密码@localhost:5432/spring_lament_blog?schema=public` | 数据库连接       | 见上面的说明              |
| `NEXTAUTH_SECRET` | `生成的密钥`                                                                  | NextAuth 密钥    | `openssl rand -base64 32` |
| `NEXTAUTH_URL`    | `http://powder.icu`                                                           | 网站 URL         | 你的域名                  |

---

### 如何生成和配置 SSH 密钥

**在服务器上生成密钥：**

```bash
# 1. SSH 登录服务器
ssh root@42.193.227.185

# 2. 生成密钥（提示输入密码时直接回车）
ssh-keygen -t rsa -b 4096 -C "github-actions" -f ~/.ssh/github_actions_rsa

# 3. 添加公钥
cat ~/.ssh/github_actions_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 4. 显示私钥（复制全部内容）
cat ~/.ssh/github_actions_rsa
```

**添加到 GitHub：**

1. GitHub 仓库 → Settings → Secrets and variables → Actions
2. New repository secret
3. Name: `SERVER_SSH_KEY`
4. Secret: 粘贴私钥（包括 BEGIN 和 END 行）
5. Add secret

完成！

#### 完整示例：

假设你创建的数据库密码是 `MyStr0ngP@ssw0rd`，那么：

```bash
# 1. 先生成 NEXTAUTH_SECRET
$ openssl rand -base64 32
Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX

# 2. 然后在 GitHub 添加这些 Secrets：
DATABASE_URL = postgresql://blog_user:MyStr0ngP@ssw0rd@localhost:5432/spring_lament_blog?schema=public
NEXTAUTH_SECRET = Xk7pQ9vR2mN5hJ8fD3sA6wE1yT4uI0oP2lK9nM7bV6cX
NEXTAUTH_URL = http://powder.icu
```

### 触发自动部署

```bash
git add .
git commit -m "配置部署"
git push origin main
```

每次推送到 `main` 分支，GitHub Actions 会自动部署到服务器！

---

## ✅ 验证部署

### 1. 检查应用状态

```bash
pm2 status
```

应该显示：

```
┌─────┬──────────────────────┬─────────┬─────────┐
│ id  │ name                 │ status  │ restart │
├─────┼──────────────────────┼─────────┼─────────┤
│ 0   │ spring-lament-blog   │ online  │ 0       │
└─────┴──────────────────────┴─────────┴─────────┘
```

### 2. 查看日志

```bash
pm2 logs spring-lament-blog --lines 50
```

### 3. 测试访问

```bash
# 本地测试
curl http://localhost:80

# 域名测试
curl http://powder.icu
```

### 4. 浏览器访问

- 首页: http://powder.icu
- 管理后台: http://powder.icu/admin
- 默认账号: `admin` / `admin123`
- ⚠️ 登录后立即修改密码！

---

## 🛠️ 常用管理命令

### PM2 管理

```bash
pm2 status                      # 查看状态
pm2 logs spring-lament-blog     # 查看日志
pm2 restart spring-lament-blog  # 重启应用
pm2 stop spring-lament-blog     # 停止应用
pm2 monit                       # 监控资源使用
```

### 更新部署

```bash
# 方法 1: 使用脚本（推荐）
cd /www/wwwroot/my-next-app
bash scripts/update-deploy.sh

# 方法 2: 手动更新
git pull
npm ci --production
npm run build
pm2 restart spring-lament-blog

# 方法 3: GitHub Actions 自动部署
git push origin main  # 推送代码自动触发
```

### 数据库管理

```bash
npm run db:generate  # 生成 Prisma Client
npm run db:push      # 同步数据库结构
npm run db:seed      # 创建初始数据
npm run db:studio    # 打开数据库管理界面
```

### 状态检查

```bash
cd /www/wwwroot/my-next-app
bash scripts/check-status.sh
```

---

## 🐛 常见问题快速解决

### 问题 1: 502 Bad Gateway

```bash
# 检查应用
pm2 status
pm2 logs spring-lament-blog

# 如果未运行
pm2 start ecosystem.config.js
```

### 问题 2: 数据库连接失败

```bash
# 检查环境变量
cat /www/wwwroot/my-next-app/.env.production

# 测试数据库连接
npm run db:push
```

### 问题 3: 端口 80 被占用

```bash
# 查看占用进程
lsof -i :80

# 结束进程
kill -9 [PID]
```

### 问题 4: 权限问题

```bash
# 修改目录权限
chown -R www:www /www/wwwroot/my-next-app
chmod -R 755 /www/wwwroot/my-next-app
chmod 600 /www/wwwroot/my-next-app/.env.production
```

---

## 📚 详细文档索引

### 主要文档（按优先级）

1. **[DEPLOYMENT-README.md](DEPLOYMENT-README.md)** ⭐
   - 配置总结和快速参考
2. **[docs/COMPLETE-DEPLOYMENT-GUIDE.md](docs/COMPLETE-DEPLOYMENT-GUIDE.md)** ⭐⭐⭐
   - 完整的部署指南
   - 包含所有细节和故障排查
   - 推荐详细阅读

3. **[docs/QUICK-START-DEPLOY.md](docs/QUICK-START-DEPLOY.md)**
   - 快速开始指南
   - 适合快速部署

4. **[docs/ENVIRONMENT-SETUP.md](docs/ENVIRONMENT-SETUP.md)**
   - 环境变量详细配置
   - 数据库连接字符串格式

5. **[docs/BAOTA-DEPLOYMENT.md](docs/BAOTA-DEPLOYMENT.md)**
   - 宝塔面板部署详解

6. **[scripts/README.md](scripts/README.md)**
   - 部署脚本使用说明

### 配置文件

- `.github/workflows/deploy.yml` - GitHub Actions 配置
- `ecosystem.config.js` - PM2 配置
- `package.json` - 项目依赖和脚本
- `next.config.js` - Next.js 配置
- `prisma/schema.prisma` - 数据库模型

---

## ⚠️ 重要提醒

### 安全性

1. **立即修改默认密码**
   - 登录后台: http://powder.icu/admin
   - 默认账号: `admin` / `admin123`
   - 进入个人资料修改密码

2. **配置 SSL 证书**（强烈推荐）
   - 在宝塔面板网站设置 → SSL
   - 申请 Let's Encrypt 免费证书
   - 启用强制 HTTPS
   - 修改 `.env.production` 中的 `NEXTAUTH_URL` 为 `https://powder.icu`

3. **保护敏感文件**

   ```bash
   chmod 600 /www/wwwroot/my-next-app/.env.production
   ```

4. **定期备份**
   - 在宝塔面板配置数据库自动备份
   - 备份上传的文件和图片

### 端口 80 权限

端口 80 需要 root 权限：

```bash
# 确保以 root 运行 PM2
sudo pm2 start ecosystem.config.js

# 或使用 authbind（Linux）
# 或配置 Nginx 代理到其他端口（如 3000）
```

### 生产环境数据库

❌ **不要使用 SQLite** - 并发性能差，不适合生产环境  
✅ **推荐 PostgreSQL** - 性能好，功能完整  
✅ **备选 MySQL** - 性能良好，兼容性好

---

## ✅ 最终检查清单

### 部署前

- [ ] 服务器已安装 Node.js 20.x
- [ ] 服务器已安装 PM2
- [ ] 服务器已安装 Nginx
- [ ] 数据库已创建
- [ ] 域名已解析
- [ ] 宝塔面板已配置

### 部署中

- [ ] 代码已克隆到服务器
- [ ] `.env.production` 已配置
- [ ] NextAuth 密钥已生成
- [ ] 数据库连接正确
- [ ] Nginx 反向代理已配置
- [ ] 应用已构建
- [ ] PM2 已启动应用

### 部署后

- [ ] PM2 状态为 online
- [ ] 可以访问首页
- [ ] 可以登录后台
- [ ] 已修改默认密码
- [ ] GitHub Secrets 已配置
- [ ] SSL 证书已配置（推荐）
- [ ] 数据库备份已设置

---

## 🎉 部署完成！

### 访问地址

- 🌐 **首页**: http://powder.icu
- 🔐 **管理后台**: http://powder.icu/admin
- 👤 **默认账号**: `admin` / `admin123`

### 下一步

1. ✅ 登录后台修改密码
2. ✅ 配置 SSL 证书
3. ✅ 设置数据库备份
4. ✅ 测试 GitHub Actions 自动部署
5. ✅ 开始写博客！

### 需要帮助？

- 📖 查看 [完整部署指南](docs/COMPLETE-DEPLOYMENT-GUIDE.md)
- 🔍 运行状态检查: `bash scripts/check-status.sh`
- 📝 查看日志: `pm2 logs spring-lament-blog`

---

**祝你部署顺利！** 🚀✨

所有配置已完成，构建测试通过，现在可以放心部署了！
